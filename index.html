<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Apple Music</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>

  <style>
    :root {
      --system-red: #ff3b30;
      --system-pink: #ff2d55;
      --system-gray: #8e8e93;
      --system-gray-2: #aeaeb2;
      --system-gray-6: #1c1c1e;
      --fill-tertiary: rgba(118, 118, 128, 0.24);
      --border-color: rgba(255, 255, 255, 0.15);
      --safe-area-top: env(safe-area-inset-top, 20px);
      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; width: 100%; overflow: hidden; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
      background: #000; color: #fff; display: flex; flex-direction: column; -webkit-font-smoothing: antialiased;
    }
    .app-container { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }

    .view {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column;
      opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; background: #000; z-index: 10;
    }
    .view.active { opacity: 1; visibility: visible; z-index: 20; }
    #player-view.active ~ .now-playing-bar { transform: translateY(200%); }

    .header { padding: var(--safe-area-top) 20px 10px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
    .header.large-title h1 { font-size: 34px; font-weight: 700; }
    .header-profile-icon {
        width: 32px; height: 32px; background: var(--fill-tertiary); color: var(--system-pink);
        border-radius: 50%; font-size: 16px; display: flex; align-items: center; justify-content: center;
    }
    .header-with-back { padding: var(--safe-area-top) 10px 10px; }
    .header-with-back .back-btn {
        font-size: 17px; color: var(--system-pink); background: none; border: none; cursor: pointer;
        display: flex; align-items: center; gap: 4px; padding: 8px;
    }
    .header-with-back h1 { font-size: 17px; font-weight: 600; flex: 1; text-align: center; margin: 0 10px; }
    .header-actions { display: flex; gap: 15px; min-width: 40px; justify-content: flex-end; align-items: center; }
    .header-actions .icon-btn, .round-btn { background: none; border: none; color: var(--system-pink); font-size: 22px; cursor: pointer; }
    .round-btn {
        background: var(--fill-tertiary); width: 36px; height: 36px; border-radius: 50%;
        font-size: 14px; display: flex; align-items: center; justify-content: center; color: #fff;
    }

    .main-content { flex: 1; overflow-y: auto; scrollbar-width: none; padding-bottom: 130px; }
    .main-content::-webkit-scrollbar { display: none; }
    .search-bar { padding: 10px 20px; position: relative; }
    .search-input {
      width: 100%; padding: 8px 40px 8px 35px; background-color: var(--fill-tertiary); border: none;
      border-radius: 10px; color: #fff; font-size: 17px;
      background-image: url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%238e8e93' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: 10px center;
    }
    .search-input-mic { position: absolute; right: 30px; top: 50%; transform: translateY(-50%); color: var(--system-gray); font-size: 16px; }
    .section-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 20px 15px; }
    .section-header h2 { font-size: 22px; font-weight: 700; }
    .action-buttons { display: flex; gap: 10px; padding: 10px 20px; }
    .action-btn { flex: 1; background: var(--fill-tertiary); border: none; border-radius: 8px; color: #fff; padding: 12px; font-size: 16px; font-weight: 600; cursor: pointer; }
    .action-btn i { margin-right: 8px; }

    .list-item { display: flex; align-items: center; padding: 11px 20px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
    .list-item:first-child { border-top: 1px solid var(--border-color); }
    .list-icon { color: var(--system-pink); width: 30px; font-size: 22px; margin-right: 15px; text-align: center; }
    .list-text { flex: 1; font-size: 17px; }
    .list-arrow { color: var(--system-gray); font-size: 14px; }
    
    .list-item-swipe-container { position: relative; overflow: hidden; }
    .list-item-swipe-content { display: flex; align-items: center; background: #000; transition: transform 0.3s ease; will-change: transform; }
    .list-item-actions { position: absolute; top: 0; right: 0; height: 100%; display: flex; }
    .list-action-btn { height: 100%; padding: 0 25px; color: #fff; border: none; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; }
    .action-delete { background: var(--system-red); }
    .action-edit { background: var(--system-gray-2); }
    .song-list-artwork { width: 44px; height: 44px; border-radius: 4px; object-fit: cover; margin-right: 12px; background: var(--system-gray-6);}
    .song-list-info { flex: 1; display: flex; flex-direction: column; }
    .song-list-info-container { flex: 1; display: flex; align-items: center; border-bottom: 1px solid var(--border-color); padding: 8px 0; margin-left: 20px; padding-right: 20px; }
    .list-item-swipe-container:last-of-type .song-list-info-container { border-bottom: none; }
    .song-list-title { font-size: 17px; display: flex; align-items: center; }
    .song-list-artist { font-size: 14px; color: var(--system-gray); }
    .song-menu-btn { color: var(--system-gray); font-size: 16px; padding: 10px; }

    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 0 20px; }
    .grid-item { cursor: pointer; }
    .grid-item img { width: 100%; aspect-ratio: 1/1; border-radius: 6px; object-fit: cover; margin-bottom: 5px; background: #1c1c1e; }
    .grid-item-title { font-size: 14px; line-height: 1.2; font-weight: 400; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .grid-item-subtitle { font-size: 14px; color: var(--system-gray); }
    
    .playlist-item { display: flex; align-items: center; padding: 8px 0; cursor: pointer; width: 100%; }
    .playlist-item-artwork {
        width: 54px; height: 54px; border-radius: 4px; margin-right: 15px;
        display: flex; align-items: center; justify-content: center;
        background-color: #1c1c1e; background-size: cover; background-position: center;
    }
    #favorite-playlist-artwork { background-image: linear-gradient(135deg, #ff2d55, #ff5e3a); }
    #favorite-playlist-artwork .fa-star { font-size: 28px; }
    .playlist-info { flex: 1; }
    .playlist-title { font-size: 17px; }
    .playlist-subtitle { font-size: 14px; color: var(--system-gray); }

    .search-category-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 10px 20px; }
    .category-item { position: relative; cursor: pointer; }
    .category-item img { width: 100%; display: block; border-radius: 8px; aspect-ratio: 1.5 / 1; object-fit: cover; }
    .category-item::before { content: ''; position: absolute; inset: 0; border-radius: 8px; mix-blend-mode: screen; }
    .category-item[data-color="red"]::before { background-color: #ff3b30; }
    .category-item .category-title { position: absolute; bottom: 12px; left: 12px; font-size: 16px; font-weight: 600; color: #fff; }

    .tab-bar {
      position: fixed; bottom: 0; left: 0; right: 0; background: rgba(28, 28, 30, 0.95);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); display: flex;
      padding-top: 8px; padding-bottom: var(--safe-area-bottom); border-top: 0.5px solid rgba(255, 255, 255, 0.2); z-index: 500;
    }
    .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; cursor: pointer; color: var(--system-gray); }
    .tab-item.active { color: var(--system-pink); }
    .tab-icon { font-size: 22px; margin-bottom: 2px; }
    .tab-label { font-size: 10px; font-weight: 500; }

    .now-playing-bar {
      position: fixed; bottom: calc(50px + var(--safe-area-bottom)); left: 10px; right: 10px;
      background: #2c2c2e; padding: 8px; border-radius: 12px; display: none; align-items: center;
      cursor: pointer; z-index: 600; transform: translateY(200%); transition: transform 0.4s ease-in-out;
    }
    .now-playing-bar.active { display: flex; transform: translateY(0); }
    .now-playing-artwork { width: 44px; height: 44px; border-radius: 4px; object-fit: cover; margin-right: 12px; background: #1c1c1e; }
    .now-playing-info { flex: 1; font-size: 15px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .now-playing-controls { display: flex; align-items: center; gap: 20px; margin-right: 5px; }
    .now-playing-btn { background: none; border: none; color: #fff; font-size: 22px; cursor: pointer; }

    /* Player View Overhaul */
    #player-view .main-content {
      display: flex; flex-direction: column; justify-content: space-between;
      padding: 0 30px; flex-grow: 1;
    }
    .player-artwork-container {
      flex-grow: 1; display: flex; align-items: center; justify-content: center; padding: 10px 0;
    }
    .player-artwork {
        width: 100%; aspect-ratio: 1/1; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); background: #1c1c1e;
    }
    .player-info-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .player-details .title { font-size: 22px; font-weight: 700; }
    .player-details .artist { font-size: 22px; color: var(--system-gray-2); }
    .favorite-btn { font-size: 24px; color: #fff; background: none; border: none; cursor: pointer; }
    .favorite-btn.favorited { color: var(--system-pink); }
    .favorite-btn i { font-size: 16px; }
    .progress-container { margin-bottom: 10px; }
    .progress-bar { width: 100%; height: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; cursor: pointer; position: relative; }
    .progress-fill { height: 100%; background: #fff; border-radius: 4px; width: 0%; }
    .progress-times { display: flex; justify-content: space-between; font-size: 12px; color: var(--system-gray); margin-top: 8px; }
    .player-controls { display: flex; align-items: center; justify-content: space-between; margin: 15px 0; }
    .control-btn { background: none; border: none; color: #fff; cursor: pointer; font-size: 28px; }
    .control-btn.main { font-size: 50px; }
    .volume-container { display: flex; align-items: center; gap: 15px; margin-top: 15px; }
    .volume-container i { color: var(--system-gray); }
    .volume-slider { flex: 1; height: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; cursor: pointer; }
    .player-extra-controls { display: flex; justify-content: space-around; align-items: center; margin: 15px 0 20px; }
    .player-extra-controls .control-btn { font-size: 20px; color: var(--system-gray); }
    .song-list-title.explicit::after,
    .player-details .title.explicit::after {
        content: 'E'; font-size: 11px; font-weight: 600; background: rgba(255,255,255,0.3);
        color: #fff; padding: 1px 4px; border-radius: 3px; margin-left: 8px; vertical-align: middle;
    }

    /* Modal Views */
    .modal-view {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1100;
      display: flex; flex-direction: column;
    }
    .modal-form-container { padding: 20px; display: flex; flex-direction: column; gap: 20px; }
    .modal-artwork-section { text-align: center; }
    .modal-artwork-preview { width: 150px; height: 150px; background: #333; border-radius: 8px; margin: 0 auto 15px; object-fit: cover; cursor: pointer; }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { color: var(--system-gray); font-size: 14px; margin-bottom: 8px; text-transform: uppercase; }
    .form-group input, .form-group button { background: var(--fill-tertiary); border: none; border-radius: 8px; padding: 12px; font-size: 17px; color: #fff; }
    .form-group button { background: var(--system-pink); cursor: pointer; font-weight: 600; }
    .form-group .secondary-btn { background: var(--fill-tertiary); }
    .select-playlist-modal .list-item { padding-left: 0; }
    
    .hidden { display: none; }
    .loading-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999;
        display: none; align-items: center; justify-content: center;
    }
    .loading-overlay.active { display: flex; }
    .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .empty-state { text-align: center; color: var(--system-gray); padding: 50px 20px; }
  </style>
</head>
<body>

  <div class="app-container">
    <!-- Main Views -->
    <div id="library-view" class="view">
        <div class="header large-title"><h1>Library</h1><div class="header-actions"><button class="round-btn" data-action="openUploadModal"><i class="fas fa-plus"></i></button><div class="header-profile-icon"><i class="fas fa-user"></i></div></div></div>
        <div class="main-content" id="library-content"></div>
    </div>
    <div id="sub-view" class="view">
        <div class="header header-with-back">
            <button class="back-btn" data-action="goBack"><i class="fas fa-chevron-left"></i> <span id="back-btn-text"></span></button>
            <h1 id="sub-view-title"></h1>
            <div class="header-actions" id="sub-view-actions"></div>
        </div>
        <div class="main-content" id="sub-view-content"></div>
    </div>
    <div id="search-view" class="view">
      <div class="header large-title"><h1>Search</h1><div class="header-profile-icon"><i class="fas fa-user"></i></div></div>
      <div class="main-content">
        <div class="search-bar"><input type="text" class="search-input" id="search-input" placeholder="Artists, Songs, and Albums"><i class="fas fa-microphone search-input-mic"></i></div>
        <div id="search-results-container" class="hidden"></div>
        <div id="search-categories">
            <div class="section-header"><h2>Browse Categories</h2></div>
            <div class="search-category-grid">
                <div class="category-item" data-color="red"><img src="https://images.unsplash.com/photo-1516450360452-9312f5e86fc7?w=400&auto=format&fit=crop" alt=""><span class="category-title">Set Lists</span></div>
                <div class="category-item" data-color="red"><img src="https://images.unsplash.com/photo-1525362083236-02439a1d1478?w=400&auto=format&fit=crop" alt=""><span class="category-title">Alternative</span></div>
            </div>
        </div>
      </div>
    </div>
    
    <!-- Modal Views -->
    <div id="upload-view" class="modal-view view">
        <div class="header header-with-back">
            <button class="back-btn" data-action="closeUploadModal">Cancel</button>
            <h1 style="text-align: center;">Add Music</h1>
            <div class="header-actions" style="min-width: 60px;"><button class="back-btn" data-action="submitUpload">Done</button></div>
        </div>
        <div class="main-content">
            <form class="modal-form-container" id="upload-form">
                <div class="modal-artwork-section"><img id="upload-artwork-preview" class="modal-artwork-preview" src="https://via.placeholder.com/150?text=Artwork" data-action="triggerArtworkUpload" alt="Artwork Preview"><input type="file" id="artwork-input" class="hidden" accept="image/*"></div>
                <div class="form-group"><label for="song-title-input">TITLE</label><input type="text" id="song-title-input" required></div>
                <div class="form-group"><label for="song-artist-input">ARTIST</label><input type="text" id="song-artist-input" required></div>
                <div class="form-group"><label for="song-album-input">ALBUM</label><input type="text" id="song-album-input" required></div>
                <div class="form-group"><button type="button" class="secondary-btn" data-action="triggerSongUpload">Select Song File</button><span id="song-file-name" style="color: var(--system-gray); font-size: 14px; margin-top: 8px; text-align: center;">No file selected.</span><input type="file" id="music-file-input" class="hidden" accept=".mp3"></div>
                <div class="form-group"><button type="button" class="secondary-btn" data-action="openPlaylistSelector">Add to Playlist (Optional)</button><span id="selected-playlist-name" style="color: var(--system-gray); font-size: 14px; margin-top: 8px; text-align: center;">No playlist selected.</span></div>
            </form>
        </div>
    </div>
    <div id="playlist-selector-view" class="modal-view view select-playlist-modal">
        <div class="header header-with-back">
            <button class="back-btn" data-action="closePlaylistSelector">Back</button>
            <h1 style="text-align: center;">Select Playlist</h1>
            <div class="header-actions" style="min-width: 60px;"></div>
        </div>
        <div class="main-content" id="playlist-selector-list"></div>
    </div>
    <div id="create-playlist-view" class="modal-view view">
        <div class="header header-with-back">
            <button class="back-btn" data-action="closeCreatePlaylistModal">Cancel</button>
            <h1 style="text-align: center;">New Playlist</h1>
            <div class="header-actions" style="min-width: 60px;"><button class="back-btn" data-action="submitCreatePlaylist">Done</button></div>
        </div>
        <div class="main-content">
            <form class="modal-form-container" id="create-playlist-form">
                <div class="modal-artwork-section"><img id="playlist-artwork-preview" class="modal-artwork-preview" src="https://via.placeholder.com/150?text=Artwork" data-action="triggerPlaylistArtworkUpload" alt="Playlist Artwork Preview"><input type="file" id="playlist-artwork-input" class="hidden" accept="image/*"></div>
                <div class="form-group"><label for="playlist-name-input">PLAYLIST NAME</label><input type="text" id="playlist-name-input" required></div>
            </form>
        </div>
    </div>
    
    <!-- Player View (Redesigned) -->
    <div id="player-view" class="view">
        <div class="header header-with-back" style="background: transparent; border: none;">
            <button class="back-btn" data-action="hideFullPlayer"><i class="fas fa-chevron-down"></i></button>
            <h1 class="player-header-title"></h1>
            <button class="icon-btn" data-action="showMoreOptions"><i class="fas fa-ellipsis-h"></i></button>
        </div>
        <div class="main-content">
            <div class="player-artwork-container">
                <img id="player-artwork" class="player-artwork" src="" alt="">
            </div>
            <div>
                <div class="player-info-container">
                    <div class="player-details"><div id="player-title" class="title">Not Playing</div><div id="player-artist" class="artist"></div></div>
                    <button class="round-btn favorite-btn" data-action="toggleFavorite"><i class="far fa-star"></i></button>
                </div>
                <div class="progress-container" data-action="seek"><div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div><div class="progress-times"><span id="current-time">0:00</span><span id="total-time">0:00</span></div></div>
                <div class="player-controls">
                  <button class="control-btn" data-action="prevSong"><i class="fas fa-backward-step"></i></button>
                  <button class="control-btn main" data-action="togglePlay"><i id="main-play-icon" class="fas fa-play-circle"></i></button>
                  <button class="control-btn" data-action="nextSong"><i class="fas fa-forward-step"></i></button></div>
                <div class="volume-container">
                  <i class="fas fa-volume-down"></i><div class="volume-slider" data-action="setVolume"><div class="progress-fill" id="volume-fill" style="width: 50%;"></div></div><i class="fas fa-volume-up"></i></div>
                <div class="player-extra-controls">
                  <button class="control-btn"><i class="fas fa-comment-dots"></i></button>
                  <button class="control-btn"><i class="fas fa-podcast"></i></button>
                  <button class="control-btn"><i class="fas fa-list-ul"></i></button>
                </div>
            </div>
        </div>
    </div>
  </div>

  <div class="now-playing-bar" id="now-playing-bar" data-action="showFullPlayer">
    <img id="np-artwork" class="now-playing-artwork" src="" alt=""><div id="np-title" class="now-playing-info">Not Playing</div>
    <div class="now-playing-controls">
      <button class="now-playing-btn" data-action="togglePlay"><i id="np-play-icon" class="fas fa-play"></i></button>
      <button class="now-playing-btn" data-action="nextSong"><i class="fas fa-forward-step"></i></button>
    </div>
  </div>

  <div class="tab-bar">
    <div class="tab-item active" data-action="showView" data-view="library"><i class="fas fa-rectangle-stack tab-icon"></i><span class="tab-label">Library</span></div>
    <div class="tab-item" data-action="showView" data-view="search"><i class="fas fa-magnifying-glass tab-icon"></i><span class="tab-label">Search</span></div>
  </div>
  
  <audio id="audio" preload="metadata"></audio>
  <div class="loading-overlay" id="loading-overlay"><div class="spinner"></div></div>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {

    const app = {
        db: null,
        nowPlaying: { id: null, queue: [], currentIndex: -1, isPlaying: false },
        library: { songs: [], playlists: [], artists: {}, albums: {} },
        uploadData: { songFile: null, artworkBase64: null, editingId: null, selectedPlaylistId: null },
        playlistData: { artworkBase64: null },
    };

    const DOM = {
        views: document.querySelectorAll('.view'),
        audio: document.getElementById('audio'),
        loadingOverlay: document.getElementById('loading-overlay'),
    };

    function init() {
        DB.init().then(() => {
            Library.loadAllData().then(() => {
                UI.renderAll();
                handlePopState(); 
            });
        });
        setupEventListeners();
    }

    function setupEventListeners() {
        document.body.addEventListener('click', handleAction);
        window.addEventListener('popstate', handlePopState);
        DOM.audio.addEventListener('timeupdate', Player.updateProgress);
        DOM.audio.addEventListener('loadedmetadata', Player.updateProgress);
        DOM.audio.addEventListener('ended', Player.nextSong);
        
        document.getElementById('artwork-input').addEventListener('change', e => Upload.handleArtworkFileSelect(e));
        document.getElementById('music-file-input').addEventListener('change', e => Upload.handleSongFileSelect(e));
        document.getElementById('playlist-artwork-input').addEventListener('change', e => Playlist.handleArtworkFileSelect(e));
        document.getElementById('search-input').addEventListener('input', e => UI.handleSearch(e));
        document.getElementById('sub-view-content').addEventListener('input', e => {
            if (e.target.classList.contains('search-input')) UI.handleSubViewSearch(e);
        });
        document.getElementById('sub-view-content').addEventListener('touchstart', e => SwipeList.handleTouchStart(e), { passive: true });
        document.getElementById('sub-view-content').addEventListener('touchmove', e => SwipeList.handleTouchMove(e), { passive: false });
        document.getElementById('sub-view-content').addEventListener('touchend', e => SwipeList.handleTouchEnd(e));
    }
    
    function handleAction(e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        const action = target.dataset.action;
        if (action) e.stopPropagation();

        const actions = {
            'showView': () => UI.showView(`${target.dataset.view}-view`),
            'goBack': UI.goBack,
            'openUploadModal': Upload.openModal,
            'closeUploadModal': Upload.closeModal,
            'openCreatePlaylistModal': Playlist.openModal,
            'closeCreatePlaylistModal': Playlist.closeModal,
            'openPlaylistSelector': Upload.openPlaylistSelector,
            'closePlaylistSelector': Upload.closePlaylistSelector,
            'selectPlaylist': () => Upload.selectPlaylist(parseInt(target.dataset.id)),
            'triggerArtworkUpload': () => document.getElementById('artwork-input').click(),
            'triggerSongUpload': () => document.getElementById('music-file-input').click(),
            'triggerPlaylistArtworkUpload': () => document.getElementById('playlist-artwork-input').click(),
            'submitUpload': Upload.submit,
            'submitCreatePlaylist': Playlist.submit,
            'showSubView': () => UI.showSubView(target.dataset.type, target.dataset.id),
            'playSong': () => Player.playSong(parseInt(target.dataset.id)),
            'playAlbum': () => Player.playAlbum(target.dataset.album),
            'playPlaylist': () => Player.playPlaylist(target.dataset.id),
            'shuffle': () => Player.shuffle(target.dataset.type, target.dataset.id),
            'togglePlay': Player.togglePlay,
            'nextSong': Player.nextSong,
            'prevSong': Player.prevSong,
            'showFullPlayer': UI.showFullPlayer,
            'hideFullPlayer': UI.hideFullPlayer,
            'seek': Player.seek,
            'setVolume': Player.setVolume,
            'toggleFavorite': Player.toggleFavorite,
            'editSong': () => Upload.editSong(parseInt(target.dataset.id)),
            'deleteSong': () => Library.deleteSong(parseInt(target.dataset.id)),
            'renamePlaylist': () => Playlist.rename(parseInt(target.dataset.id)),
            'deletePlaylist': () => Playlist.delete(parseInt(target.dataset.id)),
        };
        
        if (actions[action]) actions[action](e);
    }
    
    function handlePopState() {
        const hash = window.location.hash.slice(1);
        const [path, id] = hash.split('/');

        switch (path) {
            case 'search': UI.showView('search-view', true); break;
            case 'playlists':
            case 'artists':
            case 'albums':
            case 'songs':
                UI.showSubView(path, undefined, true);
                break;
            case 'playlistDetail':
            case 'albumDetail':
                UI.showSubView(path, id, true);
                break;
            case 'player':
                if (app.nowPlaying.id) UI.showView('player-view', true);
                else window.location.hash = 'library';
                break;
            case 'library':
            case '':
            default:
                UI.showView('library-view', true);
                break;
        }
    }
      
    const DB = {
        init: () => new Promise(resolve => {
            const request = indexedDB.open("AppleMusicDB_v17_Final", 1);
            request.onupgradeneeded = e => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains("songs")) db.createObjectStore("songs", { keyPath: "id", autoIncrement: true });
                if (!db.objectStoreNames.contains("playlists")) db.createObjectStore("playlists", { keyPath: "id", autoIncrement: true });
            };
            request.onsuccess = e => { app.db = e.target.result; resolve(); };
        }),
        add: (store, item) => new Promise((res, rej) => { const r = app.db.transaction(store, 'readwrite').objectStore(store).add(item); r.onsuccess = e => res(e.target.result); r.onerror = rej; }),
        put: (store, item) => new Promise(res => app.db.transaction(store, 'readwrite').objectStore(store).put(item).onsuccess = res),
        delete: (store, id) => new Promise(res => app.db.transaction(store, 'readwrite').objectStore(store).delete(id).onsuccess = res),
        get: (store, id) => new Promise(res => app.db.transaction(store).objectStore(store).get(id).onsuccess = e => res(e.target.result)),
        getAll: store => new Promise(res => app.db.transaction(store).objectStore(store).getAll().onsuccess = e => res(e.target.result)),
    };
      
    const Library = {
        async loadAllData() {
            [app.library.songs, app.library.playlists] = await Promise.all([DB.getAll("songs"), DB.getAll("playlists")]);
            this.processLibrary();
        },
        processLibrary() {
            app.library.artists = {}; app.library.albums = {};
            app.library.songs.forEach(song => {
                const artist = song.artist || "Unknown Artist", album = song.album || "Unknown Album";
                if (!app.library.artists[artist]) app.library.artists[artist] = [];
                app.library.artists[artist].push(song);
                if (!app.library.albums[album]) app.library.albums[album] = { songs: [], artwork: song.artwork, artist: artist };
                app.library.albums[album].songs.push(song);
            });
        },
        async deleteSong(id) {
            if (!confirm("Are you sure you want to delete this song?")) return;
            await DB.delete('songs', id);
            await this.loadAllData();
            const currentHash = window.location.hash.slice(1);
            const [path, pathId] = currentHash.split('/');
            UI.renderSubView(path, pathId);
            UI.renderAll();
        }
    };
    
    const Upload = {
        openModal: () => { Upload.resetForm(); UI.showModal('upload-view'); },
        closeModal: () => UI.hideModal('upload-view'),
        resetForm() {
            document.getElementById('upload-form').reset();
            document.getElementById('upload-artwork-preview').src = 'https://via.placeholder.com/150?text=Artwork';
            document.getElementById('song-file-name').textContent = 'No file selected.';
            document.getElementById('selected-playlist-name').textContent = 'No playlist selected.';
            app.uploadData = { songFile: null, artworkBase64: null, editingId: null, selectedPlaylistId: null };
            document.querySelector('#upload-view h1').textContent = "Add Music";
            document.querySelector('#upload-view [data-action="submitUpload"]').textContent = "Done";
        },
        editSong(id){const t=app.library.songs.find(t=>t.id===id);t&&(this.openModal(),app.uploadData.editingId=id,app.uploadData.artworkBase64=t.artwork,document.querySelector("#upload-view h1").textContent="Rename Song",document.querySelector('#upload-view [data-action="submitUpload"]').textContent="Save",document.getElementById("upload-artwork-preview").src=t.artwork,document.getElementById("song-title-input").value=t.title,document.getElementById("song-artist-input").value=t.artist,document.getElementById("song-album-input").value=t.album,document.getElementById("song-file-name").textContent=t.file.name||"Original file")},
        handleSongFileSelect(e){app.uploadData.songFile=e.target.files[0],app.uploadData.songFile&&(document.getElementById("song-file-name").textContent=app.uploadData.songFile.name,jsmediatags.read(app.uploadData.songFile,{onSuccess:({tags})=>{tags.title&&!document.getElementById("song-title-input").value&&(document.getElementById("song-title-input").value=tags.title),tags.artist&&!document.getElementById("song-artist-input").value&&(document.getElementById("song-artist-input").value=tags.artist),tags.album&&!document.getElementById("song-album-input").value&&(document.getElementById("song-album-input").value=tags.album),tags.picture&&!app.uploadData.artworkBase64&&(app.uploadData.artworkBase64=`data:${tags.picture.format};base64,${btoa(String.fromCharCode.apply(null,tags.picture.data))}`,document.getElementById("upload-artwork-preview").src=app.uploadData.artworkBase64)}}))},
        handleArtworkFileSelect(e){const t=e.target.files[0];if(t){const e=new FileReader;e.onload=t=>{app.uploadData.artworkBase64=t.target.result,document.getElementById("upload-artwork-preview").src=app.uploadData.artworkBase64},e.readAsDataURL(t)}},
        async submit(){const e=document.getElementById("song-title-input").value,t=document.getElementById("song-artist-input").value,a=document.getElementById("song-album-input").value;if(!e||!t||!a)return void alert("Please fill all fields.");if(!app.uploadData.editingId&&!app.uploadData.songFile)return void alert("Please select a song file.");UI.showLoading(!0);try{const i=app.uploadData.editingId?app.library.songs.find(e=>e.id===app.uploadData.editingId):{},l={...i,title:e,artist:t,album:a,artwork:app.uploadData.artworkBase64||i.artwork||"https://via.placeholder.com/300?text=No+Art",addedAt:i.addedAt||Date.now(),isFavorite:i.isFavorite||!1};app.uploadData.songFile&&(l.file=app.uploadData.songFile);const n=app.uploadData.editingId?await DB.put("songs",l):await DB.add("songs",l),s=app.uploadData.editingId||n;if(app.uploadData.selectedPlaylistId){const e=await DB.get("playlists",app.uploadData.selectedPlaylistId);e.songs.includes(s)||e.songs.push(s),await DB.put("playlists",e)}await Library.loadAllData(),UI.renderAll(),this.closeModal()}catch(i){console.error("Failed to upload song:",i)}finally{UI.showLoading(!1)}},
        openPlaylistSelector() { UI.renderPlaylistSelector(); UI.showModal('playlist-selector-view'); },
        closePlaylistSelector() { UI.hideModal('playlist-selector-view'); },
        selectPlaylist(id) {
            app.uploadData.selectedPlaylistId = id;
            const playlist = app.library.playlists.find(p => p.id === id);
            document.getElementById('selected-playlist-name').textContent = playlist ? playlist.name : 'No playlist selected.';
            this.closePlaylistSelector();
        }
    };

    const Playlist = {
        openModal: () => { Playlist.resetForm(); UI.showModal('create-playlist-view'); },
        closeModal: () => UI.hideModal('create-playlist-view'),
        resetForm() { 
            document.getElementById("create-playlist-form").reset();
            document.getElementById("playlist-artwork-preview").src="https://via.placeholder.com/150?text=Artwork";
            app.playlistData={artworkBase64:null};
        },
        handleArtworkFileSelect(e) { 
             const t=e.target.files[0];if(t){const e=new FileReader;e.onload=t=>{app.playlistData.artworkBase64=t.target.result,document.getElementById("playlist-artwork-preview").src=app.playlistData.artworkBase64},e.readAsDataURL(t)}
        },
        async submit() {
            const name = document.getElementById("playlist-name-input").value.trim();
            if (!name) return alert("Please enter a playlist name.");
            UI.showLoading(true);
            try {
                await DB.add("playlists", { name, songs: [], artwork: app.playlistData.artworkBase64, createdAt: Date.now() });
                await Library.loadAllData();
                this.closeModal();
                UI.renderSubView('playlists');
            } catch (error) {
                console.error("Failed to create playlist", error);
                alert("An error occurred. Please try again.");
            } finally {
                UI.showLoading(false);
            }
        },
        async rename(id) {
            const playlist = app.library.playlists.find(p => p.id === id);
            if (!playlist) return;
            const newName = prompt("Enter new playlist name:", playlist.name);
            if (newName && newName.trim() !== "") {
                playlist.name = newName.trim();
                await DB.put('playlists', playlist);
                await Library.loadAllData();
                UI.renderSubView('playlists');
                SwipeList.resetAllSwipes();
            }
        },
        async delete(id) {
            const playlist = app.library.playlists.find(p => p.id === id);
            if (!playlist) return;
            if (confirm(`Are you sure you want to delete the playlist "${playlist.name}"?`)) {
                await DB.delete('playlists', id);
                await Library.loadAllData();
                UI.renderSubView('playlists');
            }
        }
    };
    
    const SwipeList = {
        startX: 0, currentX: 0, target: null, isSwiping: false, threshold: -50, maxSwipe: -180,
        handleTouchStart(e) {
            const container = e.target.closest('.list-item-swipe-container');
            if(!container) return;
            this.resetAllSwipes(container);
            this.target = container.querySelector('.list-item-swipe-content');
            this.startX = e.touches[0].clientX;
            this.currentX = this.startX;
            this.isSwiping = true;
            this.target.style.transition = 'transform 0.1s ease-out';
        },
        handleTouchMove(e) {
            if (!this.isSwiping || !this.target) return;
            this.currentX = e.touches[0].clientX;
            let diff = this.currentX - this.startX;
            if (diff > 5) diff = 5;
            if (diff < this.maxSwipe) diff = this.maxSwipe;
            this.target.style.transform = `translateX(${diff}px)`;
        },
        handleTouchEnd() {
            if (!this.isSwiping || !this.target) return;
            let diff = this.currentX - this.startX;
            const actionsWidth = this.target.parentElement.querySelector('.list-item-actions').offsetWidth;
            this.target.style.transition = 'transform 0.3s ease';
            if (diff < this.threshold) {
                this.target.style.transform = `translateX(-${actionsWidth}px)`;
            } else {
                this.target.style.transform = 'translateX(0)';
            }
            this.isSwiping = false;
        },
        resetAllSwipes(exclude = null) {
            document.querySelectorAll('.list-item-swipe-container').forEach(container => {
                if (container !== exclude) {
                    container.querySelector('.list-item-swipe-content').style.transform = 'translateX(0)';
                }
            });
        }
    };

    const Player = {
        playSong(id){const index=app.library.songs.findIndex(s=>s.id===id);if(index!==-1){app.nowPlaying.queue=app.library.songs.map(s=>s.id);this.playFromQueue(index)}},playAlbum(albumName){const album=app.library.albums[albumName];if(album&&album.songs.length>0){app.nowPlaying.queue=album.songs.map(s=>s.id);this.playFromQueue(0)}else{alert("This album is empty.")}},playPlaylist(id){const songs=this.getPlaylistSongs(id);if(songs.length===0)return alert("This playlist is empty.");app.nowPlaying.queue=songs.map(s=>s.id);this.playFromQueue(0)},loadSong(song){app.nowPlaying.id=song.id,DOM.audio.src=URL.createObjectURL(song.file),DOM.audio.play().catch(e=>console.error("Audio play failed:",e)),app.nowPlaying.isPlaying=!0,UI.updatePlayerUI()},togglePlay(){if(!app.nowPlaying.id)return;app.nowPlaying.isPlaying?DOM.audio.pause():DOM.audio.play();app.nowPlaying.isPlaying=!app.nowPlaying.isPlaying;UI.updatePlayIcons()},nextSong(){if(app.nowPlaying.queue.length===0)return;const nextIndex=(app.nowPlaying.currentIndex+1)%app.nowPlaying.queue.length;this.playFromQueue(nextIndex)},prevSong(){if(DOM.audio.currentTime>3||app.nowPlaying.currentIndex===0){DOM.audio.currentTime=0}else{const prevIndex=(app.nowPlaying.currentIndex-1+app.nowPlaying.queue.length)%app.nowPlaying.queue.length;this.playFromQueue(prevIndex)}},playFromQueue(index){if(app.nowPlaying.queue.length===0)return;const songId=app.nowPlaying.queue[index];const song=app.library.songs.find(s=>s.id===songId);if(song){app.nowPlaying.currentIndex=index;this.loadSong(song)}},seek(e){if(!app.nowPlaying.id)return;const rect=e.currentTarget.getBoundingClientRect();DOM.audio.currentTime=DOM.audio.duration*(e.clientX-rect.left)/rect.width},setVolume(e){const rect=e.currentTarget.getBoundingClientRect();DOM.audio.volume=(e.clientX-rect.left)/rect.width;document.getElementById("volume-fill").style.width=`${DOM.audio.volume*100}%`},updateProgress(){if(!DOM.audio.duration)return;const{currentTime,duration}=DOM.audio;document.getElementById("progress-fill").style.width=`${currentTime/duration*100}%`;document.getElementById("current-time").textContent=this.formatTime(currentTime);document.getElementById("total-time").textContent=`-${this.formatTime(duration-currentTime)}`},formatTime:s=>`${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,'0')}`,async toggleFavorite(){if(!app.nowPlaying.id)return;const song=app.library.songs.find(s=>s.id===app.nowPlaying.id);if(song){song.isFavorite=!song.isFavorite;await DB.put("songs",song);UI.updateFavoriteButton(song.isFavorite)}},shuffle(type,id){let songsToShuffle=[];if(type==='songs'){songsToShuffle=[...app.library.songs]}else if(type==='album'){songsToShuffle=app.library.albums[id]?.songs||[]}else if(type==='playlist'){songsToShuffle=this.getPlaylistSongs(id)}if(songsToShuffle.length===0)return alert("Nothing to shuffle.");for(let i=songsToShuffle.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[songsToShuffle[i],songsToShuffle[j]]=[songsToShuffle[j],songsToShuffle[i]]}app.nowPlaying.queue=songsToShuffle.map(s=>s.id);this.playFromQueue(0)},getPlaylistSongs(id){if(id==="favorites")return app.library.songs.filter(s=>s.isFavorite);const playlist=app.library.playlists.find(p=>p.id===parseInt(id));return playlist?app.library.songs.filter(s=>playlist.songs.includes(s.id)):[]}
    };
    
    const UI = {
        showLoading: (show) => DOM.loadingOverlay.classList.toggle('active', show),
        showView(viewId, fromPopState = false) {
            if (!fromPopState) {
                let hash = viewId.replace('-view', '');
                if (viewId === 'player-view') hash = 'player';
                if (window.location.hash !== '#' + hash) {
                    history.pushState({ viewId }, '', '#' + hash);
                }
            }
            DOM.views.forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            const viewName = viewId.replace('-view', '');
            document.querySelectorAll('.tab-item').forEach(t => t.classList.toggle('active', t.dataset.view === viewName));
        },
        showSubView(type, id = null, fromPopState = false) {
            if (!fromPopState) {
                let hash = type;
                if (id) hash += `/${id}`;
                if (window.location.hash !== '#' + hash) {
                    history.pushState({ type, id }, '', '#' + hash);
                }
            }
            this.renderSubView(type, id);
            DOM.views.forEach(v => v.classList.remove('active'));
            document.getElementById('sub-view').classList.add('active');
        },
        showModal: (viewId) => { document.getElementById(viewId).classList.add('active'); },
        hideModal: (viewId) => { document.getElementById(viewId).classList.remove('active'); },
        goBack: () => history.back(),
        showFullPlayer() { if (app.nowPlaying.id) this.showView('player-view'); },
        hideFullPlayer() { this.goBack(); },
        updatePlayerUI(){const e=document.getElementById("now-playing-bar");if(!app.nowPlaying.id)return void e.classList.remove("active");e.classList.add("active"),this.updatePlayIcons();const t=app.library.songs.find(e=>e.id===app.nowPlaying.id);if(t){["np-artwork","player-artwork"].forEach(e=>document.getElementById(e).src=t.artwork);const a=document.getElementById("player-title"),i=document.getElementById("np-title");a.textContent=t.title,i.textContent=t.title,a.classList.toggle("explicit",t.title.includes("[E]")),i.classList.toggle("explicit",t.title.includes("[E]")),document.getElementById("player-artist").textContent=t.artist,this.updateFavoriteButton(t.isFavorite),this.updatePlayerBackground(t.artwork)}},updateFavoriteButton(isFavorite){const favBtn=document.querySelector(".favorite-btn i");if(favBtn){favBtn.className=isFavorite?"fas fa-star":"far fa-star";favBtn.parentElement.classList.toggle("favorited",isFavorite)}},updatePlayIcons(){const isPlaying=app.nowPlaying.isPlaying;document.getElementById("np-play-icon").className=`fas ${isPlaying?"fa-pause":"fa-play"}`,document.getElementById("main-play-icon").className=`fas ${isPlaying?"fa-pause-circle":"fa-play-circle"}`},updatePlayerBackground(src){const img=new Image;img.crossOrigin="Anonymous",img.src=src,img.onload=()=>{const canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");ctx.drawImage(img,0,0,1,1);const[r,g,b]=ctx.getImageData(0,0,1,1).data;document.getElementById("player-view").style.backgroundImage=`linear-gradient(to bottom, rgb(${r},${g},${b}) 0%, #000 70%)`},img.onerror=()=>{document.getElementById("player-view").style.backgroundImage="linear-gradient(to bottom, #222 0%, #000 70%)"}},
        renderAll() { this.renderLibraryView(); },
        renderLibraryView(){const e=document.getElementById("library-content");e.innerHTML=`<div id="library-nav-list"></div><div class="section-header"><h2>Recently Added</h2></div><div class="grid" id="library-recent-grid"></div>`;const t=e.querySelector("#library-nav-list");[{type:"playlists",icon:"fa-list-music",text:"Playlists"},{type:"artists",icon:"fa-microphone-alt",text:"Artists"},{type:"albums",icon:"fa-compact-disc",text:"Albums"},{type:"songs",icon:"fa-music",text:"Songs"}].forEach(e=>t.appendChild(this.createListItem(e)));const a=e.querySelector("#library-recent-grid"),i=[...app.library.songs].sort((e,t)=>t.addedAt-e.addedAt).slice(0,4);a.innerHTML="";const l=e.querySelector(".section-header");i.length>0?(l.classList.remove("hidden"),i.forEach(e=>a.appendChild(this.createGridItem(e,"playSong")))):l.classList.add("hidden")},
        renderSubView(type,id){const titles={playlists:"Playlists",playlistDetail:"Playlist",artists:"Artists",albums:"Albums",albumDetail:"Album",songs:"Songs"},backText={playlistDetail:"Playlists",albumDetail:"Albums",default:"Library"};if(document.querySelector("#sub-view .back-btn span").textContent=backText[type]||backText.default,type==="playlistDetail"){const e=id==="favorites"?"Favorite Songs":app.library.playlists.find(e=>e.id===parseInt(id))?.name;titles.playlistDetail=e}else if(type==="albumDetail")titles.albumDetail=id;document.getElementById("sub-view-title").textContent=titles[type];const actionsContainer=document.getElementById("sub-view-actions");actionsContainer.innerHTML=type==="playlists"?'<button class="icon-btn" data-action="openCreatePlaylistModal"><i class="fas fa-plus"></i></button>':"";const contentContainer=document.getElementById("sub-view-content");contentContainer.dataset.type=type,contentContainer.innerHTML=`<div class="search-bar"><input type="text" class="search-input" data-type="${type}" data-id="${id}" placeholder="Search in ${titles[type]||''}"></div>`;const renderers={playlists:this.renderPlaylistsView,playlistDetail:this.renderPlaylistDetailView,artists:this.renderArtistsView,albums:this.renderAlbumsView,albumDetail:this.renderAlbumDetailView,songs:this.renderSongsView};renderers[type]&&renderers[type].call(this,contentContainer,id)},
        renderPlaylistSelector(){const e=document.getElementById("playlist-selector-list");e.innerHTML="",app.library.playlists.forEach(t=>{const a=document.createElement("div");a.className="list-item",a.dataset.action="selectPlaylist",a.dataset.id=t.id,a.innerHTML=`<div class="list-icon"><i class="fas fa-list-music"></i></div><div class="list-text">${t.name}</div>`,e.appendChild(a)})},
        renderPlaylistsView(container){const fragment=document.createDocumentFragment();fragment.appendChild(this.createPlaylistItem({id:"favorites",name:"Favorite Songs",artwork:"FAVORITE",songs:[]}));app.library.playlists.forEach(p=>fragment.appendChild(this.createPlaylistItem(p)));container.appendChild(fragment)},
        renderPlaylistDetailView(container,playlistId){const songs=Player.getPlaylistSongs(playlistId);container.innerHTML+=`<div class="action-buttons"><button class="action-btn" data-action="playPlaylist" data-id="${playlistId}"><i class="fas fa-play"></i>Play</button><button class="action-btn" data-action="shuffle" data-type="playlist" data-id="${playlistId}"><i class="fas fa-shuffle"></i>Shuffle</button></div>`;if(songs.length===0){container.innerHTML+='<p class="empty-state">No songs in this playlist.</p>'}else{songs.forEach(song=>container.appendChild(this.createSongListItem(song)))}},
        renderAlbumDetailView(container,albumName){const album=app.library.albums[albumName];if(!album)return container.innerHTML+='<p class="empty-state">Album not found.</p>';container.innerHTML+=`<div class="action-buttons"><button class="action-btn" data-action="playAlbum" data-album="${albumName}"><i class="fas fa-play"></i>Play</button><button class="action-btn" data-action="shuffle" data-type="album" data-id="${albumName}"><i class="fas fa-shuffle"></i>Shuffle</button></div>`;if(album.songs.length===0){container.innerHTML+='<p class="empty-state">No songs in this album.</p>'}else{album.songs.forEach(song=>container.appendChild(this.createSongListItem(song)))}},
        renderArtistsView(container){const artists=Object.keys(app.library.artists).sort();if(artists.length===0)return container.innerHTML+='<p class="empty-state">No artists found.</p>';artists.forEach(artistName=>container.appendChild(this.createArtistListItem(artistName,app.library.artists[artistName][0].artwork)))},
        renderAlbumsView(container){const albums=Object.keys(app.library.albums).sort();if(albums.length===0)return container.innerHTML+='<p class="empty-state">No albums found.</p>';const grid=document.createElement("div");grid.className="grid";albums.forEach(albumName=>grid.appendChild(this.createGridItem(app.library.albums[albumName],"showSubView",albumName)));container.appendChild(grid)},
        renderSongsView(container){const songs=app.library.songs;if(songs.length===0)return container.innerHTML+='<p class="empty-state">No songs found.</p>';container.innerHTML+=`<div class="action-buttons"><button class="action-btn" data-action="playSong" data-id="${songs[0]?.id}"><i class="fas fa-play"></i>Play</button><button class="action-btn" data-action="shuffle" data-type="songs"><i class="fas fa-shuffle"></i>Shuffle</button></div>`;songs.forEach(song=>container.appendChild(this.createSongListItem(song)))},
        createListItem(item){const el=document.createElement("div");el.className="list-item",el.dataset.action="showSubView",el.dataset.type=item.type,el.innerHTML=`<div class="list-icon"><i class="fas ${item.icon}"></i></div><div class="list-text">${item.text}</div><div class="list-arrow"><i class="fas fa-chevron-right"></i></div>`;return el},
        createPlaylistItem(playlist){const songCount=playlist.id==="favorites"?app.library.songs.filter(s=>s.isFavorite).length:playlist.songs.length;const itemHTML=`<div class="playlist-item" data-action="showSubView" data-type="playlistDetail" data-id="${playlist.id}"><div class="playlist-item-artwork" ${playlist.artwork==="FAVORITE"?'id="favorite-playlist-artwork"':`style="background-image:url(${playlist.artwork||'https://via.placeholder.com/150?text=Art'})"`}>${playlist.artwork==="FAVORITE"?'<i class="fas fa-star"></i>':''}</div><div class="playlist-info"><div class="playlist-title">${playlist.name}</div><div class="playlist-subtitle">${songCount} song${songCount!==1?'s':''}</div></div><div class="list-arrow"><i class="fas fa-chevron-right"></i></div></div>`;if(playlist.id==="favorites")return (()=>{const e=document.createElement("div");e.innerHTML=itemHTML;return e.firstChild})();const wrapper=document.createElement("div");wrapper.className="list-item-swipe-container";wrapper.innerHTML=`<div class="list-item-actions"><button class="list-action-btn action-edit" data-action="renamePlaylist" data-id="${playlist.id}">Rename</button><button class="list-action-btn action-delete" data-action="deletePlaylist" data-id="${playlist.id}">Delete</button></div><div class="list-item-swipe-content">${itemHTML}</div>`;return wrapper},
        createArtistListItem(name,artwork){const el=document.createElement("div");el.className="list-item",el.innerHTML=`<div class="list-icon"><img src="${artwork}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;"></div><div class="list-text">${name}</div><div class="list-arrow"><i class="fas fa-chevron-right"></i></div>`;return el},
        createGridItem(item,action,id){const el=document.createElement("div");el.className="grid-item",el.dataset.action=action;if(action==="playSong"){el.dataset.id=item.id,el.innerHTML=`<img src="${item.artwork}" alt="${item.album}"><div class="grid-item-title">${item.title}</div><div class="grid-item-subtitle">${item.artist}</div>`}else if(action==="showSubView"){el.dataset.type="albumDetail",el.dataset.id=id;const songCount=item.songs.length;el.innerHTML=`<img src="${item.artwork}" alt="${id}"><div class="grid-item-title">${id}</div><div class="grid-item-subtitle">${item.artist} • ${songCount} song${songCount!==1?'s':''}</div>`}return el},
        createSongListItem(song){const wrapper=document.createElement("div");wrapper.className="list-item-swipe-container";wrapper.innerHTML=`<div class="list-item-actions"><button class="list-action-btn action-edit" data-action="editSong" data-id="${song.id}">Rename</button><button class="list-action-btn action-delete" data-action="deleteSong" data-id="${song.id}">Delete</button></div><div class="list-item-swipe-content" data-action="playSong" data-id="${song.id}"><img class="song-list-artwork" src="${song.artwork}"><div class="song-list-info-container" style="margin-left:0;padding-right:0;"><div class="song-list-info"><span class="song-list-title ${song.title.includes('[E]') ? 'explicit' : ''}">${song.title}</span><span class="song-list-artist">${song.artist}</span></div><i class="fas fa-ellipsis-h song-menu-btn"></i></div></div>`;return wrapper},
        handleSearch(e){const t=e.target.value.toLowerCase(),a=document.getElementById("search-results-container"),i=document.getElementById("search-categories");a.classList.toggle("hidden",t.length<2),i.classList.toggle("hidden",t.length>=2);if(t.length<2)return;a.innerHTML="";const l=app.library.songs.filter(e=>e.title.toLowerCase().includes(t)||e.artist.toLowerCase().includes(t)||e.album.toLowerCase().includes(t));if(0===l.length)return void(a.innerHTML='<p class="empty-state">No Results</p>');l.forEach(e=>a.appendChild(this.createSongListItem(e)))},
        handleSubViewSearch(e){const t=e.target.closest(".main-content"),a=t.querySelectorAll(".list-item, .list-item-swipe-container, .grid-item"),i=e.target.value.toLowerCase();a.forEach(e=>{const t=e.textContent.toLowerCase();e.style.display=t.includes(i)?"":"none"})},
    };

    init();
});
  </script>
</body>
</html>