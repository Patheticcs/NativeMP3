<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <title>NativeMP3</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="theme-color" content="#000000">
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
  <style>
    :root {
      --system-red: #ff3b30;
      --system-pink: #ff2d55;
      --system-gray: #8e8e93;
      --system-gray-2: #aeaeb2;
      --system-gray-6: #1c1c1e;
      --fill-tertiary: rgba(118, 118, 128, 0.24);
      --border-color: rgba(255, 255, 255, 0.15);
      --safe-area-top: env(safe-area-inset-top, 20px);
      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body {
      overflow: hidden;
      width: 100%;
    }
    body {
      font-family: -apple-system, BlinkMacMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
      background: #000; color: #fff; display: flex; flex-direction: column; -webkit-font-smoothing: antialiased;
      padding-top: env(safe-area-inset-top);
      min-height: calc(100vh + var(--safe-area-top));
      height: unset;
    }
    .app-container { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }
    .view {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column;
      opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; background: #000; z-index: 10;
    }
    .view.active { opacity: 1; visibility: visible; z-index: 20; }
    .header { padding: 0 20px 10px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
    .header.large-title h1 { font-size: 34px; font-weight: 700; }
    .header-profile-icon {
        width: 32px; height: 32px; background: var(--fill-tertiary); color: var(--system-pink);
        border-radius: 50%; font-size: 16px; display: flex; align-items: center; justify-content: center;
    }
    .header-with-back { padding: 0 10px 10px; }
    .header-with-back .back-btn {
        font-size: 17px; color: var(--system-pink); background: none; border: none; cursor: pointer;
        display: flex; align-items: center; gap: 4px; padding: 8px;
    }
    .header-with-back h1 { font-size: 17px; font-weight: 600; flex: 1; text-align: center; margin: 0 10px; }
    .header-actions { display: flex; gap: 15px; min-width: 40px; justify-content: flex-end; align-items: center; }
    .header-actions .icon-btn, .round-btn { background: none; border: none; color: #fff; font-size: 22px; cursor: pointer; }
    .round-btn {
        background: var(--fill-tertiary); width: 32px; height: 32px; border-radius: 50%;
        font-size: 14px; display: flex; align-items: center; justify-content: center;
    }
    .header-actions .header-plus-btn { color: var(--system-red); font-size: 16px; }
    .main-content { flex: 1; overflow-y: auto; scrollbar-width: none; padding-bottom: 130px; }
    .main-content::-webkit-scrollbar { display: none; }
    .search-bar { padding: 10px 20px; position: relative; }
    .search-input {
      width: 100%; padding: 8px 40px 8px 35px; background-color: var(--fill-tertiary); border: none;
      border-radius: 10px; color: #fff; font-size: 17px;
      background-image: url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%238e8e93' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: 10px center;
    }
    .search-input-mic { position: absolute; right: 30px; top: 50%; transform: translateY(-50%); color: var(--system-gray); font-size: 16px; }
    .section-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 20px 15px; }
    .section-header h2 { font-size: 22px; font-weight: 700; }
    .action-buttons { display: flex; gap: 10px; padding: 10px 20px; }
    .action-btn { flex: 1; background: var(--fill-tertiary); border: none; border-radius: 8px; color: var(--system-red); padding: 12px; font-size: 16px; font-weight: 600; cursor: pointer; }
    .action-btn i { margin-right: 8px; }
    .list-item {
        display: flex;
        align-items: center;
        padding: 11px 20px;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        -webkit-user-select: none;
        user-select: none;
    }
    .list-item:first-child { border-top: 1px solid var(--border-color); }
    .list-icon { color: var(--system-pink); width: 30px; font-size: 22px; margin-right: 15px; text-align: center; }
    .list-text { flex: 1; font-size: 17px; }
    .list-arrow { color: var(--system-gray); font-size: 14px; }
    .list-item-swipe-container { position: relative; overflow: hidden; }
    .list-item-swipe-inner {
        display: flex; width: 100%; transform: translateX(0);
        transition: transform 0.3s ease; will-change: transform;
        position: relative; z-index: 2; background: #000;
    }
    .list-item-swipe-content {
        flex-shrink: 0; width: 100%; display: flex;
        align-items: center; padding: 8px 20px;
        border-bottom: 1px solid var(--border-color);
    }
    .list-item-swipe-container:last-of-type .list-item-swipe-content { border-bottom: none; }
    .playlist-swipe-content .playlist-item { padding: 0; }
    .list-item-actions {
        position: absolute; top: 0; right: 0; height: 100%;
        display: flex; z-index: 1;
    }
    .list-action-btn {
        height: 100%; padding: 0; width: 80px; color: #fff; border: none;
        display: flex; align-items: center; justify-content: center;
        font-size: 18px; cursor: pointer; flex-shrink: 0;
        transition: width 0.2s ease;
    }
    .list-item-swipe-inner.delete-ready + .list-item-actions .action-edit { width: 0; }
    .list-item-swipe-inner.delete-ready + .list-item-actions .action-delete { width: 100%; }
    .action-delete { background: var(--system-red); }
    .action-edit { background: var(--system-gray-2); }
    .song-list-artwork { width: 44px; height: 44px; border-radius: 4px; object-fit: cover; margin-right: 12px; background-color: var(--system-gray-6);}
    .song-list-info-content { flex: 1; display: flex; align-items: center; justify-content: space-between; }
    .song-list-info { flex: 1; display: flex; flex-direction: column; }
    .song-list-title { font-size: 17px; display: flex; align-items: center; }
    .song-list-artist { font-size: 14px; color: var(--system-gray); }

    .grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        padding: 0 20px;
    }
    .grid-item {
        cursor: pointer;
        overflow: hidden;
    }
    .grid-item img {
        display: block;
        width: 100%;
        aspect-ratio: 1 / 1;
        object-fit: cover;
        border-radius: 8px;
        background-color: var(--system-gray-6);
        margin-bottom: 5px;
    }
    .grid-item-title {
        font-size: 14px; line-height: 1.2; font-weight: 400; overflow: hidden;
        text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2;
        -webkit-box-orient: vertical; min-height: calc(1.2em * 1.2);
    }
    .grid-item-subtitle {
        font-size: 14px; color: var(--system-gray); min-height: 1.2em;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    .playlist-item {
        display: flex;
        align-items: center;
        padding: 8px 0;
        cursor: pointer;
        width: 100%;
        -webkit-user-select: none;
        user-select: none;
    }
    .playlist-item-artwork {
        width: 54px; height: 54px; border-radius: 4px; margin-right: 15px;
        display: flex; align-items: center; justify-content: center;
        background-color: var(--system-gray-6); background-size: cover; background-position: center;
    }
    #favorite-playlist-artwork { background-image: linear-gradient(135deg, #ff2d55, #ff5e3a); }
    #favorite-playlist-artwork .fa-star { font-size: 28px; }
    .playlist-info { flex: 1; }
    .playlist-title { font-size: 17px; }
    .playlist-subtitle { font-size: 14px; color: var(--system-gray); }
    .search-category-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 10px 20px; }
    .category-item { position: relative; cursor: pointer; }
    .category-item img { width: 100%; display: block; border-radius: 8px; aspect-ratio: 1.5 / 1; object-fit: cover; }
    .category-item::before { content: ''; position: absolute; inset: 0; border-radius: 8px; mix-blend-mode: screen; }
    .category-item[data-color="red"]::before { background-color: #ff3b30; }
    .category-item .category-title { position: absolute; bottom: 12px; left: 12px; font-size: 16px; font-weight: 600; color: #fff; }
    .tab-bar {
      position: fixed; bottom: 0; left: 0; right: 0; background: rgba(28, 28, 30, 0.95);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); display: flex;
      padding-top: 8px; padding-bottom: var(--safe-area-bottom); border-top: 0.5px solid rgba(255, 255, 255, 0.2); z-index: 500;
    }
    .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; cursor: pointer; color: var(--system-gray); }
    .tab-item.active { color: var(--system-pink); }
    .tab-icon { font-size: 22px; margin-bottom: 2px; }
    .tab-label { font-size: 10px; font-weight: 500; }
    .now-playing-bar {
      position: fixed; bottom: calc(50px + var(--safe-area-bottom)); left: 10px; right: 10px;
      background: #2c2c2e; padding: 8px; border-radius: 12px; display: none; align-items: center;
      cursor: pointer; z-index: 600; transform: translateY(0); transition: transform 0.4s ease-in-out;
    }
    .now-playing-bar.active { display: flex; }
    .app-container.player-visible .now-playing-bar { display: none; }
    .now-playing-artwork { width: 44px; height: 44px; border-radius: 8px; object-fit: cover; margin-right: 12px; background-color: var(--system-gray-6); }
    .now-playing-info { flex: 1; font-size: 15px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .now-playing-controls { display: flex; align-items: center; gap: 20px; margin-right: 5px; }
    .now-playing-btn { background: none; border: none; color: #fff; font-size: 22px; cursor: pointer; }
    #player-view .main-content {
      display: flex;
      flex-direction: column;
      justify-content: space-evenly;
      padding: 0 30px;
      flex-grow: 1;
    }
    #player-view .header-with-back { background: transparent; border: none; position: relative; z-index: 1; padding-top: var(--safe-area-top); }
    #player-view .player-header-title { font-size: 17px; font-weight: 600; opacity: 0.8; }
    .player-artwork-container {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px 0;
    }
    .player-artwork {
        width: 100%; aspect-ratio: 1/1; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); background-color: var(--system-gray-6);
    }
    .player-info-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .player-details .title { font-size: 22px; font-weight: 700; }
    .player-details .artist { font-size: 22px; color: var(--system-gray-2); }
    .favorite-btn { font-size: 24px; color: #fff; background: none; border: none; cursor: pointer; }
    .favorite-btn.favorited { color: var(--system-pink); }
    .favorite-btn i { font-size: 16px; }
    .progress-container { margin-bottom: 10px; }
    .progress-bar { width: 100%; height: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; cursor: pointer; position: relative; }
    .progress-fill { height: 100%; background: #fff; border-radius: 4px; width: 0%; }
    .progress-times { display: flex; justify-content: space-between; font-size: 12px; color: var(--system-gray); margin-top: 8px; }
    .player-controls { display: flex; align-items: center; justify-content: space-between; margin: 15px 0; }
    .control-btn { background: none; border: none; color: #fff; cursor: pointer; font-size: 28px; }
    .control-btn.main { font-size: 50px; }
    .volume-container { display: flex; align-items: center; gap: 15px; margin-top: 15px; }
    .volume-container i { color: var(--system-gray); }
    .volume-slider { flex: 1; height: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; cursor: pointer; }
    .player-extra-controls { display: flex; justify-content: space-around; align-items: center; margin: 15px 0 20px; }
    .player-extra-controls .control-btn { font-size: 20px; color: var(--system-gray); }
    .player-extra-controls .repeat-btn.active { color: var(--system-pink); }
    .song-list-title.explicit::after,
    .player-details .title.explicit::after {
        content: 'E'; font-size: 11px; font-weight: 600; background: rgba(255,255,255,0.3);
        color: #fff; padding: 1px 4px; border-radius: 3px; margin-left: 8px; vertical-align: middle;
    }
    .modal-view {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1100;
      display: flex; flex-direction: column;
    }
    .modal-form-container { padding: 20px; display: flex; flex-direction: column; gap: 20px; }
    .modal-artwork-section { text-align: center; }
    .modal-artwork-preview { width: 150px; height: 150px; background-color: #333; border-radius: 8px; margin: 0 auto 15px; object-fit: cover; cursor: pointer; }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { color: var(--system-gray); font-size: 14px; margin-bottom: 8px; text-transform: uppercase; }
    .form-group input, .form-group button { background: var(--fill-tertiary); border: none; border-radius: 8px; padding: 12px; font-size: 17px; color: #fff; }
    .form-group button { background: var(--system-pink); cursor: pointer; font-weight: 600; }
    .form-group .secondary-btn { background: var(--fill-tertiary); }
    .select-playlist-modal .list-item { padding-left: 0; }
    .hidden { display: none !important; }
    .loading-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999;
        display: none; align-items: center; justify-content: center;
    }
    .loading-overlay.active { display: flex; }
    .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .empty-state { text-align: center; color: var(--system-gray); padding: 50px 20px; }
    .confirm-dialog-overlay {
        position: fixed; inset: 0; background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        display: flex; align-items: center; justify-content: center;
        z-index: 10000;
    }
    .confirm-dialog {
        background: rgba(44, 44, 46, 0.95);
        border-radius: 14px; width: 270px; text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .confirm-dialog-content { padding: 20px 16px 0; }
    .confirm-dialog-title { font-size: 17px; font-weight: 600; }
    .confirm-dialog-message { font-size: 13px; margin: 4px 0 20px; color: var(--system-gray-2); line-height: 1.3; }
    .confirm-dialog-actions {
        display: flex; border-top: 0.5px solid rgba(255, 255, 255, 0.25);
    }
    .confirm-dialog-actions button {
        flex: 1; background: transparent; border: none;
        color: #0a84ff; font-size: 17px; padding: 12px 0; cursor: pointer;
    }
    .confirm-dialog-actions button:first-child {
        border-right: 0.5px solid rgba(255, 255, 255, 0.25);
        font-weight: 400;
    }
    .confirm-dialog-actions .confirm-btn {
        color: var(--system-red);
        font-weight: 600;
    }
    .upload-song-list-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
    }
    .upload-song-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 10px;
        background: var(--fill-tertiary);
        border-radius: 8px;
        position: relative;
    }
    .upload-song-item .modal-artwork-preview {
        width: 60px;
        height: 60px;
        margin: 0;
        flex-shrink: 0;
    }
    .upload-song-details {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-width: 0;
    }
    .upload-song-details input {
        padding: 8px 12px;
        font-size: 16px;
        width: 100%;
        background-color: rgba(118, 118, 128, 0.34);
        border: none;
        border-radius: 4px;
        color: #fff;
    }
    .upload-song-details .song-file-name-small {
        font-size: 12px;
        color: var(--system-gray);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .remove-song-btn {
        position: absolute;
        top: -5px;
        right: -5px;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: var(--system-gray);
        color: var(--system-gray-6);
        border: none;
        font-size: 14px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        line-height: 1;
        z-index: 5;
    }
    #sub-view .header-fixed-top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 10px 10px;
        flex-shrink: 0;
    }
    #sub-view .header-fixed-top-bar .back-btn {
        font-size: 17px;
        color: var(--system-pink);
        background: none;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 8px;
        margin-left: -8px;
    }
    #sub-view .header-fixed-top-bar .header-actions {
        min-width: 40px;
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        align-items: center;
    }
    .sub-view-scrollable-header-content {
        flex-grow: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
    .sub-view-scrollable-header-content::-webkit-scrollbar { display: none; }
    .sub-view-dynamic-header-elements {
        padding: 0 20px;
        flex-shrink: 0;
    }
    .sub-view-dynamic-header-elements .header.large-title h1 {
        font-size: 34px;
        font-weight: 700;
        margin-top: 0;
        margin-bottom: 15px;
    }
    .sub-view-dynamic-header-elements .search-bar {
        padding: 0;
        position: relative;
        margin-bottom: 15px;
    }
    .sub-view-dynamic-header-elements .search-bar .search-input {
        width: 100%;
    }
    .sub-view-dynamic-header-elements .search-bar .search-input-mic {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--system-gray);
        font-size: 16px;
    }
    .sub-view-dynamic-header-elements .action-buttons {
        padding: 0;
        margin-bottom: 15px;
    }
    #sub-view .main-content {
        padding: 0 20px 130px 20px;
    }
    #sub-view .main-content.has-spacer {
        display: flex;
        flex-direction: column;
        flex: 1;
    }
    #sub-view .main-content.has-spacer::after {
        content: '';
        flex-grow: 1;
    }
    #sub-view .main-content .grid {
      padding: 0;
    }
    .album-header {
        padding: 10px 0;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }
    .album-artwork-main {
        width: 60%;
        max-width: 240px;
        aspect-ratio: 1/1;
        border-radius: 8px;
        margin-bottom: 10px;
        background-color: var(--system-gray-6);
        object-fit: cover;
    }
    .album-title-main {
        font-size: 24px;
        font-weight: 700;
        line-height: 1.2;
    }
    .album-artist-main {
        font-size: 20px;
        color: var(--system-red);
        font-weight: 400;
    }
    .album-meta {
        font-size: 14px;
        color: var(--system-gray);
    }
    .album-song-item {
        display: flex;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        gap: 15px;
        -webkit-user-select: none;
        user-select: none;
    }
    .album-song-item:first-child {
        border-top: 1px solid var(--border-color);
    }
    .album-song-item:last-child {
        border-bottom: none;
    }
    .album-song-track-number {
        color: var(--system-gray);
        font-size: 17px;
        width: 25px;
        text-align: right;
    }
    .album-song-title {
        flex: 1;
        font-size: 17px;
        display: flex;
        align-items: center;
    }
    .album-song-title.explicit::after {
        content: 'E';
        font-size: 11px;
        font-weight: 600;
        background: rgba(255,255,255,0.3);
        color: #fff;
        padding: 1px 4px;
        border-radius: 3px;
        margin-left: 8px;
        vertical-align: middle;
    }
    #sub-view .header-fixed-top-bar .back-btn i {
        font-size: 22px;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div id="home-view" class="view"><div class="header large-title"><h1>Home</h1></div></div>
    <div id="new-view" class="view"><div class="header large-title"><h1>New</h1></div></div>
    <div id="radio-view" class="view"><div class="header large-title"><h1>Radio</h1></div></div>
    <div id="library-view" class="view">
        <div class="header large-title"><h1>Library</h1><div class="header-actions"><button class="round-btn header-plus-btn" data-action="openUploadModal"><i class="fas fa-plus"></i></button><div class="header-profile-icon"><i class="fas fa-user"></i></div></div></div>
        <div class="main-content" id="library-content"></div>
    </div>
    <div id="sub-view" class="view">
        <div class="header-fixed-top-bar">
            <button class="back-btn" data-action="goBack"><i class="fas fa-arrow-left"></i> <span id="back-btn-text">Library</span></button>
            <div class="header-actions" id="sub-view-top-actions"></div>
        </div>
        <div class="sub-view-scrollable-header-content">
            <div class="sub-view-dynamic-header-elements">
                <div class="header large-title" id="sub-view-large-title-area"></div>
                <div class="search-bar" id="sub-view-search-bar-area"></div>
                <div class="action-buttons" id="sub-view-main-actions-area"></div>
            </div>
            <div class="main-content" id="sub-view-content"></div>
        </div>
    </div>
    <div id="search-view" class="view">
      <div class="header large-title"><h1>Search</h1><div class="header-profile-icon"><i class="fas fa-user"></i></div></div>
      <div class="main-content">
        <div class="search-bar"><input type="text" class="search-input" id="search-input" placeholder="Artists, Songs, and Albums"><i class="fas fa-microphone search-input-mic"></i></div>
        <div id="search-results-container" class="hidden"></div>
        <div id="search-categories">
            <div class="section-header"><h2>Browse Categories</h2></div>
            <div class="search-category-grid">
                <div class="category-item" data-color="red"><img src="https://images.unsplash.com/photo-1516450360452-9312f5e86fc7?w=400&auto=format&fit=crop" alt=""><span class="category-title">Set Lists</span></div>
                <div class="category-item" data-color="red"><img src="https://images.unsplash.com/photo-1525362083236-02439a1d1478?w=400&auto=format&fit=crop" alt=""><span class="category-title">Alternative</span></div>
            </div>
          </div>
      </div>
    </div>
    <div id="upload-view" class="modal-view view">
        <div class="header header-with-back">
            <button class="back-btn" data-action="closeUploadModal">Cancel</button>
            <h1 style="text-align: center;">Add Music</h1>
            <div class="header-actions" style="min-width: 60px;"><button class="back-btn" data-action="submitUpload">Done</button></div>
        </div>
        <div class="main-content">
            <form class="modal-form-container" id="upload-form">
                <div id="upload-song-list" class="upload-song-list-container">
                </div>
                <div class="form-group" id="song-file-selector-group">
                    <button type="button" class="secondary-btn" data-action="triggerSongUpload">Select Song File(s)</button>
                    <span id="song-file-name" style="color: var(--system-gray); font-size: 14px; margin-top: 8px; text-align: center;"></span>
                    <input type="file" id="music-file-input" class="hidden" accept=".mp3" multiple>
                </div>
                <div class="form-group">
                    <button type="button" class="secondary-btn" data-action="openPlaylistSelector">Add to Playlist (Optional)</button>
                    <span id="selected-playlist-name" style="color: var(--system-gray); font-size: 14px; margin-top: 8px; text-align: center;">No playlist selected.</span>
                </div>
            </form>
        </div>
    </div>
    <div id="playlist-selector-view" class="modal-view view select-playlist-modal">
        <div class="header header-with-back">
            <button class="back-btn" data-action="closePlaylistSelector">Back</button>
            <h1 style="text-align: center;">Select Playlist</h1>
            <div class="header-actions" style="min-width: 60px;"></div>
        </div>
        <div class="main-content" id="playlist-selector-list"></div>
    </div>
    <div id="create-playlist-view" class="modal-view view">
        <div class="header header-with-back">
            <button class="back-btn" data-action="closeCreatePlaylistModal">Cancel</button>
            <h1 style="text-align: center;">New Playlist</h1>
            <div class="header-actions" style="min-width: 60px;"><button class="back-btn" data-action="submitCreatePlaylist">Done</button></div>
        </div>
        <div class="main-content">
            <form class="modal-form-container" id="create-playlist-form">
                <div class="modal-artwork-section"><img id="playlist-artwork-preview" class="modal-artwork-preview" src="https://via.placeholder.com/150?text=Artwork" data-action="triggerPlaylistArtworkUpload" alt="Playlist Artwork Preview"><input type="file" id="playlist-artwork-input" class="hidden" accept="image/*"></div>
                <div class="form-group"><label for="playlist-name-input">PLAYLIST NAME</label><input type="text" id="playlist-name-input" required></div>
            </form>
        </div>
    </div>
    <div id="player-view" class="view">
        <div class="header header-with-back">
            <button class="back-btn" data-action="hideFullPlayer"><i class="fas fa-chevron-down"></i></button>
            <h1 class="player-header-title">Now Playing</h1>
            <div style="width: 40px; height: 100%;"></div>
        </div>
        <div class="main-content">
            <div class="player-artwork-container">
                <img id="player-artwork" class="player-artwork" src="" alt="">
            </div>
            <div>
                <div class="player-info-container">
                    <div class="player-details"><div id="player-title" class="title">Not Playing</div><div id="player-artist" class="artist"></div></div>
                    <button class="round-btn favorite-btn" data-action="toggleFavorite"><i class="far fa-star"></i></button>
                </div>
                <div class="progress-container" data-action="seek"><div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div><div class="progress-times"><span id="current-time">0:00</span><span id="total-time">0:00</span></div></div>
                <div class="player-controls">
                  <button class="control-btn" data-action="prevSong"><i class="fas fa-backward-step"></i></button>
                  <button class="control-btn main" data-action="togglePlay"><i id="main-play-icon" class="fas fa-play-circle"></i></button>
                  <button class="control-btn" data-action="nextSong"><i class="fas fa-forward-step"></i></button></div>
                <div class="volume-container">
                  <i class="fas fa-volume-down"></i><div class="volume-slider" data-action="setVolume"><div class="progress-fill" id="volume-fill" style="width: 50%;"></div></div><i class="fas fa-volume-up"></i></div>
                <div class="player-extra-controls">
                  <button class="control-btn"><i class="fas fa-comment-dots"></i></button>
                  <button class="control-btn repeat-btn" data-action="toggleRepeat"><i id="repeat-icon" class="fas fa-repeat"></i></button>
                  <button class="control-btn"><i class="fas fa-list-ul"></i></button>
                </div>
            </div>
        </div>
    </div>
    <div class="now-playing-bar" id="now-playing-bar" data-action="showFullPlayer">
      <img id="np-artwork" class="now-playing-artwork" src="" alt=""><div id="np-title" class="now-playing-info">Not Playing</div>
      <div class="now-playing-controls">
        <button class="now-playing-btn" data-action="togglePlay"><i id="np-play-icon" class="fas fa-play"></i></button>
        <button class="now-playing-btn" data-action="nextSong"><i class="fas fa-forward-step"></i></button>
      </div>
    </div>
  </div>
  <div class="tab-bar">
    <div class="tab-item" data-action="showView" data-view="home"><i class="fas fa-house tab-icon"></i><span class="tab-label">Home</span></div>
    <div class="tab-item" data-action="showView" data-view="new"><i class="fas fa-grip tab-icon"></i><span class="tab-label">New</span></div>
    <div class="tab-item" data-action="showView" data-view="radio"><i class="fas fa-tower-broadcast tab-icon"></i><span class="tab-label">Radio</span></div>
    <div class="tab-item active" data-action="showView" data-view="library"><i class="fas fa-rectangle-list tab-icon"></i><span class="tab-label">Library</span></div>
    <div class="tab-item" data-action="showView" data-view="search"><i class="fas fa-magnifying-glass tab-icon"></i><span class="tab-label">Search</span></div>
  </div>
  <audio id="audio" preload="metadata"></audio>
  <div class="loading-overlay" id="loading-overlay"><div class="spinner"></div></div>
  <div id="confirm-dialog" class="confirm-dialog-overlay hidden">
    <div class="confirm-dialog">
        <div class="confirm-dialog-content">
            <h3 id="confirm-title" class="confirm-dialog-title"></h3>
            <p id="confirm-message" class="confirm-dialog-message"></p>
        </div>
        <div class="confirm-dialog-actions">
            <button id="confirm-cancel-btn">Cancel</button>
            <button id="confirm-confirm-btn" class="confirm-btn">Delete</button>
        </div>
    </div>
</div>
  <script>
document.addEventListener('DOMContentLoaded', () => {
    const app = {
        db: null,
        nowPlaying: { id: null, queue: [], currentIndex: -1, isPlaying: false, repeatMode: 'none' },
        library: { songs: [], playlists: [], artists: {}, albums: {} },
        uploadData: { songsToUpload: [], editingId: null, selectedPlaylistId: null },
        playlistData: { artworkBase64: null },
    };
    const DOM = {
        views: document.querySelectorAll('.view'),
        appContainer: document.querySelector('.app-container'),
        audio: document.getElementById('audio'),
        loadingOverlay: document.getElementById('loading-overlay'),
    };
    function init() {
        DB.init().then(() => {
            Library.loadAllData().then(() => {
                UI.renderAll();
                handlePopState();
            });
        });
        setupEventListeners();
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('Service Worker registered', reg))
                .catch(err => console.error('Service Worker registration failed:', err));
        }
    }
    function setupEventListeners() {
        document.body.addEventListener('click', handleAction);
        window.addEventListener('popstate', handlePopState);
        DOM.audio.addEventListener('timeupdate', () => Player.updateProgress());
        DOM.audio.addEventListener('loadedmetadata', () => Player.updateProgress());
        DOM.audio.addEventListener('ended', () => Player.nextSong());
        DOM.audio.addEventListener('error', e => { if (e.target.error && e.target.error.code === 4) Player.nextSong(); });
        document.getElementById('music-file-input').addEventListener('change', e => Upload.handleSongFileSelect(e));
        document.getElementById('playlist-artwork-input').addEventListener('change', e => Playlist.handleArtworkFileSelect(e));
        document.getElementById('search-input').addEventListener('input', e => UI.handleSearch(e));
        document.body.addEventListener('input', e => {
            if (e.target.closest('#sub-view-search-bar-area') && e.target.classList.contains('search-input')) {
                UI.handleSubViewSearch(e);
            }
        });
        // FIX: Swipe listeners are now added/removed dynamically instead of being here globally.
    }
    function handleAction(e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        const action = target.dataset.action;
        if (target.closest('#now-playing-bar') && (action === 'togglePlay' || action === 'nextSong')) e.stopPropagation();
        const actions = {
            'showView': () => { const viewId = `${target.dataset.view}-view`; if (document.getElementById(viewId)) UI.showView(viewId); },
            'goBack': UI.goBack,
            'openUploadModal': Upload.openModal,
            'closeUploadModal': Upload.closeModal,
            'openCreatePlaylistModal': Playlist.openModal,
            'closeCreatePlaylistModal': Playlist.closeModal,
            'openPlaylistSelector': Upload.openPlaylistSelector,
            'closePlaylistSelector': Upload.closePlaylistSelector,
            'selectPlaylist': () => Upload.selectPlaylist(parseInt(target.dataset.id)),
            'triggerSongUpload': () => document.getElementById('music-file-input').click(),
            'triggerPlaylistArtworkUpload': () => document.getElementById('playlist-artwork-input').click(),
            'triggerSongArtworkUpload': () => {
                const index = target.dataset.index;
                document.querySelector(`.song-artwork-input[data-index='${index}']`).click();
            },
            'removeSongFromUpload': () => {
                const index = parseInt(target.dataset.index, 10);
                app.uploadData.songsToUpload.splice(index, 1);
                Upload.renderSongUploadList();
                const count = app.uploadData.songsToUpload.length;
                document.getElementById('song-file-name').textContent = count > 0 ? `${count} file(s) selected.` : '';
            },
            'submitUpload': Upload.submit,
            'submitCreatePlaylist': Playlist.submit,
            'showSubView': () => UI.showSubView(target.dataset.type, target.dataset.id),
            'playSong': () => { if (Player.playSong(parseInt(target.dataset.id))) UI.showView('player-view'); },
            'playAlbum': () => { if (Player.playAlbum(target.dataset.album)) UI.showView('player-view'); },
            'playPlaylist': () => { if (Player.playPlaylist(target.dataset.id)) UI.showView('player-view'); },
            'shuffle': () => { if (Player.shuffle(target.dataset.type, target.dataset.id)) UI.showView('player-view'); },
            'togglePlay': () => Player.togglePlay(),
            'nextSong': () => Player.nextSong(),
            'prevSong': () => Player.prevSong(),
            'showFullPlayer': () => { if (app.nowPlaying.id) { UI.showView('player-view'); history.pushState({ viewId: 'player-view' }, '', '#playing'); } },
            'hideFullPlayer': UI.hideFullPlayer,
            'seek': Player.seek,
            'setVolume': Player.setVolume,
            'toggleFavorite': Player.toggleFavorite,
            'toggleRepeat': () => Player.toggleRepeat(),
            'editSong': () => Upload.editSong(parseInt(target.dataset.id)),
            'deleteSong': () => Library.deleteSong(parseInt(target.dataset.id)),
            'renamePlaylist': () => Playlist.rename(parseInt(target.dataset.id)),
            'deletePlaylist': () => Playlist.delete(parseInt(target.dataset.id)),
        };
        if (actions[action]) actions[action](e);
    }
    function handlePopState() {
        const hash = window.location.hash.slice(1);
        const [path, id] = hash.split('/');
        switch (path) {
            case 'home': UI.showView('home-view', true); break;
            case 'new': UI.showView('new-view', true); break;
            case 'radio': UI.showView('radio-view', true); break;
            case 'search': UI.showView('search-view', true); break;
            case 'playlists': case 'artists': case 'albums': case 'songs': UI.showSubView(path, undefined, true); break;
            case 'playlistDetail': case 'albumDetail': UI.showSubView(path, id, true); break;
            case 'playing': if (app.nowPlaying.id) UI.showView('player-view', true); else window.location.hash = 'library'; break;
            case 'library': case '': default: UI.showView('library-view', true); break;
        }
    }
    const DB = {
        init: () => new Promise(resolve => {
            const request = indexedDB.open("AppleMusicDB_v17_Final", 1);
            request.onupgradeneeded = e => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains("songs")) db.createObjectStore("songs", { keyPath: "id", autoIncrement: true });
                if (!db.objectStoreNames.contains("playlists")) db.createObjectStore("playlists", { keyPath: "id", autoIncrement: true });
            };
            request.onsuccess = e => { app.db = e.target.result; resolve(); };
            request.onerror = e => console.error("IndexedDB error:", e.target.errorCode);
        }),
        add: (store, item) => new Promise((res, rej) => { const r = app.db.transaction(store, 'readwrite').objectStore(store).add(item); r.onsuccess = e => res(e.target.result); r.onerror = rej; }),
        put: (store, item) => new Promise(res => app.db.transaction(store, 'readwrite').objectStore(store).put(item).onsuccess = res),
        delete: (store, id) => new Promise(res => app.db.transaction(store, 'readwrite').objectStore(store).delete(id).onsuccess = res),
        get: (store, id) => new Promise(res => app.db.transaction(store).objectStore(store).get(id).onsuccess = e => res(e.target.result)),
        getAll: store => new Promise(res => app.db.transaction(store).objectStore(store).getAll().onsuccess = e => res(e.target.result)),
    };
    const Library = {
        async loadAllData() {
            [app.library.songs, app.library.playlists] = await Promise.all([DB.getAll("songs"), DB.getAll("playlists")]);
            this.processLibrary();
        },
        processLibrary() {
            app.library.artists = {}; app.library.albums = {};
            app.library.songs.forEach(song => {
                const artist = song.artist || "Unknown Artist", album = song.album || "Unknown Album";
                if (!app.library.artists[artist]) app.library.artists[artist] = [];
                app.library.artists[artist].push(song);
                if (!app.library.albums[album]) app.library.albums[album] = { songs: [], artwork: song.artwork, artist: artist };
                app.library.albums[album].songs.push(song);
            });
        },
        async deleteSong(id, skipConfirm = false) {
            const song = app.library.songs.find(s => s.id === id);
            if (!song) return;
            const deleteLogic = async () => {
                await DB.delete('songs', id);
                for (const playlist of app.library.playlists) { if (playlist.songs.includes(id)) { playlist.songs.splice(playlist.songs.indexOf(id), 1); await DB.put('playlists', playlist); } }
                if (app.nowPlaying.id === id) Player.stop();
                else { const queueIndex = app.nowPlaying.queue.indexOf(id); if (queueIndex > -1) { app.nowPlaying.queue.splice(queueIndex, 1); if (queueIndex < app.nowPlaying.currentIndex) app.nowPlaying.currentIndex--; } }
                await this.loadAllData();
                const currentHash = window.location.hash.slice(1);
                const [path, pathId] = currentHash.split('/');
                if (document.getElementById('sub-view').classList.contains('active')) UI.renderSubView(path, pathId);
                UI.renderLibraryView();
            };
            if (skipConfirm) await deleteLogic(); else UI.showConfirmation(`Delete Song?`, `This will remove "${song.title}" from your library and all playlists.`, deleteLogic);
        }
    };
    const Upload = {
        openModal: () => {
            Upload.resetForm();
            document.getElementById('song-file-selector-group').classList.remove('hidden');
            UI.showModal('upload-view');
        },
        closeModal: () => UI.hideModal('upload-view'),
        resetForm() {
            document.getElementById('upload-form').reset();
            document.getElementById('upload-song-list').innerHTML = '';
            document.getElementById('song-file-name').textContent = '';
            document.getElementById('selected-playlist-name').textContent = 'No playlist selected.';
            app.uploadData = { songsToUpload: [], editingId: null, selectedPlaylistId: null };
            document.querySelector('#upload-view h1').textContent = "Add Music";
            document.querySelector('#upload-view [data-action="submitUpload"]').textContent = "Done";
        },
        editSong(id) {
            const songToEdit = app.library.songs.find(s => s.id === id);
            if (songToEdit) {
                this.openModal();
                app.uploadData.editingId = id;
                app.uploadData.songsToUpload.push({
                    file: null,
                    title: songToEdit.title,
                    artist: songToEdit.artist,
                    album: songToEdit.album,
                    artworkBase64: songToEdit.artwork,
                    originalFileName: "Original file"
                });
                this.renderSongUploadList();
                document.getElementById('song-file-selector-group').classList.add('hidden');
                document.querySelector("#upload-view h1").textContent = "Edit Song";
                document.querySelector('#upload-view [data-action="submitUpload"]').textContent = "Save";
            }
        },
        handleSongFileSelect(e) {
            const files = e.target.files;
            if (!files.length) return;
            document.getElementById('song-file-name').textContent = `${files.length} file(s) selected.`;
            app.uploadData.songsToUpload = [];
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const songData = {
                    file: file, title: file.name.replace(/\.[^/.]+$/, ""), artist: 'Unknown Artist', album: 'Unknown Album',
                    artworkBase64: 'https://via.placeholder.com/150?text=Artwork', originalFileName: file.name
                };
                app.uploadData.songsToUpload.push(songData);
                jsmediatags.read(file, {
                    onSuccess: ({ tags }) => {
                        if (tags.title) songData.title = tags.title;
                        if (tags.artist) songData.artist = tags.artist;
                        if (tags.album) songData.album = tags.album;
                        if (tags.picture) songData.artworkBase64 = `data:${tags.picture.format};base64,${btoa(String.fromCharCode.apply(null, tags.picture.data))}`;
                        this.renderSongUploadList();
                    },
                    onError: () => this.renderSongUploadList()
                });
            }
            this.renderSongUploadList();
        },
        handleSongArtworkFileSelect(e) {
            const file = e.target.files[0];
            const index = e.target.dataset.index;
            if (file && index !== undefined) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    app.uploadData.songsToUpload[index].artworkBase64 = event.target.result;
                    document.querySelector(`img[data-action='triggerSongArtworkUpload'][data-index='${index}']`).src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        },
        renderSongUploadList() {
            const container = document.getElementById('upload-song-list');
            container.innerHTML = '';
            app.uploadData.songsToUpload.forEach((song, index) => {
                const item = document.createElement('div');
                item.className = 'upload-song-item';
                item.dataset.index = index;
                item.innerHTML = `
                    <div class="upload-song-artwork">
                        <img src="${song.artworkBase64}" class="modal-artwork-preview" data-action="triggerSongArtworkUpload" data-index="${index}" alt="Artwork Preview">
                        <input type="file" class="hidden song-artwork-input" accept="image/*" data-index="${index}">
                    </div>
                    <div class="upload-song-details">
                        <input type="text" placeholder="Title" class="upload-song-title" value="${song.title.replace(/"/g, '"')}" required>
                        <input type="text" placeholder="Artist" class="upload-song-artist" value="${song.artist.replace(/"/g, '"')}" required>
                        <input type="text" placeholder="Album" class="upload-song-album" value="${song.album.replace(/"/g, '"')}" required>
                        <span class="song-file-name-small">${song.originalFileName}</span>
                    </div>
                    <button type="button" class="remove-song-btn" data-action="removeSongFromUpload" data-index="${index}">Ã—</button>`;
                container.appendChild(item);
            });
            container.querySelectorAll('.song-artwork-input').forEach(input => {
                input.addEventListener('change', (e) => this.handleSongArtworkFileSelect(e));
            });
        },
        async submit() {
            const songItems = document.querySelectorAll('.upload-song-item');
            if (songItems.length === 0) { alert("Please select at least one song file."); return; }
            let allFieldsValid = true;
            songItems.forEach((item, index) => {
                const title = item.querySelector('.upload-song-title').value, artist = item.querySelector('.upload-song-artist').value, album = item.querySelector('.upload-song-album').value;
                if (!title || !artist || !album) allFieldsValid = false;
                app.uploadData.songsToUpload[index].title = title;
                app.uploadData.songsToUpload[index].artist = artist;
                app.uploadData.songsToUpload[index].album = album;
            });
            if (!allFieldsValid) { alert("Please fill all title, artist, and album fields."); return; }
            if (!app.uploadData.editingId && app.uploadData.songsToUpload.some(s => !s.file)) { alert("An error occurred. Please re-select your files."); return; }
            UI.showLoading(true); let success = false;
            try {
                if (app.uploadData.editingId) {
                    const songToSave = app.uploadData.songsToUpload[0];
                    const existingSong = await DB.get("songs", app.uploadData.editingId);
                    const songData = { ...existingSong, id: app.uploadData.editingId, title: songToSave.title, artist: songToSave.artist, album: songToSave.album, artwork: songToSave.artworkBase64 };
                    await DB.put("songs", songData);
                } else {
                    const newSongIds = [];
                    for (const song of app.uploadData.songsToUpload) {
                        const songData = { title: song.title, artist: song.artist, album: song.album, artwork: song.artworkBase64, file: song.file, addedAt: Date.now(), isFavorite: false };
                        const songId = await DB.add("songs", songData);
                        newSongIds.push(songId);
                    }
                    if (app.uploadData.selectedPlaylistId && newSongIds.length > 0) {
                        const playlist = await DB.get("playlists", app.uploadData.selectedPlaylistId);
                        if (playlist) { playlist.songs.push(...newSongIds); await DB.put("playlists", playlist); }
                    }
                }
                await Library.loadAllData(); success = true;
            } catch (err) { console.error("Error during upload/save:", err); alert("An error occurred while saving the music."); }
            finally {
                UI.showLoading(false);
                if (success) {
                    this.closeModal();
                    UI.showView('library-view');
                }
            }
        },
        openPlaylistSelector() { UI.renderPlaylistSelector(); UI.showModal('playlist-selector-view'); },
        closePlaylistSelector() { UI.hideModal('playlist-selector-view'); },
        selectPlaylist(id) {
            app.uploadData.selectedPlaylistId = id; const playlist = app.library.playlists.find(p => p.id === id);
            document.getElementById('selected-playlist-name').textContent = playlist ? playlist.name : 'No playlist selected.'; this.closePlaylistSelector();
        }
    };
    const Playlist = {
        openModal: () => { Playlist.resetForm(); UI.showModal('create-playlist-view'); },
        closeModal: () => UI.hideModal('create-playlist-view'),
        resetForm() { document.getElementById("create-playlist-form").reset(); document.getElementById("playlist-artwork-preview").src = "https://via.placeholder.com/150?text=Artwork"; app.playlistData = { artworkBase64: null }; },
        handleArtworkFileSelect(e) {
            const file = e.target.files[0];
            if (file) { const reader = new FileReader(); reader.onload = e => { app.playlistData.artworkBase64 = e.target.result; document.getElementById("playlist-artwork-preview").src = app.playlistData.artworkBase64; }; reader.readAsDataURL(file); }
        },
        async submit() {
            const name = document.getElementById("playlist-name-input").value.trim(); if (!name) return alert("Please enter a playlist name.");
            UI.showLoading(true);
            let success = false;
            let newPlaylistId = null; 

            try {
                const playlistData = { name, songs: [], artwork: app.playlistData.artworkBase64, createdAt: Date.now() };
                newPlaylistId = await DB.add("playlists", playlistData);
                await Library.loadAllData();
                success = true;
            } catch(err) {
                 console.error("Error creating playlist:", err);
            }
            finally {
                UI.showLoading(false);
                if (success && newPlaylistId) {
                    this.closeModal();
                    UI.showSubView('playlistDetail', newPlaylistId);
                }
            }
        },
        async rename(id) {
            const playlist = app.library.playlists.find(p => p.id === id); if (!playlist) return;
            const newName = prompt("Enter new playlist name:", playlist.name);
            if (newName && newName.trim() !== "") { playlist.name = newName.trim(); await DB.put('playlists', playlist); await Library.loadAllData(); UI.renderSubView('playlists'); SwipeList.resetAllSwipes(); }
        },
        async delete(id, skipConfirm = false) {
            const playlist = app.library.playlists.find(p => p.id === id); if (!playlist) return;
            const deleteLogic = async () => { await DB.delete('playlists', id); await Library.loadAllData(); UI.renderSubView('playlists'); };
            if (skipConfirm) await deleteLogic(); else UI.showConfirmation(`Delete Playlist?`, `"${playlist.name}" will be removed from your library.`, deleteLogic);
        }
    };
    const SwipeList = {
        startX: 0, currentX: 0, target: null, container: null, isSwiping: false, actionsElement: null, initialActionsWidth: 160,
        // FIX: Create functions to dynamically add and remove swipe listeners
        addListeners() {
            const content = document.getElementById('sub-view-content');
            content.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: true });
            content.addEventListener('touchmove', this.handleTouchMove.bind(this), { passive: false });
            content.addEventListener('touchend', this.handleTouchEnd.bind(this));
        },
        removeListeners() {
            const content = document.getElementById('sub-view-content');
            content.removeEventListener('touchstart', this.handleTouchStart.bind(this));
            content.removeEventListener('touchmove', this.handleTouchMove.bind(this));
            content.removeEventListener('touchend', this.handleTouchEnd.bind(this));
        },
        handleTouchStart(e) {
            const container = e.target.closest('.list-item-swipe-container');
            if (!container || e.target.closest('[data-action]')) return;
            this.resetAllSwipes(container);
            this.container = container; this.target = container.querySelector('.list-item-swipe-inner'); this.actionsElement = container.querySelector('.list-item-actions');
            if (!this.target || !this.actionsElement) return;
            this.startX = e.touches[0].clientX; this.currentX = this.startX; this.isSwiping = true;
            this.target.style.transition = 'none'; this.actionsElement.style.transition = 'none';
        },
        handleTouchMove(e) {
            if (!this.isSwiping || !this.target) return;
            this.currentX = e.touches[0].clientX; let diff = this.currentX - this.startX;
            if (diff > 0) diff = 0;
            this.target.style.transform = `translateX(${diff}px)`;
            this.actionsElement.style.width = `${-diff}px`;
            const deleteThreshold = this.container.offsetWidth * (2/3);
            this.target.classList.toggle('delete-ready', Math.abs(diff) > deleteThreshold);
        },
        handleTouchEnd() {
            if (!this.isSwiping || !this.target) return;
            this.isSwiping = false; this.target.style.transition = 'transform 0.3s ease'; if (this.actionsElement) this.actionsElement.style.transition = 'width 0.3s ease';
            if (this.target.classList.contains('delete-ready')) {
                const deleteButton = this.actionsElement.querySelector('.action-delete');
                if (deleteButton) {
                    const action = deleteButton.dataset.action, id = parseInt(deleteButton.dataset.id, 10);
                    this.container.style.transition = 'transform 0.3s ease, opacity 0.3s ease, max-height 0.3s ease, padding 0.3s ease, margin 0.3s ease';
                    this.container.style.transform = 'translateX(-100%)'; this.container.style.opacity = '0';
                    this.container.style.maxHeight = '0px'; this.container.style.padding = '0'; this.container.style.margin = '0';
                    setTimeout(() => {
                        this.container.remove();
                        if (action === 'deleteSong') Library.deleteSong(id, true);
                        else if (action === 'deletePlaylist') Playlist.delete(id, true);
                    }, 300);
                }
            } else {
                let diff = this.currentX - this.startX;
                if (diff < -60) { this.target.style.transform = `translateX(-${this.initialActionsWidth}px)`; this.actionsElement.style.width = `${this.initialActionsWidth}px`; }
                else { this.target.style.transform = 'translateX(0)'; this.actionsElement.style.width = '0px'; }
            }
            this.target.classList.remove('delete-ready');
        },
        resetAllSwipes(exclude = null) {
            document.querySelectorAll('.list-item-swipe-container').forEach(container => {
                if (container !== exclude) {
                    const innerContent = container.querySelector('.list-item-swipe-inner'); const actions = container.querySelector('.list-item-actions');
                    if (innerContent && actions && innerContent.style.transform !== 'translateX(0px)') {
                        innerContent.style.transition = 'transform 0.3s ease'; actions.style.transition = 'width 0.3s ease';
                        innerContent.style.transform = 'translateX(0)'; actions.style.width = '0';
                    }
                }
            });
        }
    };
    const Player = {
        currentObjectURL: null,
        playSong(id) { const index = app.library.songs.findIndex(s => s.id === id); if (index !== -1) { app.nowPlaying.queue = app.library.songs.map(s => s.id); this.playFromQueue(index); return true; } return false; },
        playAlbum(albumName) { const album = app.library.albums[albumName]; if (album && album.songs.length > 0) { app.nowPlaying.queue = album.songs.map(s => s.id); this.playFromQueue(0); return true; } else { alert("This album is empty."); return false; } },
        playPlaylist(id) { const songs = this.getPlaylistSongs(id); if (songs.length === 0) { alert("This playlist is empty."); return false; } app.nowPlaying.queue = songs.map(s => s.id); this.playFromQueue(0); return true; },
        playFromQueue(index) {
            if (app.nowPlaying.queue.length === 0 || index < 0 || index >= app.nowPlaying.queue.length) { this.stop(); return; }
            const songId = app.nowPlaying.queue[index];
            if (songId === app.nowPlaying.id && DOM.audio.src) { if (app.nowPlaying.currentIndex === index) DOM.audio.currentTime = 0; this.play(); app.nowPlaying.currentIndex = index; return; }
            const song = app.library.songs.find(s => s.id === songId);
            if (song) { app.nowPlaying.currentIndex = index; this.loadAndPlaySong(song); } else this.nextSong();
        },
        loadAndPlaySong(song) {
            if (this.currentObjectURL) URL.revokeObjectURL(this.currentObjectURL);
            app.nowPlaying.id = song.id; this.currentObjectURL = URL.createObjectURL(song.file);
            DOM.audio.src = this.currentObjectURL; DOM.audio.load();
            this.play(); UI.updatePlayerUI(); this.updateMediaSession(song);
        },
        play() {
            if (!app.nowPlaying.id || !DOM.audio.src) return;
            const playPromise = DOM.audio.play();
            if (playPromise !== undefined) playPromise.then(() => { app.nowPlaying.isPlaying = true; UI.updatePlayIcons(); this.updateMediaSession(); }).catch(() => { app.nowPlaying.isPlaying = false; UI.updatePlayIcons(); });
        },
        pause() { DOM.audio.pause(); app.nowPlaying.isPlaying = false; UI.updatePlayIcons(); this.updateMediaSession(); },
        stop() {
            DOM.audio.pause(); DOM.audio.currentTime = 0; DOM.audio.src = '';
            if (this.currentObjectURL) URL.revokeObjectURL(this.currentObjectURL);
            app.nowPlaying.id = null; app.nowPlaying.isPlaying = false; app.nowPlaying.queue = []; app.nowPlaying.currentIndex = -1;
            UI.updatePlayerUI(); this.updateMediaSession();
        },
        togglePlay() { if (!app.nowPlaying.id) return; if (app.nowPlaying.isPlaying) this.pause(); else this.play(); },
        nextSong() {
            if (app.nowPlaying.queue.length === 0) return;
            let nextIndex = app.nowPlaying.currentIndex + 1;
            if (app.nowPlaying.repeatMode === 'queue' && nextIndex >= app.nowPlaying.queue.length) nextIndex = 0;
            else if (nextIndex >= app.nowPlaying.queue.length) { this.stop(); return; }
            this.playFromQueue(nextIndex);
        },
        prevSong() {
            if (app.nowPlaying.queue.length === 0) return;
            if (DOM.audio.currentTime > 3) DOM.audio.currentTime = 0;
            else { const prevIndex = (app.nowPlaying.currentIndex - 1 + app.nowPlaying.queue.length) % app.nowPlaying.queue.length; this.playFromQueue(prevIndex); }
        },
        seek(e) { if (!app.nowPlaying.id || isNaN(DOM.audio.duration)) return; const rect = e.currentTarget.getBoundingClientRect(); DOM.audio.currentTime = DOM.audio.duration * (e.clientX - rect.left) / rect.width; },
        setVolume(e) { const rect = e.currentTarget.getBoundingClientRect(); let volume = (e.clientX - rect.left) / rect.width; DOM.audio.volume = Math.max(0, Math.min(1, volume)); document.getElementById("volume-fill").style.width = `${DOM.audio.volume * 100}%`; },
        updateProgress() {
            if (isNaN(DOM.audio.duration)) return;
            const { currentTime, duration } = DOM.audio;
            document.getElementById("progress-fill").style.width = `${(currentTime / duration) * 100}%`;
            document.getElementById("current-time").textContent = this.formatTime(currentTime);
            document.getElementById("total-time").textContent = this.formatTime(duration);
        },
        formatTime: s => { const rounded = Math.floor(s || 0); return `${Math.floor(rounded/60)}:${(rounded%60).toString().padStart(2,'0')}`; },
        async toggleFavorite() {
            if (!app.nowPlaying.id) return;
            const song = app.library.songs.find(s => s.id === app.nowPlaying.id);
            if (song) {
                song.isFavorite = !song.isFavorite;
                await DB.put("songs", song);
                UI.updateFavoriteButton(song.isFavorite);
            }
        },
        toggleRepeat() { const modes = ['none', 'queue', 'single']; let nextIndex = (modes.indexOf(app.nowPlaying.repeatMode) + 1) % modes.length; this.setRepeatMode(modes[nextIndex]); },
        setRepeatMode(mode) { app.nowPlaying.repeatMode = mode; UI.updateRepeatButton(mode); DOM.audio.loop = (mode === 'single'); },
        shuffle(type, id) {
            let songsToShuffle = [];
            if (type === 'songs') songsToShuffle = [...app.library.songs];
            else if (type === 'album') songsToShuffle = app.library.albums[id]?.songs || [];
            else if (type === 'playlist') songsToShuffle = this.getPlaylistSongs(id);
            if (songsToShuffle.length === 0) { alert("Nothing to shuffle."); return false; }
            for (let i = songsToShuffle.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [songsToShuffle[i], songsToShuffle[j]] = [songsToShuffle[j], songsToShuffle[i]]; }
            app.nowPlaying.queue = songsToShuffle.map(s => s.id); this.playFromQueue(0); return true;
        },
        getPlaylistSongs(id) { if (id === "favorites") return app.library.songs.filter(s => s.isFavorite); const playlist = app.library.playlists.find(p => p.id === parseInt(id)); return playlist ? app.library.songs.filter(s => playlist.songs.includes(s.id)) : []; },
        updateMediaSession(song = app.library.songs.find(s => s.id === app.nowPlaying.id)) {
            if ('mediaSession' in navigator) {
                if (!song) { navigator.mediaSession.metadata = null; navigator.mediaSession.playbackState = 'none'; return; }
                navigator.mediaSession.metadata = new MediaMetadata({ title: song.title, artist: song.artist, album: song.album, artwork: [{ src: song.artwork, sizes: '512x512', type: 'image/png' }] });
                navigator.mediaSession.playbackState = app.nowPlaying.isPlaying ? 'playing' : 'paused';
                navigator.mediaSession.setActionHandler('play', () => Player.togglePlay()); navigator.mediaSession.setActionHandler('pause', () => Player.togglePlay());
                navigator.mediaSession.setActionHandler('previoustrack', () => Player.prevSong()); navigator.mediaSession.setActionHandler('nexttrack', () => Player.nextSong());
            }
        }
    };
    const UI = {
        showLoading: (show) => DOM.loadingOverlay.classList.toggle('active', show),
        showView(viewId, fromPopState = false) {
            // FIX: If the view we are activating is NOT the sub-view,
            // we must remove the swipe listeners to prevent them
            // from interfering from their hidden state.
            if (viewId !== 'sub-view') {
                SwipeList.removeListeners();
            }

            if (viewId === 'library-view') {
                this.renderLibraryView();
            }
            if (!fromPopState) { let hash = viewId.replace('-view', ''); if (viewId === 'player-view') hash = 'playing'; if (window.location.hash !== '#' + hash) history.pushState({ viewId }, '', '#' + hash); }
            DOM.views.forEach(v => v.classList.remove('active'));
            document.getElementById(viewId)?.classList.add('active');
            DOM.appContainer.classList.toggle('player-visible', viewId === 'player-view');
            const viewName = viewId.replace('-view', '');
            document.querySelectorAll('.tab-item').forEach(t => t.classList.toggle('active', t.dataset.view === viewName));
        },
        showSubView(type, id = null, fromPopState = false) {
            if (!fromPopState) { let hash = type; if (id) hash += `/${id}`; if (window.location.hash !== '#' + hash) history.pushState({ type, id }, '', '#' + hash); }
            this.renderSubView(type, id);
            DOM.views.forEach(v => v.classList.remove('active'));
            document.getElementById('sub-view').classList.add('active');
            DOM.appContainer.classList.remove('player-visible');
            document.querySelector('#sub-view .sub-view-scrollable-header-content').scrollTop = 0;
        },
        showModal: (viewId) => { document.getElementById(viewId).classList.add('active'); },
        hideModal: (viewId) => { document.getElementById(viewId).classList.remove('active'); },
        goBack: () => history.back(),
        hideFullPlayer: () => {
            if (document.getElementById('player-view').classList.contains('active')) {
                history.back();
            }
        },
        showConfirmation(title, message, onConfirm) {
            const dialog = document.getElementById('confirm-dialog');
            document.getElementById('confirm-title').textContent = title; document.getElementById('confirm-message').textContent = message;
            const confirmBtn = document.getElementById('confirm-confirm-btn'), cancelBtn = document.getElementById('confirm-cancel-btn');
            const confirmHandler = () => { hide(); onConfirm(); };
            const cancelHandler = () => hide();
            const hide = () => { dialog.classList.add('hidden'); confirmBtn.removeEventListener('click', confirmHandler); cancelBtn.removeEventListener('click', cancelHandler); };
            confirmBtn.addEventListener('click', confirmHandler, { once: true }); cancelBtn.addEventListener('click', cancelHandler, { once: true });
            dialog.classList.remove('hidden');
        },
        updatePlayerUI() {
            const nowPlayingBar = document.getElementById("now-playing-bar");
            if (!app.nowPlaying.id) { nowPlayingBar.classList.remove("active"); return; }
            nowPlayingBar.classList.add("active"); this.updatePlayIcons(); this.updateRepeatButton(app.nowPlaying.repeatMode);
            const song = app.library.songs.find(e => e.id === app.nowPlaying.id);
            if (song) {
                ["np-artwork", "player-artwork"].forEach(e => document.getElementById(e).src = song.artwork);
                const playerTitle = document.getElementById("player-title"), npTitle = document.getElementById("np-title");
                playerTitle.textContent = song.title.replace(" [E]", ""); npTitle.textContent = song.title.replace(" [E]", "");
                playerTitle.classList.toggle("explicit", song.title.includes("[E]")); npTitle.classList.toggle("explicit", song.title.includes("[E]"));
                document.getElementById("player-artist").textContent = song.artist; this.updateFavoriteButton(song.isFavorite); this.updatePlayerBackground(song.artwork);
            }
        },
        updateFavoriteButton(isFavorite) { const favBtn = document.querySelector(".favorite-btn i"); if (favBtn) { favBtn.className = isFavorite ? "fas fa-star" : "far fa-star"; favBtn.parentElement.classList.toggle("favorited", isFavorite) } },
        updatePlayIcons() { const isPlaying = app.nowPlaying.isPlaying; document.getElementById("np-play-icon").className = `fas ${isPlaying?"fa-pause":"fa-play"}`; document.getElementById("main-play-icon").className = `fas ${isPlaying?"fa-pause-circle":"fa-play-circle"}`; },
        updateRepeatButton(mode) { const repeatBtn = document.querySelector('.repeat-btn'), repeatIcon = document.getElementById('repeat-icon'); if (!repeatBtn || !repeatIcon) return; repeatBtn.classList.toggle('active', mode !== 'none'); repeatIcon.className = 'fas'; if (mode === 'single') repeatIcon.classList.add('fa-repeat-1'); else repeatIcon.classList.add('fa-repeat'); },
        updatePlayerBackground(src) { const img = new Image; img.crossOrigin = "Anonymous"; img.src = src; img.onload = () => { const canvas = document.createElement("canvas"), ctx = canvas.getContext("2d"); ctx.drawImage(img, 0, 0, 1, 1); const [r, g, b] = ctx.getImageData(0, 0, 1, 1).data; document.getElementById("player-view").style.backgroundImage = `linear-gradient(to bottom, rgb(${r},${g},${b}) 0%, #000 70%)` }; img.onerror = () => { document.getElementById("player-view").style.backgroundImage = "linear-gradient(to bottom, #222 0%, #000 70%)" } },
        renderAll() { this.renderLibraryView(); },
        renderLibraryView() {
            const container = document.getElementById("library-content"); container.innerHTML = `<div id="library-nav-list"></div><div class="section-header"><h2>Recently Added</h2></div><div class="grid" id="library-recent-grid"></div>`;
            const navList = container.querySelector("#library-nav-list");
            [{type: "playlists", icon: "fa-list-ul", text: "Playlists"}, {type: "artists", icon: "fa-microphone-lines", text: "Artists"}, {type: "albums", icon: "fa-compact-disc", text: "Albums"}, {type: "songs", icon: "fa-music", text: "Songs"}].forEach(item => navList.appendChild(this.createListItem(item)));
            const recentGrid = container.querySelector("#library-recent-grid"), recentSongs = [...app.library.songs].sort((a, b) => b.addedAt - a.addedAt).slice(0, 4);
            recentGrid.innerHTML = ""; const sectionHeader = container.querySelector(".section-header");
            if (recentSongs.length > 0) { sectionHeader.classList.remove("hidden"); recentSongs.forEach(song => recentGrid.appendChild(this.createGridItem(song, "playSong"))); }
            else sectionHeader.classList.add("hidden");
        },
        renderSubView(type, id) {
            // FIX: Always remove swipe listeners first to ensure a clean state
            SwipeList.removeListeners();

            const dynamicHeader = document.querySelector('.sub-view-dynamic-header-elements');
            const mainActionsArea = document.getElementById("sub-view-main-actions-area");
            const contentContainer = document.getElementById("sub-view-content");
            const topActionsContainer = document.getElementById("sub-view-top-actions");

            dynamicHeader.innerHTML = ''; mainActionsArea.innerHTML = ''; contentContainer.innerHTML = ''; topActionsContainer.innerHTML = '';
            contentContainer.dataset.type = type;
            contentContainer.className = 'main-content';

            const backTextMap = { playlistDetail: "Playlists", albumDetail: "Albums", default: "Library" };
            document.querySelector("#sub-view .back-btn span").textContent = backTextMap[type] || backTextMap.default;

            if (type === 'albumDetail' || type === 'playlistDetail') {
                contentContainer.classList.add('has-spacer');
                let title, subtitle, artwork, metaInfo;
                let songs = [];
                
                if (type === 'albumDetail') {
                    const album = app.library.albums[id];
                    if (album) {
                        title = id;
                        subtitle = album.artist;
                        artwork = album.artwork;
                        songs = album.songs;
                        metaInfo = `${songs.length} song${songs.length !== 1 ? 's' : ''}`;
                    }
                } else { // playlistDetail
                    songs = Player.getPlaylistSongs(id);
                    if (id === 'favorites') {
                        title = 'Favorite Songs';
                        subtitle = 'Playlist';
                        artwork = 'FAVORITE';
                    } else {
                        const playlist = app.library.playlists.find(p => p.id === parseInt(id));
                        if(playlist) {
                           title = playlist.name;
                           subtitle = 'Playlist';
                           artwork = playlist.artwork;
                        }
                    }
                    metaInfo = `${songs.length} song${songs.length !== 1 ? 's' : ''}`;
                }

                const artworkHTML = artwork === 'FAVORITE'
                    ? `<div id="favorite-playlist-artwork" class="album-artwork-main"><i class="fas fa-star"></i></div>`
                    : `<img src="${artwork || 'https://via.placeholder.com/240'}" class="album-artwork-main">`;

                const albumHeaderHTML = `
                    <div class="album-header">
                        ${artworkHTML}
                        <h1 class="album-title-main">${title || ''}</h1>
                        <h2 class="album-artist-main">${subtitle || ''}</h2>
                        <p class="album-meta">${metaInfo || ''}</p>
                    </div>`;

                let actionButtonsHTML = '';
                if (songs.length > 0) {
                    const playAction = type === 'albumDetail' ? 'playAlbum' : 'playPlaylist';
                    const playId = type === 'albumDetail' ? id : id;
                    const shuffleId = type === 'albumDetail' ? id : id;
                    actionButtonsHTML = `
                        <div class="action-buttons" style="padding: 10px 0 15px 0;">
                            <button class="action-btn" data-action="${playAction}" data-${type === 'albumDetail' ? 'album' : 'id'}="${playId}"><i class="fas fa-play"></i>Play</button>
                            <button class="action-btn" data-action="shuffle" data-type="${type === 'albumDetail' ? 'album' : 'playlist'}" data-id="${shuffleId}"><i class="fas fa-shuffle"></i>Shuffle</button>
                        </div>
                    `;
                }
                
                contentContainer.innerHTML = albumHeaderHTML + actionButtonsHTML;
                this.renderNumberedSongList(contentContainer, songs);

            } else {
                const titles = { playlists: "Playlists", artists: "Artists", albums: "Albums", songs: "Songs" };
                dynamicHeader.innerHTML = `
                    <div class="header large-title" id="sub-view-large-title-area"><h1>${titles[type] || ''}</h1></div>
                    <div class="search-bar" id="sub-view-search-bar-area"><input type="text" class="search-input" data-type="${type}" ${id ? `data-id="${id}"` : ''} placeholder="Search"><i class="fas fa-microphone search-input-mic"></i></div>
                    <div class="action-buttons" id="sub-view-main-actions-area"></div>`;
                
                const renderers = { playlists: this.renderPlaylistsView, artists: this.renderArtistsView, albums: this.renderAlbumsView, songs: this.renderSongsView };
                if (renderers[type]) {
                    renderers[type].call(this, contentContainer, id);
                    // FIX: Only add swipe listeners for views that need them
                    if (type === 'playlists' || type === 'songs') {
                        SwipeList.addListeners();
                    }
                }
                 if (type === "playlists") {
                    topActionsContainer.innerHTML = '<button class="icon-btn" data-action="openCreatePlaylistModal"><i class="fas fa-plus"></i></button>';
                }
                if (type === 'songs' && app.library.songs.length > 0) {
                    const mainActionsArea = document.getElementById('sub-view-main-actions-area');
                    if (mainActionsArea) {
                        mainActionsArea.innerHTML = `
                            <button class="action-btn" data-action="playSong" data-id="${app.library.songs[0].id}"><i class="fas fa-play"></i> Play</button>
                            <button class="action-btn" data-action="shuffle" data-type="songs"><i class="fas fa-shuffle"></i> Shuffle</button>
                        `;
                    }
                }
            }
        },
        renderNumberedSongList(container, songs) {
            if (songs.length === 0) { container.innerHTML += '<p class="empty-state">No songs found.</p>'; return; }
            songs.forEach((song, index) => {
                const item = document.createElement('div');
                item.className = 'album-song-item';
                item.dataset.action = 'playSong';
                item.dataset.id = song.id;
                const isExplicit = song.title && song.title.includes('[E]');
                const displayTitle = isExplicit ? song.title.replace(' [E]','') : song.title;
                item.innerHTML = `
                    <span class="album-song-track-number">${index + 1}</span>
                    <span class="album-song-title ${isExplicit ? 'explicit' : ''}">${displayTitle}</span>`;
                container.appendChild(item);
            });
        },
        renderPlaylistSelector() { const list = document.getElementById("playlist-selector-list"); list.innerHTML = ""; app.library.playlists.forEach(playlist => { const item = document.createElement("div"); item.className = "list-item"; item.dataset.action = "selectPlaylist"; item.dataset.id = playlist.id; item.innerHTML = `<div class="list-icon"><i class="fas fa-list-ul"></i></div><div class="list-text">${playlist.name}</div>`; list.appendChild(item); }) },
        renderPlaylistsView(container) { const fragment = document.createDocumentFragment(); fragment.appendChild(this.createPlaylistItem({ id: "favorites", name: "Favorite Songs", artwork: "FAVORITE", songs: [] })); app.library.playlists.forEach(p => fragment.appendChild(this.createPlaylistItem(p))); container.appendChild(fragment) },
        renderPlaylistDetailView(container, playlistId) { this.renderNumberedSongList(container, Player.getPlaylistSongs(playlistId)); },
        renderAlbumDetailView(container, albumName) { const album = app.library.albums[albumName]; this.renderNumberedSongList(container, album ? album.songs : []); },
        renderArtistsView(container) { const artists = Object.keys(app.library.artists).sort(); if (artists.length === 0) return container.innerHTML += '<p class="empty-state">No artists found.</p>'; artists.forEach(artistName => container.appendChild(this.createArtistListItem(artistName, app.library.artists[artistName][0].artwork))) },
        renderAlbumsView(container) {
            const albums = Object.keys(app.library.albums).sort();
            if (albums.length === 0) {
                container.innerHTML += '<p class="empty-state">No albums found.</p>';
                return;
            }
            const grid = document.createElement("div");
            grid.className = "grid";
            albums.forEach(albumName => grid.appendChild(this.createGridItem(app.library.albums[albumName], "showSubView", albumName)));
            container.appendChild(grid);
        },
        renderSongsView(container) {
            const songs = app.library.songs;
            if (songs.length === 0) {
                container.innerHTML += '<p class="empty-state">No songs found.</p>';
                return;
            }
            songs.forEach(song => container.appendChild(this.createSongListItem(song)));
        },
        createListItem(item) { const el = document.createElement("div"); el.className = "list-item"; el.dataset.action = "showSubView"; el.dataset.type = item.type; el.innerHTML = `<div class="list-icon"><i class="fas ${item.icon}"></i></div><div class="list-text">${item.text}</div><div class="list-arrow"><i class="fas fa-chevron-right"></i></div>`; return el },
        createPlaylistItem(playlist) {
            const songCount = playlist.id === "favorites" ? app.library.songs.filter(s => s.isFavorite).length : playlist.songs.length;
            const itemHTML = `<div class="playlist-item" data-action="showSubView" data-type="playlistDetail" data-id="${playlist.id}"><div class="playlist-item-artwork" ${playlist.artwork==="FAVORITE"?'id="favorite-playlist-artwork"':`style="background-image:url(${playlist.artwork||'https://via.placeholder.com/150?text=Art'})"`}>${playlist.artwork==="FAVORITE"?'<i class="fas fa-star"></i>':''}</div><div class="playlist-info"><div class="playlist-title">${playlist.name}</div><div class="playlist-subtitle">${songCount} song${songCount!==1?'s':''}</div></div><div class="list-arrow"><i class="fas fa-chevron-right"></i></div></div>`;
            const wrapper = document.createElement("div"); wrapper.className = "list-item-swipe-container";
            wrapper.innerHTML = `<div class="list-item-swipe-inner"><div class="list-item-swipe-content playlist-swipe-content">${itemHTML}</div></div>${playlist.id!=="favorites" ? `<div class="list-item-actions"><button class="list-action-btn action-edit" data-action="renamePlaylist" data-id="${playlist.id}"><i class="fas fa-pen"></i></button><button class="list-action-btn action-delete" data-action="deletePlaylist" data-id="${playlist.id}"><i class="fas fa-trash"></i></button></div>` : ''}`;
            return wrapper;
        },
        createArtistListItem(name, artwork) { const el = document.createElement("div"); el.className = "list-item"; el.innerHTML = `<div class="list-icon"><img src="${artwork}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;"></div><div class="list-text">${name}</div><div class="list-arrow"><i class="fas fa-chevron-right"></i></div>`; return el },
        createGridItem(item, action, id) {
            const el = document.createElement("div"); el.className = "grid-item"; el.dataset.action = action;
            if (action === "playSong") { el.dataset.id = item.id; el.innerHTML = `<img src="${item.artwork}" alt="${item.album}"><div class="grid-item-title">${item.title}</div><div class="grid-item-subtitle">${item.artist}</div>` }
            else if (action === "showSubView") { el.dataset.type = "albumDetail"; el.dataset.id = id; const songCount = item.songs.length; el.innerHTML = `<img src="${item.artwork}" alt="${id}"><div class="grid-item-title">${id}</div><div class="grid-item-subtitle">${item.artist} â€¢ ${songCount} song${songCount!==1?'s':''}</div>` }
            return el
        },
        createSongListItem(song) {
            const wrapper = document.createElement("div");
            wrapper.className = "list-item-swipe-container";
            const artworkUrl = song.artwork || 'https://via.placeholder.com/44?text=Art';
            const title = song.title || 'Unknown Title';
            const artist = song.artist || 'Unknown Artist';
            const isExplicit = song.title && song.title.includes('[E]');
            const displayTitle = isExplicit ? title.replace(' [E]','') : title;

            wrapper.innerHTML = `
                <div class="list-item-swipe-inner">
                    <div class="list-item-swipe-content">
                        <div class="song-list-artwork" style="background-image: url('${artworkUrl}'); background-size: cover; background-position: center;"></div>
                        <div class="song-list-info-content" data-action="playSong" data-id="${song.id}">
                            <div class="song-list-info">
                                <span class="song-list-title ${isExplicit ? 'explicit' : ''}">${displayTitle}</span>
                                <span class="song-list-artist">${artist}</span>
                            </div>
                            <i class="fas fa-chevron-right list-arrow"></i>
                        </div>
                    </div>
                </div>
                <div class="list-item-actions">
                    <button class="list-action-btn action-edit" data-action="editSong" data-id="${song.id}"><i class="fas fa-pen"></i></button>
                    <button class="list-action-btn action-delete" data-action="deleteSong" data-id="${song.id}"><i class="fas fa-trash"></i></button>
                </div>`;
            return wrapper;
        },
        handleSearch(e) {
            const query = e.target.value.toLowerCase(), resultsContainer = document.getElementById("search-results-container"), categoriesContainer = document.getElementById("search-categories");
            resultsContainer.classList.toggle("hidden", query.length < 2); categoriesContainer.classList.toggle("hidden", query.length >= 2);
            if (query.length < 2) return; resultsContainer.innerHTML = "";
            const results = app.library.songs.filter(song => song.title.toLowerCase().includes(query) || song.artist.toLowerCase().includes(query) || song.album.toLowerCase().includes(query));
            if (results.length === 0) resultsContainer.innerHTML = '<p class="empty-state">No Results</p>'; else results.forEach(song => resultsContainer.appendChild(this.createSongListItem(song)))
        },
        handleSubViewSearch(e) {
            const query = e.target.value.toLowerCase();
            const contentContainer = document.getElementById('sub-view-content');
            if (!contentContainer) return;

            const items = contentContainer.querySelectorAll(".list-item, .list-item-swipe-container, .grid-item, .album-song-item");
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(query) ? "" : "none";
            });
        },
    };
    init();
});
</script>
</body>
</html>
