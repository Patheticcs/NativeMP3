<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <title>NativeMP3</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="theme-color" content="#000000">
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
  <style>
@import url('https://fonts.googleapis.com/css2?family=Cabinet+Grotesk:wght@300;400;500;600;700&display=swap');

:root {
    /* Design System */
    --spacing-base: 8px;
    --spacing-unit: var(--spacing-base);
    --spacing-xs: calc(var(--spacing-unit) * 1.25);
    --spacing-sm: calc(var(--spacing-unit) * 2);
    --spacing-md: calc(var(--spacing-unit) * 3);
    --spacing-lg: calc(var(--spacing-unit) * 4.5);
    --border-radius-sharp: 3px;
    --border-radius-soft: 9px;
    --border-radius-round: 16px;
    --border-radius-pill: 35px;
    --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-std: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    --glass-blur-intense: 15px;

    /* Colors */
    --primary-text-color: #fdfdfd;
    --secondary-text-color: #c8c8c8;
    --muted-text-color: #858585;
    --border-color-strong: rgba(255, 255, 255, 0.09);
    --border-color-subtle: rgba(255, 255, 255, 0.04);
    --background-color-page: #000000;
    --glass-base-bg: rgba(12, 12, 12, 0.4);
    --glass-highlight-bg: rgba(22, 22, 22, 0.6);
    --glass-shadow: 0 10px 35px rgba(0, 0, 0, 0.45);
    --interactive-hover-bg: rgba(255, 255, 255, 0.025);
    --interactive-active-bg: rgba(255, 255, 255, 0.045);
    --accent-glow-color: rgba(255, 255, 255, 0.07);
    --input-bg: rgba(255, 255, 255, 0.04);
    --input-border: rgba(255, 255, 255, 0.08);
    --button-primary-bg: #fdfdfd;
    --button-primary-text: #030303;
    --button-primary-hover-bg: #e3e3e3;
    --primary-accent: #f1f1f1;

    /* App-specific variables (mapped) */
    --system-red: #da3e3e;
    --system-pink: var(--primary-accent);
    --system-gray: var(--muted-text-color);
    --system-gray-2: var(--secondary-text-color);
    --system-gray-6: #101010;
    --fill-tertiary: var(--input-bg);
    --border-color: var(--border-color-strong);
    --safe-area-top: env(safe-area-inset-top, 20px);
    --safe-area-bottom: env(safe-area-inset-bottom, 0px);
    --tab-bar-height: 50px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: "Cabinet Grotesk", sans-serif;
    scroll-behavior: smooth;
    -webkit-tap-highlight-color: transparent;
}

html,
body {
    overflow: hidden;
    width: 100%;
}

body {
    background-color: var(--background-color-page);
    color: var(--primary-text-color);
    line-height: 1.5;
    font-size: 14.5px;
    -webkit-font-smoothing: antialiased;
    padding-top: var(--safe-area-top);
    display: flex;
    flex-direction: column;
    height: calc(100vh - var(--safe-area-top));
}

.app-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
}

.view {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    background: var(--background-color-page);
    z-index: 10;
}

.view.active {
    opacity: 1;
    visibility: visible;
    z-index: 20;
}

.header {
    padding: var(--spacing-sm) var(--spacing-md) var(--spacing-md);
    flex-shrink: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header.large-title h1 {
    font-size: clamp(1.8rem, 5vw, 2.4rem);
    font-weight: 700;
    color: var(--primary-text-color);
    letter-spacing: -0.035em;
    padding-left: var(--spacing-sm);
}

.header-profile-icon {
    width: 40px;
    height: 40px;
    background: var(--interactive-active-bg);
    color: var(--primary-accent);
    border: 1px solid var(--border-color-subtle);
    border-radius: 50%;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.header-actions .round-btn {
    width: 40px;
    height: 40px;
    background: var(--interactive-active-bg);
    color: var(--primary-accent);
    border: 1px solid var(--border-color-subtle);
    border-radius: 50%;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition-fast);
}
.header-actions .round-btn:hover {
    background-color: var(--interactive-hover-bg);
    border-color: var(--border-color-strong);
    transform: scale(1.02);
}


.header-with-back {
    padding: var(--spacing-sm) var(--spacing-sm) var(--spacing-sm);
    background: rgba(12,12,12,0.6);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    border-bottom: 1px solid var(--border-color-subtle);
}

.header-with-back .back-btn {
    font-size: 1rem;
    color: var(--primary-text-color);
    background: transparent;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border-radius: var(--border-radius-pill);
    transition: var(--transition-fast);
}

.header-with-back .back-btn:hover {
    background-color: var(--interactive-hover-bg);
}

.header-with-back h1 {
    font-size: 1.1rem;
    font-weight: 600;
    flex: 1;
    text-align: center;
    margin: 0;
    padding-right: 50px; /* Balance out the back button */
}

.header-actions { display: flex; gap: 15px; min-width: 40px; justify-content: flex-end; align-items: center; }
.header-actions .icon-btn { background: none; border: none; color: var(--primary-accent); font-size: 1.2rem; cursor: pointer; }


.main-content {
    flex: 1;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--muted-text-color) transparent;
    padding-bottom: calc(var(--tab-bar-height) + var(--spacing-lg) + 50px);
}

.main-content::-webkit-scrollbar {
    width: 6px;
}
.main-content::-webkit-scrollbar-thumb {
    background-color: var(--muted-text-color);
    border-radius: var(--border-radius-pill);
}


.search-bar {
    padding: var(--spacing-sm) var(--spacing-md);
    position: relative;
}

.search-input {
    width: 100%;
    background-color: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: var(--border-radius-pill);
    color: var(--primary-text-color);
    padding: var(--spacing-sm) 40px var(--spacing-sm) 45px;
    font-size: 1rem;
    outline: none;
    transition: var(--transition-fast);
    background-image: none;
    height: 44px;
}
.search-input::placeholder { color: var(--muted-text-color); }
.search-input:focus {
    border-color: var(--primary-accent);
    box-shadow: 0 0 0 2.5px var(--accent-glow-color);
}
.search-bar::before {
    content: "\f002";
    font-family: "Font Awesome 6 Free";
    font-weight: 900;
    position: absolute;
    left: calc(var(--spacing-md) + 15px);
    top: 50%;
    transform: translateY(-50%);
    color: var(--secondary-text-color);
    font-size: 1.1rem;
    pointer-events: none;
}
.search-input-mic {
    position: absolute;
    right: calc(var(--spacing-md) + 15px);
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted-text-color);
    font-size: 16px;
}
.sub-view-dynamic-header-elements .search-bar { padding: 0 var(--spacing-md) var(--spacing-sm); }
.sub-view-dynamic-header-elements .search-bar::before { left: calc(var(--spacing-md) + 15px); }


.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-lg) var(--spacing-md) var(--spacing-sm);
}
.section-header h2 {
    font-size: clamp(1.3rem, 4vw, 1.8rem);
    font-weight: 600;
    letter-spacing: -0.02em;
}


.action-buttons {
    display: flex;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm) var(--spacing-md) var(--spacing-lg);
}
.action-btn {
    flex: 1;
    background-color: var(--button-primary-bg);
    border: 1px solid transparent;
    border-radius: var(--border-radius-pill);
    color: var(--button-primary-text);
    padding: var(--spacing-sm) var(--spacing-md);
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-std);
    box-shadow: 0 5px 18px rgba(0, 0, 0, 0.25);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-sm);
    min-height: 44px;
}
.action-btn:hover { background-color: var(--button-primary-hover-bg); transform: translateY(-2px); }


.list-item {
    display: flex;
    align-items: center;
    padding: var(--spacing-xs) var(--spacing-md);
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: var(--transition-fast);
}
.list-item:hover { background-color: var(--interactive-hover-bg); }
.list-item:first-child { border-top: 1px solid var(--border-color); }
.list-icon { color: var(--primary-accent); width: 40px; height: 40px; font-size: 18px; margin-right: 15px; display: flex; align-items: center; justify-content: center; background: var(--input-bg); border-radius: var(--border-radius-soft); }
.list-text { flex: 1; font-size: 1rem; }
.list-arrow { color: var(--muted-text-color); }

.list-item-swipe-container { position: relative; overflow: hidden; margin: 0 var(--spacing-md); }
.list-item-swipe-inner { display: flex; width: 100%; transform: translateX(0); transition: transform 0.3s ease; will-change: transform; position: relative; z-index: 2; background-color: var(--glass-base-bg); border: 1px solid var(--border-color-subtle); border-radius: var(--border-radius-round); }
.list-item-swipe-content { flex-shrink: 0; width: 100%; display: flex; align-items: center; padding: var(--spacing-sm); }
.playlist-swipe-content .playlist-item { border: none; padding: 0; background: none; }
.list-item-swipe-container + .list-item-swipe-container { margin-top: var(--spacing-sm); }
.list-item-actions { position: absolute; top: 0; right: 0; height: 100%; display: flex; z-index: 1; border-radius: var(--border-radius-round); overflow:hidden;}
.list-action-btn { height: 100%; padding: 0; width: 80px; color: #fff; border: none; font-size: 1.1rem; cursor: pointer; }
.action-delete { background: var(--system-red); }
.action-edit { background: var(--muted-text-color); }

.song-list-artwork { width: 48px; height: 48px; border-radius: var(--border-radius-sharp); margin-right: 15px; background-size: cover; background-position: center; background-color: var(--system-gray-6); }
.song-list-info { flex: 1; }
.song-list-title { font-size: 1rem; font-weight: 500; }
.song-list-artist { font-size: 0.8rem; color: var(--secondary-text-color); }

.grid {
    display: grid;
    gap: var(--spacing-md);
    padding: 0 var(--spacing-md);
}

#library-recent-grid {
    grid-auto-flow: column;
    grid-auto-columns: minmax(150px, 1fr);
    overflow-x: auto;
    padding: var(--spacing-xs) var(--spacing-md) var(--spacing-md);
    -webkit-overflow-scrolling: touch;
}
#library-recent-grid::-webkit-scrollbar { display: none; }

#sub-view .main-content .grid,
#search-view .search-category-grid {
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    padding: 0 var(--spacing-md);
}
.grid-item { cursor: pointer; overflow: hidden; }
.grid-item img { display: block; width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: var(--border-radius-soft); background-color: var(--system-gray-6); margin-bottom: 5px; border: 1px solid var(--border-color-subtle); }
.grid-item-title { font-size: 0.9rem; font-weight: 500; line-height: 1.3; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; min-height: calc(1.3em * 2); }
.grid-item-subtitle { font-size: 0.8rem; color: var(--muted-text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.playlist-item { display: flex; align-items: center; width: 100%; cursor: pointer; padding: 0; border: none; }
.playlist-item-artwork { width: 54px; height: 54px; border-radius: var(--border-radius-soft); margin-right: 15px; display: flex; align-items: center; justify-content: center; background-color: var(--system-gray-6); background-size: cover; background-position: center; border: 1px solid var(--border-color-subtle); }
#favorite-playlist-artwork { background-image: linear-gradient(135deg, #f0f0f0, #c0c0c0); color: #1a1a1a; }
.playlist-info { flex: 1; }
.playlist-title { font-size: 1rem; }
.playlist-subtitle { font-size: 0.8rem; color: var(--muted-text-color); }
.category-item { position: relative; cursor: pointer; border-radius: var(--border-radius-soft); overflow:hidden; }
.category-item img { width: 100%; display: block; aspect-ratio: 1.8/1; object-fit: cover; }
.category-item::before { content: ''; position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent 60%); }
.category-item .category-title { position: absolute; bottom: 12px; left: 12px; font-size: 1rem; font-weight: 600; color: #fff; }


.tab-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(18, 18, 18, 0.7);
    backdrop-filter: blur(var(--glass-blur-intense));
    -webkit-backdrop-filter: blur(var(--glass-blur-intense));
    display: flex;
    justify-content: space-around;
    padding: 6px 0 var(--safe-area-bottom);
    border-top: 1px solid var(--border-color-strong);
    z-index: 500;
}
.tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; cursor: pointer; color: var(--muted-text-color); padding: 4px 0; transition: var(--transition-fast); }
.tab-item.active { color: var(--primary-accent); }
.tab-icon { font-size: 1.3rem; margin-bottom: 2px; }
.tab-label { font-size: 0.6rem; font-weight: 500; }

.now-playing-bar {
    position: fixed;
    bottom: calc(var(--tab-bar-height) + var(--spacing-sm) + var(--safe-area-bottom));
    left: var(--spacing-md);
    right: var(--spacing-md);
    background: var(--glass-highlight-bg);
    backdrop-filter: blur(10px);
    padding: var(--spacing-xs);
    border-radius: var(--border-radius-round);
    display: none;
    align-items: center;
    cursor: pointer;
    z-index: 600;
    transform: translateY(0);
    transition: transform 0.4s ease-in-out;
    border: 1px solid var(--border-color-strong);
}
.now-playing-bar.active { display: flex; }
.app-container.player-visible .now-playing-bar { display: none; }
.now-playing-artwork { width: 40px; height: 40px; border-radius: var(--border-radius-soft); object-fit: cover; margin-right: 12px; }
.now-playing-info { flex: 1; font-size: 0.9rem; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.now-playing-controls { display: flex; align-items: center; gap: 15px; }
.now-playing-btn { background: none; border: none; color: #fff; font-size: 1.1rem; cursor: pointer; }


#player-view {
    background: #000;
    --player-bg-color: #222;
    background-image: linear-gradient(to bottom, var(--player-bg-color) 0%, #000 70%);
}
#player-view .main-content { padding: 0 var(--spacing-lg) var(--safe-area-bottom); justify-content: space-evenly; }
#player-view .header-with-back { background: transparent; border: none; }
.player-artwork { width: 100%; aspect-ratio: 1/1; border-radius: var(--border-radius-round); box-shadow: var(--glass-shadow); background-color: var(--system-gray-6); }
.player-info-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm); }
.player-details .title { font-size: clamp(1.4rem, 4vw, 1.8rem); font-weight: 700; line-height: 1.2; }
.player-details .artist { font-size: clamp(1.1rem, 3vw, 1.4rem); color: var(--secondary-text-color); }
.progress-container { margin-bottom: var(--spacing-xs); }
.progress-bar, .volume-slider { height: 8px; background: rgba(255,255,255,0.2); border-radius: var(--border-radius-pill); cursor: pointer; }
.progress-fill, #volume-fill { background: #fff; }
.progress-times { font-size: 0.75rem; color: var(--muted-text-color); margin-top: 5px; }
.player-controls { margin: var(--spacing-md) 0; justify-content: space-between;}
.control-btn { font-size: 2rem; }
.control-btn.main { font-size: 4rem; }
.volume-container i { color: var(--muted-text-color); }
.player-extra-controls { margin: var(--spacing-md) 0 var(--spacing-lg); }
.player-extra-controls .control-btn { font-size: 1.3rem; color: var(--muted-text-color); }
.player-extra-controls .repeat-btn.active { color: var(--primary-accent); }


.song-list-title.explicit::after,
.player-details .title.explicit::after {
    content: 'E'; font-size: 0.7rem; font-weight: 600; background: rgba(255,255,255,0.2);
    color: #fff; padding: 2px 5px; border-radius: var(--border-radius-sharp); margin-left: 8px;
}


.modal-view { background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); }
.modal-form-container { padding: var(--spacing-lg) var(--spacing-md); }
.modal-artwork-preview { width: 120px; height: 120px; background-color: var(--input-bg); border: 2px dashed var(--input-border); border-radius: var(--border-radius-round); margin: 0 auto 15px; }
.form-group input, .form-group button { background: var(--input-bg); border: 1px solid var(--input-border); border-radius: var(--border-radius-soft); padding: var(--spacing-sm); font-size: 1rem; color: #fff; }
.form-group input:focus { border-color: var(--primary-accent); box-shadow: 0 0 0 3px var(--accent-glow-color); }
.form-group button { background: var(--button-primary-bg); color: var(--button-primary-text); cursor: pointer; font-weight: 600; }
.form-group .secondary-btn { background: var(--input-bg); color: var(--primary-text-color); border-color: var(--border-color-strong); }

/* Confirmation Dialog */
.confirm-dialog-overlay { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px); }
.confirm-dialog { background: var(--glass-highlight-bg); border: 1px solid var(--border-color-strong); border-radius: var(--border-radius-round); width: 280px; box-shadow: var(--glass-shadow); }
.confirm-dialog-content { padding: var(--spacing-md) var(--spacing-md) 0; }
.confirm-dialog-message { margin: 4px 0 20px; }
.confirm-dialog-actions { border-top: 1px solid var(--border-color-subtle); }
.confirm-dialog-actions button { color: var(--primary-accent); font-size: 1rem; padding: 12px 0; }
.confirm-dialog-actions button:first-child { border-right: 1px solid var(--border-color-subtle); color: var(--secondary-text-color); }
.confirm-dialog-actions .confirm-btn { color: var(--system-red); font-weight: 600; }


.upload-song-list-container { gap: var(--spacing-md); }
.upload-song-item { padding: var(--spacing-sm); background: rgba(255,255,255,0.04); border-radius: var(--border-radius-round); }


#sub-view .main-content { padding-bottom: calc(var(--tab-bar-height) + var(--spacing-lg)); }

.album-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-lg) var(--spacing-md);
}

.album-artwork-main {
    width: 65%;
    max-width: 250px;
    aspect-ratio: 1/1;
    border-radius: var(--border-radius-round);
    margin-bottom: var(--spacing-sm);
    background-color: var(--system-gray-6);
    object-fit: cover;
    box-shadow: var(--glass-shadow);
}
.album-header #favorite-playlist-artwork.album-artwork-main { display: flex; align-items: center; justify-content: center; background-image: linear-gradient(135deg, #f0f0f0, #c0c0c0); color: #1a1a1a; }
.album-header #favorite-playlist-artwork.album-artwork-main .fa-star { font-size: 3rem; }

.album-title-main { font-size: 1.8rem; font-weight: 700; line-height: 1.2; }
.album-artist-main { font-size: 1.2rem; color: var(--system-red); font-weight: 400; }
.album-meta { font-size: 0.9rem; color: var(--muted-text-color); }

.album-song-item {
    display: flex; align-items: center; padding: var(--spacing-sm) 0; margin: 0 var(--spacing-md); border-bottom: 1px solid var(--border-color); cursor: pointer; gap: 15px; transition: var(--transition-fast);
}
.album-song-item:hover { background-color: rgba(255,255,255,0.04); border-radius: var(--border-radius-soft); padding: var(--spacing-sm); }
.album-song-item:last-child { border-bottom: none; }
.album-song-track-number { color: var(--muted-text-color); font-size: 1rem; width: 25px; text-align: center; }
.album-song-title { flex: 1; font-size: 1rem; }


@media (min-width: 768px) {
    .album-header {
        flex-direction: row;
        text-align: left;
        align-items: flex-end;
    }
    .album-artwork-main {
        flex-shrink: 0;
    }
}

.spinner {
    width: 40px; height: 40px;
    border-radius: 50%;
    border: 4px solid var(--border-color-strong);
    border-top-color: var(--primary-accent);
    animation: spin 1s ease-in-out infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="app-container">
    <div id="home-view" class="view"><div class="header large-title"><h1>Home</h1></div></div>
    <div id="new-view" class="view"><div class="header large-title"><h1>New</h1></div></div>
    <div id="radio-view" class="view"><div class="header large-title"><h1>Radio</h1></div></div>
    <div id="library-view" class="view">
        <div class="header large-title"><h1>Library</h1><div class="header-actions"><button class="round-btn header-plus-btn" data-action="openUploadModal"><i class="fas fa-plus"></i></button><div class="header-profile-icon"><i class="fas fa-user"></i></div></div></div>
        <div class="main-content" id="library-content"></div>
    </div>
    <div id="sub-view" class="view">
        <div class="header-fixed-top-bar">
            <button class="back-btn" data-action="goBack"><i class="fas fa-arrow-left"></i> <span id="back-btn-text">Library</span></button>
            <div class="header-actions" id="sub-view-top-actions"></div>
        </div>
        <div class="sub-view-scrollable-header-content">
            <div class="sub-view-dynamic-header-elements">
                <div class="header large-title" id="sub-view-large-title-area"></div>
                <div class="search-bar" id="sub-view-search-bar-area"></div>
                <div class="action-buttons" id="sub-view-main-actions-area"></div>
            </div>
            <div class="main-content" id="sub-view-content"></div>
        </div>
    </div>
    <div id="search-view" class="view">
      <div class="header large-title"><h1>Search</h1><div class="header-profile-icon"><i class="fas fa-user"></i></div></div>
      <div class="main-content">
        <div class="search-bar"><input type="text" class="search-input" id="search-input" placeholder="Artists, Songs, and Albums"><i class="fas fa-microphone search-input-mic"></i></div>
        <div id="search-results-container" class="hidden"></div>
        <div id="search-categories">
            <div class="section-header"><h2>Browse Categories</h2></div>
            <div class="search-category-grid">
                <div class="category-item" data-color="red"><img src="https://images.unsplash.com/photo-1516450360452-9312f5e86fc7?w=400&auto=format&fit=crop" alt=""><span class="category-title">Set Lists</span></div>
                <div class="category-item" data-color="red"><img src="https://images.unsplash.com/photo-1525362083236-02439a1d1478?w=400&auto=format&fit=crop" alt=""><span class="category-title">Alternative</span></div>
            </div>
          </div>
      </div>
    </div>
    <div id="upload-view" class="modal-view view">
        <div class="header header-with-back">
            <button class="back-btn" data-action="closeUploadModal">Cancel</button>
            <h1 style="text-align: center;">Add Music</h1>
            <div class="header-actions" style="min-width: 60px;"><button class="back-btn" data-action="submitUpload">Done</button></div>
        </div>
        <div class="main-content">
            <form class="modal-form-container" id="upload-form">
                <div id="upload-song-list" class="upload-song-list-container">
                </div>
                <div class="form-group" id="song-file-selector-group">
                    <button type="button" class="secondary-btn" data-action="triggerSongUpload">Select Song File(s)</button>
                    <span id="song-file-name" style="color: var(--system-gray); font-size: 14px; margin-top: 8px; text-align: center;"></span>
                    <input type="file" id="music-file-input" class="hidden" accept=".mp3" multiple>
                </div>
                <div class="form-group">
                    <button type="button" class="secondary-btn" data-action="openPlaylistSelector">Add to Playlist (Optional)</button>
                    <span id="selected-playlist-name" style="color: var(--system-gray); font-size: 14px; margin-top: 8px; text-align: center;">No playlist selected.</span>
                </div>
            </form>
        </div>
    </div>
    <div id="playlist-selector-view" class="modal-view view select-playlist-modal">
        <div class="header header-with-back">
            <button class="back-btn" data-action="closePlaylistSelector">Back</button>
            <h1 style="text-align: center;">Select Playlist</h1>
            <div class="header-actions" style="min-width: 60px;"></div>
        </div>
        <div class="main-content" id="playlist-selector-list"></div>
    </div>
    <div id="create-playlist-view" class="modal-view view">
        <div class="header header-with-back">
            <button class="back-btn" data-action="closeCreatePlaylistModal">Cancel</button>
            <h1 style="text-align: center;">New Playlist</h1>
            <div class="header-actions" style="min-width: 60px;"><button class="back-btn" data-action="submitCreatePlaylist">Done</button></div>
        </div>
        <div class="main-content">
            <form class="modal-form-container" id="create-playlist-form">
                <div class="modal-artwork-section"><img id="playlist-artwork-preview" class="modal-artwork-preview" src="https://via.placeholder.com/150?text=Artwork" data-action="triggerPlaylistArtworkUpload" alt="Playlist Artwork Preview"><input type="file" id="playlist-artwork-input" class="hidden" accept="image/*"></div>
                <div class="form-group"><label for="playlist-name-input">PLAYLIST NAME</label><input type="text" id="playlist-name-input" required></div>
            </form>
        </div>
    </div>
    <div id="player-view" class="view">
        <div class="header header-with-back">
            <button class="back-btn" data-action="hideFullPlayer"><i class="fas fa-chevron-down"></i></button>
            <h1 class="player-header-title">Now Playing</h1>
            <div style="width: 40px; height: 100%;"></div>
        </div>
        <div class="main-content">
            <div class="player-artwork-container">
                <img id="player-artwork" class="player-artwork" src="" alt="">
            </div>
            <div>
                <div class="player-info-container">
                    <div class="player-details"><div id="player-title" class="title">Not Playing</div><div id="player-artist" class="artist"></div></div>
                    <button class="round-btn favorite-btn" data-action="toggleFavorite"><i class="far fa-star"></i></button>
                </div>
                <div class="progress-container" data-action="seek"><div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div><div class="progress-times"><span id="current-time">0:00</span><span id="total-time">0:00</span></div></div>
                <div class="player-controls">
                  <button class="control-btn" data-action="prevSong"><i class="fas fa-backward-step"></i></button>
                  <button class="control-btn main" data-action="togglePlay"><i id="main-play-icon" class="fas fa-play-circle"></i></button>
                  <button class="control-btn" data-action="nextSong"><i class="fas fa-forward-step"></i></button></div>
                <div class="volume-container">
                  <i class="fas fa-volume-down"></i><div class="volume-slider" data-action="setVolume"><div class="progress-fill" id="volume-fill" style="width: 50%;"></div></div><i class="fas fa-volume-up"></i></div>
                <div class="player-extra-controls">
                  <button class="control-btn"><i class="fas fa-comment-dots"></i></button>
                  <button class="control-btn repeat-btn" data-action="toggleRepeat"><i id="repeat-icon" class="fas fa-repeat"></i></button>
                  <button class="control-btn"><i class="fas fa-list-ul"></i></button>
                </div>
            </div>
        </div>
    </div>
    <div class="now-playing-bar" id="now-playing-bar" data-action="showFullPlayer">
      <img id="np-artwork" class="now-playing-artwork" src="" alt=""><div id="np-title" class="now-playing-info">Not Playing</div>
      <div class="now-playing-controls">
        <button class="now-playing-btn" data-action="togglePlay"><i id="np-play-icon" class="fas fa-play"></i></button>
        <button class="now-playing-btn" data-action="nextSong"><i class="fas fa-forward-step"></i></button>
      </div>
    </div>
  </div>
  <div class="tab-bar">
    <div class="tab-item" data-action="showView" data-view="home"><i class="fas fa-house tab-icon"></i><span class="tab-label">Home</span></div>
    <div class="tab-item" data-action="showView" data-view="new"><i class="fas fa-grip tab-icon"></i><span class="tab-label">New</span></div>
    <div class="tab-item" data-action="showView" data-view="radio"><i class="fas fa-tower-broadcast tab-icon"></i><span class="tab-label">Radio</span></div>
    <div class="tab-item active" data-action="showView" data-view="library"><i class="fas fa-rectangle-list tab-icon"></i><span class="tab-label">Library</span></div>
    <div class="tab-item" data-action="showView" data-view="search"><i class="fas fa-magnifying-glass tab-icon"></i><span class="tab-label">Search</span></div>
  </div>
  <audio id="audio" preload="metadata"></audio>
  <div class="loading-overlay" id="loading-overlay"><div class="spinner"></div></div>
  <div id="confirm-dialog" class="confirm-dialog-overlay hidden">
    <div class="confirm-dialog">
        <div class="confirm-dialog-content">
            <h3 id="confirm-title" class="confirm-dialog-title"></h3>
            <p id="confirm-message" class="confirm-dialog-message"></p>
        </div>
        <div class="confirm-dialog-actions">
            <button id="confirm-cancel-btn">Cancel</button>
            <button id="confirm-confirm-btn" class="confirm-btn">Delete</button>
        </div>
    </div>
</div>
  <script>
document.addEventListener('DOMContentLoaded', () => {
    const app = {
        db: null,
        nowPlaying: { id: null, queue: [], currentIndex: -1, isPlaying: false, repeatMode: 'none' },
        library: { songs: [], playlists: [], artists: {}, albums: {} },
        uploadData: { songsToUpload: [], editingId: null, selectedPlaylistId: null },
        playlistData: { artworkBase64: null },
    };
    const DOM = {
        views: document.querySelectorAll('.view'),
        appContainer: document.querySelector('.app-container'),
        audio: document.getElementById('audio'),
        loadingOverlay: document.getElementById('loading-overlay'),
    };
    function init() {
        DB.init().then(() => {
            Library.loadAllData().then(() => {
                UI.renderAll();
                handlePopState();
            });
        });
        setupEventListeners();
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('Service Worker registered', reg))
                .catch(err => console.error('Service Worker registration failed:', err));
        }
    }
    function setupEventListeners() {
        document.body.addEventListener('click', handleAction);
        window.addEventListener('popstate', handlePopState);
        DOM.audio.addEventListener('timeupdate', () => Player.updateProgress());
        DOM.audio.addEventListener('loadedmetadata', () => Player.updateProgress());
        DOM.audio.addEventListener('ended', () => Player.nextSong());
        DOM.audio.addEventListener('error', e => { if (e.target.error && e.target.error.code === 4) Player.nextSong(); });
        document.getElementById('music-file-input').addEventListener('change', e => Upload.handleSongFileSelect(e));
        document.getElementById('playlist-artwork-input').addEventListener('change', e => Playlist.handleArtworkFileSelect(e));
        document.getElementById('search-input').addEventListener('input', e => UI.handleSearch(e));
        document.body.addEventListener('input', e => {
            if (e.target.closest('#sub-view-search-bar-area') && e.target.classList.contains('search-input')) {
                UI.handleSubViewSearch(e);
            }
        });
        document.getElementById('sub-view-content').addEventListener('touchstart', e => SwipeList.handleTouchStart(e), { passive: true });
        document.getElementById('sub-view-content').addEventListener('touchmove', e => SwipeList.handleTouchMove(e), { passive: false });
        document.getElementById('sub-view-content').addEventListener('touchend', e => SwipeList.handleTouchEnd(e));
    }
    function handleAction(e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        const action = target.dataset.action;
        if (target.closest('#now-playing-bar') && (action === 'togglePlay' || action === 'nextSong')) e.stopPropagation();
        const actions = {
            'showView': () => { const viewId = `${target.dataset.view}-view`; if (document.getElementById(viewId)) UI.showView(viewId); },
            'goBack': UI.goBack,
            'openUploadModal': Upload.openModal,
            'closeUploadModal': Upload.closeModal,
            'openCreatePlaylistModal': Playlist.openModal,
            'closeCreatePlaylistModal': Playlist.closeModal,
            'openPlaylistSelector': Upload.openPlaylistSelector,
            'closePlaylistSelector': Upload.closePlaylistSelector,
            'selectPlaylist': () => Upload.selectPlaylist(parseInt(target.dataset.id)),
            'triggerSongUpload': () => document.getElementById('music-file-input').click(),
            'triggerPlaylistArtworkUpload': () => document.getElementById('playlist-artwork-input').click(),
            'triggerSongArtworkUpload': () => {
                const index = target.dataset.index;
                document.querySelector(`.song-artwork-input[data-index='${index}']`).click();
            },
            'removeSongFromUpload': () => {
                const index = parseInt(target.dataset.index, 10);
                app.uploadData.songsToUpload.splice(index, 1);
                Upload.renderSongUploadList();
                const count = app.uploadData.songsToUpload.length;
                document.getElementById('song-file-name').textContent = count > 0 ? `${count} file(s) selected.` : '';
            },
            'submitUpload': Upload.submit,
            'submitCreatePlaylist': Playlist.submit,
            'showSubView': () => UI.showSubView(target.dataset.type, target.dataset.id),
            'playSong': () => { if (Player.playSong(parseInt(target.dataset.id))) UI.showView('player-view'); },
            'playAlbum': () => { if (Player.playAlbum(target.dataset.album)) UI.showView('player-view'); },
            'playPlaylist': () => { if (Player.playPlaylist(target.dataset.id)) UI.showView('player-view'); },
            'shuffle': () => { if (Player.shuffle(target.dataset.type, target.dataset.id)) UI.showView('player-view'); },
            'togglePlay': () => Player.togglePlay(),
            'nextSong': () => Player.nextSong(),
            'prevSong': () => Player.prevSong(),
            'showFullPlayer': () => { if (app.nowPlaying.id) { UI.showView('player-view'); history.pushState({ viewId: 'player-view' }, '', '#playing'); } },
            'hideFullPlayer': UI.hideFullPlayer,
            'seek': Player.seek,
            'setVolume': Player.setVolume,
            'toggleFavorite': Player.toggleFavorite,
            'toggleRepeat': () => Player.toggleRepeat(),
            'editSong': () => Upload.editSong(parseInt(target.dataset.id)),
            'deleteSong': () => Library.deleteSong(parseInt(target.dataset.id)),
            'renamePlaylist': () => Playlist.rename(parseInt(target.dataset.id)),
            'deletePlaylist': () => Playlist.delete(parseInt(target.dataset.id)),
        };
        if (actions[action]) actions[action](e);
    }
    function handlePopState() {
        const hash = window.location.hash.slice(1);
        const [path, id] = hash.split('/');
        switch (path) {
            case 'home': UI.showView('home-view', true); break;
            case 'new': UI.showView('new-view', true); break;
            case 'radio': UI.showView('radio-view', true); break;
            case 'search': UI.showView('search-view', true); break;
            case 'playlists': case 'artists': case 'albums': case 'songs': UI.showSubView(path, undefined, true); break;
            case 'playlistDetail': case 'albumDetail': UI.showSubView(path, id, true); break;
            case 'playing': if (app.nowPlaying.id) UI.showView('player-view', true); else window.location.hash = 'library'; break;
            case 'library': case '': default: UI.showView('library-view', true); break;
        }
    }
    const DB = {
        init: () => new Promise(resolve => {
            const request = indexedDB.open("AppleMusicDB_v17_Final", 1);
            request.onupgradeneeded = e => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains("songs")) db.createObjectStore("songs", { keyPath: "id", autoIncrement: true });
                if (!db.objectStoreNames.contains("playlists")) db.createObjectStore("playlists", { keyPath: "id", autoIncrement: true });
            };
            request.onsuccess = e => { app.db = e.target.result; resolve(); };
            request.onerror = e => console.error("IndexedDB error:", e.target.errorCode);
        }),
        add: (store, item) => new Promise((res, rej) => { const r = app.db.transaction(store, 'readwrite').objectStore(store).add(item); r.onsuccess = e => res(e.target.result); r.onerror = rej; }),
        put: (store, item) => new Promise(res => app.db.transaction(store, 'readwrite').objectStore(store).put(item).onsuccess = res),
        delete: (store, id) => new Promise(res => app.db.transaction(store, 'readwrite').objectStore(store).delete(id).onsuccess = res),
        get: (store, id) => new Promise(res => app.db.transaction(store).objectStore(store).get(id).onsuccess = e => res(e.target.result)),
        getAll: store => new Promise(res => app.db.transaction(store).objectStore(store).getAll().onsuccess = e => res(e.target.result)),
    };
    const Library = {
        async loadAllData() {
            [app.library.songs, app.library.playlists] = await Promise.all([DB.getAll("songs"), DB.getAll("playlists")]);
            this.processLibrary();
        },
        processLibrary() {
            app.library.artists = {}; app.library.albums = {};
            app.library.songs.forEach(song => {
                const artist = song.artist || "Unknown Artist", album = song.album || "Unknown Album";
                if (!app.library.artists[artist]) app.library.artists[artist] = [];
                app.library.artists[artist].push(song);
                if (!app.library.albums[album]) app.library.albums[album] = { songs: [], artwork: song.artwork, artist: artist };
                app.library.albums[album].songs.push(song);
            });
        },
        async deleteSong(id, skipConfirm = false) {
            const song = app.library.songs.find(s => s.id === id);
            if (!song) return;
            const deleteLogic = async () => {
                await DB.delete('songs', id);
                for (const playlist of app.library.playlists) { if (playlist.songs.includes(id)) { playlist.songs.splice(playlist.songs.indexOf(id), 1); await DB.put('playlists', playlist); } }
                if (app.nowPlaying.id === id) Player.stop();
                else { const queueIndex = app.nowPlaying.queue.indexOf(id); if (queueIndex > -1) { app.nowPlaying.queue.splice(queueIndex, 1); if (queueIndex < app.nowPlaying.currentIndex) app.nowPlaying.currentIndex--; } }
                await this.loadAllData();
                const currentHash = window.location.hash.slice(1);
                const [path, pathId] = currentHash.split('/');
                if (document.getElementById('sub-view').classList.contains('active')) UI.renderSubView(path, pathId);
                UI.renderLibraryView();
            };
            if (skipConfirm) await deleteLogic(); else UI.showConfirmation(`Delete Song?`, `This will remove "${song.title}" from your library and all playlists.`, deleteLogic);
        }
    };
    const Upload = {
        openModal: () => {
            Upload.resetForm();
            document.getElementById('song-file-selector-group').classList.remove('hidden');
            UI.showModal('upload-view');
        },
        closeModal: () => UI.hideModal('upload-view'),
        resetForm() {
            document.getElementById('upload-form').reset();
            document.getElementById('upload-song-list').innerHTML = '';
            document.getElementById('song-file-name').textContent = '';
            document.getElementById('selected-playlist-name').textContent = 'No playlist selected.';
            app.uploadData = { songsToUpload: [], editingId: null, selectedPlaylistId: null };
            document.querySelector('#upload-view h1').textContent = "Add Music";
            document.querySelector('#upload-view [data-action="submitUpload"]').textContent = "Done";
        },
        editSong(id) {
            const songToEdit = app.library.songs.find(s => s.id === id);
            if (songToEdit) {
                this.openModal();
                app.uploadData.editingId = id;
                app.uploadData.songsToUpload.push({
                    file: null,
                    title: songToEdit.title,
                    artist: songToEdit.artist,
                    album: songToEdit.album,
                    artworkBase64: songToEdit.artwork,
                    originalFileName: "Original file"
                });
                this.renderSongUploadList();
                document.getElementById('song-file-selector-group').classList.add('hidden');
                document.querySelector("#upload-view h1").textContent = "Edit Song";
                document.querySelector('#upload-view [data-action="submitUpload"]').textContent = "Save";
            }
        },
        handleSongFileSelect(e) {
            const files = e.target.files;
            if (!files.length) return;
            document.getElementById('song-file-name').textContent = `${files.length} file(s) selected.`;
            app.uploadData.songsToUpload = [];
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const songData = {
                    file: file, title: file.name.replace(/\.[^/.]+$/, ""), artist: 'Unknown Artist', album: 'Unknown Album',
                    artworkBase64: 'https://via.placeholder.com/150?text=Artwork', originalFileName: file.name
                };
                app.uploadData.songsToUpload.push(songData);
                jsmediatags.read(file, {
                    onSuccess: ({ tags }) => {
                        if (tags.title) songData.title = tags.title;
                        if (tags.artist) songData.artist = tags.artist;
                        if (tags.album) songData.album = tags.album;
                        if (tags.picture) songData.artworkBase64 = `data:${tags.picture.format};base64,${btoa(String.fromCharCode.apply(null, tags.picture.data))}`;
                        this.renderSongUploadList();
                    },
                    onError: () => this.renderSongUploadList()
                });
            }
            this.renderSongUploadList();
        },
        handleSongArtworkFileSelect(e) {
            const file = e.target.files[0];
            const index = e.target.dataset.index;
            if (file && index !== undefined) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    app.uploadData.songsToUpload[index].artworkBase64 = event.target.result;
                    document.querySelector(`img[data-action='triggerSongArtworkUpload'][data-index='${index}']`).src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        },
        renderSongUploadList() {
            const container = document.getElementById('upload-song-list');
            container.innerHTML = '';
            app.uploadData.songsToUpload.forEach((song, index) => {
                const item = document.createElement('div');
                item.className = 'upload-song-item';
                item.dataset.index = index;
                item.innerHTML = `
                    <div class="upload-song-artwork">
                        <img src="${song.artworkBase64}" class="modal-artwork-preview" data-action="triggerSongArtworkUpload" data-index="${index}" alt="Artwork Preview">
                        <input type="file" class="hidden song-artwork-input" accept="image/*" data-index="${index}">
                    </div>
                    <div class="upload-song-details">
                        <input type="text" placeholder="Title" class="upload-song-title" value="${song.title.replace(/"/g, '"')}" required>
                        <input type="text" placeholder="Artist" class="upload-song-artist" value="${song.artist.replace(/"/g, '"')}" required>
                        <input type="text" placeholder="Album" class="upload-song-album" value="${song.album.replace(/"/g, '"')}" required>
                        <span class="song-file-name-small">${song.originalFileName}</span>
                    </div>
                    <button type="button" class="remove-song-btn" data-action="removeSongFromUpload" data-index="${index}">×</button>`;
                container.appendChild(item);
            });
            container.querySelectorAll('.song-artwork-input').forEach(input => {
                input.addEventListener('change', (e) => this.handleSongArtworkFileSelect(e));
            });
        },
        async submit() {
            const songItems = document.querySelectorAll('.upload-song-item');
            if (songItems.length === 0) { alert("Please select at least one song file."); return; }
            let allFieldsValid = true;
            songItems.forEach((item, index) => {
                const title = item.querySelector('.upload-song-title').value, artist = item.querySelector('.upload-song-artist').value, album = item.querySelector('.upload-song-album').value;
                if (!title || !artist || !album) allFieldsValid = false;
                app.uploadData.songsToUpload[index].title = title;
                app.uploadData.songsToUpload[index].artist = artist;
                // THIS IS THE CORRECTED LINE
                app.uploadData.songsToUpload[index].album = album;
            });
            if (!allFieldsValid) { alert("Please fill all title, artist, and album fields."); return; }
            if (!app.uploadData.editingId && app.uploadData.songsToUpload.some(s => !s.file)) { alert("An error occurred. Please re-select your files."); return; }
            UI.showLoading(true); let success = false;
            try {
                if (app.uploadData.editingId) {
                    const songToSave = app.uploadData.songsToUpload[0];
                    const existingSong = await DB.get("songs", app.uploadData.editingId);
                    const songData = { ...existingSong, id: app.uploadData.editingId, title: songToSave.title, artist: songToSave.artist, album: songToSave.album, artwork: songToSave.artworkBase64 };
                    await DB.put("songs", songData);
                } else {
                    const newSongIds = [];
                    for (const song of app.uploadData.songsToUpload) {
                        const songData = { title: song.title, artist: song.artist, album: song.album, artwork: song.artworkBase64, file: song.file, addedAt: Date.now(), isFavorite: false };
                        const songId = await DB.add("songs", songData);
                        newSongIds.push(songId);
                    }
                    if (app.uploadData.selectedPlaylistId && newSongIds.length > 0) {
                        const playlist = await DB.get("playlists", app.uploadData.selectedPlaylistId);
                        if (playlist) { playlist.songs.push(...newSongIds); await DB.put("playlists", playlist); }
                    }
                }
                await Library.loadAllData(); success = true;
            } catch (err) { console.error("Error during upload/save:", err); alert("An error occurred while saving the music."); }
            finally {
                UI.showLoading(false);
                // FIX 3: After creating a song, automatically update and redirect to the Library page.
                if (success) {
                    this.closeModal();
                    // This will show the library view and trigger a re-render due to the fix for issue #2.
                    UI.showView('library-view');
                }
            }
        },
        openPlaylistSelector() { UI.renderPlaylistSelector(); UI.showModal('playlist-selector-view'); },
        closePlaylistSelector() { UI.hideModal('playlist-selector-view'); },
        selectPlaylist(id) {
            app.uploadData.selectedPlaylistId = id; const playlist = app.library.playlists.find(p => p.id === id);
            document.getElementById('selected-playlist-name').textContent = playlist ? playlist.name : 'No playlist selected.'; this.closePlaylistSelector();
        }
    };
    const Playlist = {
        openModal: () => { Playlist.resetForm(); UI.showModal('create-playlist-view'); },
        closeModal: () => UI.hideModal('create-playlist-view'),
        resetForm() { document.getElementById("create-playlist-form").reset(); document.getElementById("playlist-artwork-preview").src = "https://via.placeholder.com/150?text=Artwork"; app.playlistData = { artworkBase64: null }; },
        handleArtworkFileSelect(e) {
            const file = e.target.files[0];
            if (file) { const reader = new FileReader(); reader.onload = e => { app.playlistData.artworkBase64 = e.target.result; document.getElementById("playlist-artwork-preview").src = app.playlistData.artworkBase64; }; reader.readAsDataURL(file); }
        },
        // FIX 3: After creating a playlist, redirect to the new playlist's page.
        async submit() {
            const name = document.getElementById("playlist-name-input").value.trim(); if (!name) return alert("Please enter a playlist name.");
            UI.showLoading(true);
            let success = false;
            let newPlaylistId = null; // Variable to hold the ID of the new playlist

            try {
                const playlistData = { name, songs: [], artwork: app.playlistData.artworkBase64, createdAt: Date.now() };
                newPlaylistId = await DB.add("playlists", playlistData); // Capture the new ID
                await Library.loadAllData();
                success = true;
            } catch(err) {
                 console.error("Error creating playlist:", err);
            }
            finally {
                UI.showLoading(false);
                if (success && newPlaylistId) {
                    this.closeModal();
                    // Redirect to the newly created playlist's detail page
                    UI.showSubView('playlistDetail', newPlaylistId);
                }
            }
        },
        async rename(id) {
            const playlist = app.library.playlists.find(p => p.id === id); if (!playlist) return;
            const newName = prompt("Enter new playlist name:", playlist.name);
            if (newName && newName.trim() !== "") { playlist.name = newName.trim(); await DB.put('playlists', playlist); await Library.loadAllData(); UI.renderSubView('playlists'); SwipeList.resetAllSwipes(); }
        },
        async delete(id, skipConfirm = false) {
            const playlist = app.library.playlists.find(p => p.id === id); if (!playlist) return;
            const deleteLogic = async () => { await DB.delete('playlists', id); await Library.loadAllData(); UI.renderSubView('playlists'); };
            if (skipConfirm) await deleteLogic(); else UI.showConfirmation(`Delete Playlist?`, `"${playlist.name}" will be removed from your library.`, deleteLogic);
        }
    };
    const SwipeList = {
        startX: 0, currentX: 0, target: null, container: null, isSwiping: false, actionsElement: null, initialActionsWidth: 160,
        handleTouchStart(e) {
            const container = e.target.closest('.list-item-swipe-container');
            if (!container || e.target.closest('[data-action]')) return;
            this.resetAllSwipes(container);
            this.container = container; this.target = container.querySelector('.list-item-swipe-inner'); this.actionsElement = container.querySelector('.list-item-actions');
            if (!this.target || !this.actionsElement) return;
            this.startX = e.touches[0].clientX; this.currentX = this.startX; this.isSwiping = true;
            this.target.style.transition = 'none'; this.actionsElement.style.transition = 'none';
        },
        handleTouchMove(e) {
            if (!this.isSwiping || !this.target) return;
            this.currentX = e.touches[0].clientX; let diff = this.currentX - this.startX;
            if (diff > 0) diff = 0;
            this.target.style.transform = `translateX(${diff}px)`;
            this.actionsElement.style.width = `${-diff}px`;
            const deleteThreshold = this.container.offsetWidth * (2/3);
            this.target.classList.toggle('delete-ready', Math.abs(diff) > deleteThreshold);
        },
        handleTouchEnd() {
            if (!this.isSwiping || !this.target) return;
            this.isSwiping = false; this.target.style.transition = 'transform 0.3s ease'; if (this.actionsElement) this.actionsElement.style.transition = 'width 0.3s ease';
            if (this.target.classList.contains('delete-ready')) {
                const deleteButton = this.actionsElement.querySelector('.action-delete');
                if (deleteButton) {
                    const action = deleteButton.dataset.action, id = parseInt(deleteButton.dataset.id, 10);
                    this.container.style.transition = 'transform 0.3s ease, opacity 0.3s ease, max-height 0.3s ease, padding 0.3s ease, margin 0.3s ease';
                    this.container.style.transform = 'translateX(-100%)'; this.container.style.opacity = '0';
                    this.container.style.maxHeight = '0px'; this.container.style.padding = '0'; this.container.style.margin = '0';
                    setTimeout(() => {
                        this.container.remove();
                        if (action === 'deleteSong') Library.deleteSong(id, true);
                        else if (action === 'deletePlaylist') Playlist.delete(id, true);
                    }, 300);
                }
            } else {
                let diff = this.currentX - this.startX;
                if (diff < -60) { this.target.style.transform = `translateX(-${this.initialActionsWidth}px)`; this.actionsElement.style.width = `${this.initialActionsWidth}px`; }
                else { this.target.style.transform = 'translateX(0)'; this.actionsElement.style.width = '0px'; }
            }
            this.target.classList.remove('delete-ready');
        },
        resetAllSwipes(exclude = null) {
            document.querySelectorAll('.list-item-swipe-container').forEach(container => {
                if (container !== exclude) {
                    const innerContent = container.querySelector('.list-item-swipe-inner'); const actions = container.querySelector('.list-item-actions');
                    if (innerContent && actions && innerContent.style.transform !== 'translateX(0px)') {
                        innerContent.style.transition = 'transform 0.3s ease'; actions.style.transition = 'width 0.3s ease';
                        innerContent.style.transform = 'translateX(0)'; actions.style.width = '0';
                    }
                }
            });
        }
    };
    const Player = {
        currentObjectURL: null,
        playSong(id) { const index = app.library.songs.findIndex(s => s.id === id); if (index !== -1) { app.nowPlaying.queue = app.library.songs.map(s => s.id); this.playFromQueue(index); return true; } return false; },
        playAlbum(albumName) { const album = app.library.albums[albumName]; if (album && album.songs.length > 0) { app.nowPlaying.queue = album.songs.map(s => s.id); this.playFromQueue(0); return true; } else { alert("This album is empty."); return false; } },
        playPlaylist(id) { const songs = this.getPlaylistSongs(id); if (songs.length === 0) { alert("This playlist is empty."); return false; } app.nowPlaying.queue = songs.map(s => s.id); this.playFromQueue(0); return true; },
        playFromQueue(index) {
            if (app.nowPlaying.queue.length === 0 || index < 0 || index >= app.nowPlaying.queue.length) { this.stop(); return; }
            const songId = app.nowPlaying.queue[index];
            if (songId === app.nowPlaying.id && DOM.audio.src) { if (app.nowPlaying.currentIndex === index) DOM.audio.currentTime = 0; this.play(); app.nowPlaying.currentIndex = index; return; }
            const song = app.library.songs.find(s => s.id === songId);
            if (song) { app.nowPlaying.currentIndex = index; this.loadAndPlaySong(song); } else this.nextSong();
        },
        loadAndPlaySong(song) {
            if (this.currentObjectURL) URL.revokeObjectURL(this.currentObjectURL);
            app.nowPlaying.id = song.id; this.currentObjectURL = URL.createObjectURL(song.file);
            DOM.audio.src = this.currentObjectURL; DOM.audio.load();
            this.play(); UI.updatePlayerUI(); this.updateMediaSession(song);
        },
        play() {
            if (!app.nowPlaying.id || !DOM.audio.src) return;
            const playPromise = DOM.audio.play();
            if (playPromise !== undefined) playPromise.then(() => { app.nowPlaying.isPlaying = true; UI.updatePlayIcons(); this.updateMediaSession(); }).catch(() => { app.nowPlaying.isPlaying = false; UI.updatePlayIcons(); });
        },
        pause() { DOM.audio.pause(); app.nowPlaying.isPlaying = false; UI.updatePlayIcons(); this.updateMediaSession(); },
        stop() {
            DOM.audio.pause(); DOM.audio.currentTime = 0; DOM.audio.src = '';
            if (this.currentObjectURL) URL.revokeObjectURL(this.currentObjectURL);
            app.nowPlaying.id = null; app.nowPlaying.isPlaying = false; app.nowPlaying.queue = []; app.nowPlaying.currentIndex = -1;
            UI.updatePlayerUI(); this.updateMediaSession();
        },
        togglePlay() { if (!app.nowPlaying.id) return; if (app.nowPlaying.isPlaying) this.pause(); else this.play(); },
        nextSong() {
            if (app.nowPlaying.queue.length === 0) return;
            let nextIndex = app.nowPlaying.currentIndex + 1;
            if (app.nowPlaying.repeatMode === 'queue' && nextIndex >= app.nowPlaying.queue.length) nextIndex = 0;
            else if (nextIndex >= app.nowPlaying.queue.length) { this.stop(); return; }
            this.playFromQueue(nextIndex);
        },
        prevSong() {
            if (app.nowPlaying.queue.length === 0) return;
            if (DOM.audio.currentTime > 3) DOM.audio.currentTime = 0;
            else { const prevIndex = (app.nowPlaying.currentIndex - 1 + app.nowPlaying.queue.length) % app.nowPlaying.queue.length; this.playFromQueue(prevIndex); }
        },
        seek(e) { if (!app.nowPlaying.id || isNaN(DOM.audio.duration)) return; const rect = e.currentTarget.getBoundingClientRect(); DOM.audio.currentTime = DOM.audio.duration * (e.clientX - rect.left) / rect.width; },
        setVolume(e) { const rect = e.currentTarget.getBoundingClientRect(); let volume = (e.clientX - rect.left) / rect.width; DOM.audio.volume = Math.max(0, Math.min(1, volume)); document.getElementById("volume-fill").style.width = `${DOM.audio.volume * 100}%`; },
        updateProgress() {
            if (isNaN(DOM.audio.duration)) return;
            const { currentTime, duration } = DOM.audio;
            document.getElementById("progress-fill").style.width = `${(currentTime / duration) * 100}%`;
            document.getElementById("current-time").textContent = this.formatTime(currentTime);
            document.getElementById("total-time").textContent = this.formatTime(duration);
        },
        formatTime: s => { const rounded = Math.floor(s || 0); return `${Math.floor(rounded/60)}:${(rounded%60).toString().padStart(2,'0')}`; },
        async toggleFavorite() {
            if (!app.nowPlaying.id) return;
            const song = app.library.songs.find(s => s.id === app.nowPlaying.id);
            if (song) {
                song.isFavorite = !song.isFavorite;
                await DB.put("songs", song);
                UI.updateFavoriteButton(song.isFavorite);
            }
        },
        toggleRepeat() { const modes = ['none', 'queue', 'single']; let nextIndex = (modes.indexOf(app.nowPlaying.repeatMode) + 1) % modes.length; this.setRepeatMode(modes[nextIndex]); },
        setRepeatMode(mode) { app.nowPlaying.repeatMode = mode; UI.updateRepeatButton(mode); DOM.audio.loop = (mode === 'single'); },
        shuffle(type, id) {
            let songsToShuffle = [];
            if (type === 'songs') songsToShuffle = [...app.library.songs];
            else if (type === 'album') songsToShuffle = app.library.albums[id]?.songs || [];
            else if (type === 'playlist') songsToShuffle = this.getPlaylistSongs(id);
            if (songsToShuffle.length === 0) { alert("Nothing to shuffle."); return false; }
            for (let i = songsToShuffle.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [songsToShuffle[i], songsToShuffle[j]] = [songsToShuffle[j], songsToShuffle[i]]; }
            app.nowPlaying.queue = songsToShuffle.map(s => s.id); this.playFromQueue(0); return true;
        },
        getPlaylistSongs(id) { if (id === "favorites") return app.library.songs.filter(s => s.isFavorite); const playlist = app.library.playlists.find(p => p.id === parseInt(id)); return playlist ? app.library.songs.filter(s => playlist.songs.includes(s.id)) : []; },
        updateMediaSession(song = app.library.songs.find(s => s.id === app.nowPlaying.id)) {
            if ('mediaSession' in navigator) {
                if (!song) { navigator.mediaSession.metadata = null; navigator.mediaSession.playbackState = 'none'; return; }
                navigator.mediaSession.metadata = new MediaMetadata({ title: song.title, artist: song.artist, album: song.album, artwork: [{ src: song.artwork, sizes: '512x512', type: 'image/png' }] });
                navigator.mediaSession.playbackState = app.nowPlaying.isPlaying ? 'playing' : 'paused';
                navigator.mediaSession.setActionHandler('play', () => Player.togglePlay()); navigator.mediaSession.setActionHandler('pause', () => Player.togglePlay());
                navigator.mediaSession.setActionHandler('previoustrack', () => Player.prevSong()); navigator.mediaSession.setActionHandler('nexttrack', () => Player.nextSong());
            }
        }
    };
    const UI = {
        showLoading: (show) => DOM.loadingOverlay.classList.toggle('active', show),
        showView(viewId, fromPopState = false) {
            // FIX 2: Always re-render the library view's content when it's shown.
            // This prevents issues with stale DOM elements and unresponsive buttons
            // by ensuring the UI is fresh every time the user returns to this tab.
            if (viewId === 'library-view') {
                this.renderLibraryView();
            }
            if (!fromPopState) { let hash = viewId.replace('-view', ''); if (viewId === 'player-view') hash = 'playing'; if (window.location.hash !== '#' + hash) history.pushState({ viewId }, '', '#' + hash); }
            DOM.views.forEach(v => v.classList.remove('active'));
            document.getElementById(viewId)?.classList.add('active');
            DOM.appContainer.classList.toggle('player-visible', viewId === 'player-view');
            const viewName = viewId.replace('-view', '');
            document.querySelectorAll('.tab-item').forEach(t => t.classList.toggle('active', t.dataset.view === viewName));
        },
        showSubView(type, id = null, fromPopState = false) {
            if (!fromPopState) { let hash = type; if (id) hash += `/${id}`; if (window.location.hash !== '#' + hash) history.pushState({ type, id }, '', '#' + hash); }
            this.renderSubView(type, id);
            DOM.views.forEach(v => v.classList.remove('active'));
            document.getElementById('sub-view').classList.add('active');
            DOM.appContainer.classList.remove('player-visible');
            document.querySelector('#sub-view .sub-view-scrollable-header-content').scrollTop = 0;
        },
        showModal: (viewId) => { document.getElementById(viewId).classList.add('active'); },
        hideModal: (viewId) => { document.getElementById(viewId).classList.remove('active'); },
        goBack: () => history.back(),
        hideFullPlayer: () => {
            if (document.getElementById('player-view').classList.contains('active')) {
                history.back();
            }
        },
        showConfirmation(title, message, onConfirm) {
            const dialog = document.getElementById('confirm-dialog');
            document.getElementById('confirm-title').textContent = title; document.getElementById('confirm-message').textContent = message;
            const confirmBtn = document.getElementById('confirm-confirm-btn'), cancelBtn = document.getElementById('confirm-cancel-btn');
            const confirmHandler = () => { hide(); onConfirm(); };
            const cancelHandler = () => hide();
            const hide = () => { dialog.classList.add('hidden'); confirmBtn.removeEventListener('click', confirmHandler); cancelBtn.removeEventListener('click', cancelHandler); };
            confirmBtn.addEventListener('click', confirmHandler, { once: true }); cancelBtn.addEventListener('click', cancelHandler, { once: true });
            dialog.classList.remove('hidden');
        },
        updatePlayerUI() {
            const nowPlayingBar = document.getElementById("now-playing-bar");
            if (!app.nowPlaying.id) { nowPlayingBar.classList.remove("active"); return; }
            nowPlayingBar.classList.add("active"); this.updatePlayIcons(); this.updateRepeatButton(app.nowPlaying.repeatMode);
            const song = app.library.songs.find(e => e.id === app.nowPlaying.id);
            if (song) {
                ["np-artwork", "player-artwork"].forEach(e => document.getElementById(e).src = song.artwork);
                const playerTitle = document.getElementById("player-title"), npTitle = document.getElementById("np-title");
                playerTitle.textContent = song.title.replace(" [E]", ""); npTitle.textContent = song.title.replace(" [E]", "");
                playerTitle.classList.toggle("explicit", song.title.includes("[E]")); npTitle.classList.toggle("explicit", song.title.includes("[E]"));
                document.getElementById("player-artist").textContent = song.artist; this.updateFavoriteButton(song.isFavorite); this.updatePlayerBackground(song.artwork);
            }
        },
        updateFavoriteButton(isFavorite) { const favBtn = document.querySelector(".favorite-btn i"); if (favBtn) { favBtn.className = isFavorite ? "fas fa-star" : "far fa-star"; favBtn.parentElement.classList.toggle("favorited", isFavorite) } },
        updatePlayIcons() { const isPlaying = app.nowPlaying.isPlaying; document.getElementById("np-play-icon").className = `fas ${isPlaying?"fa-pause":"fa-play"}`; document.getElementById("main-play-icon").className = `fas ${isPlaying?"fa-pause-circle":"fa-play-circle"}`; },
        updateRepeatButton(mode) { const repeatBtn = document.querySelector('.repeat-btn'), repeatIcon = document.getElementById('repeat-icon'); if (!repeatBtn || !repeatIcon) return; repeatBtn.classList.toggle('active', mode !== 'none'); repeatIcon.className = 'fas'; if (mode === 'single') repeatIcon.classList.add('fa-repeat-1'); else repeatIcon.classList.add('fa-repeat'); },
        updatePlayerBackground(src) { const img = new Image; img.crossOrigin = "Anonymous"; img.src = src; img.onload = () => { const canvas = document.createElement("canvas"), ctx = canvas.getContext("2d"); ctx.drawImage(img, 0, 0, 1, 1); const [r, g, b] = ctx.getImageData(0, 0, 1, 1).data; document.getElementById("player-view").style.backgroundImage = `linear-gradient(to bottom, rgb(${r},${g},${b}) 0%, #000 70%)` }; img.onerror = () => { document.getElementById("player-view").style.backgroundImage = "linear-gradient(to bottom, #222 0%, #000 70%)" } },
        renderAll() { this.renderLibraryView(); },
        renderLibraryView() {
            const container = document.getElementById("library-content"); container.innerHTML = `<div id="library-nav-list"></div><div class="section-header"><h2>Recently Added</h2></div><div class="grid" id="library-recent-grid"></div>`;
            const navList = container.querySelector("#library-nav-list");
            [{type: "playlists", icon: "fa-list-ul", text: "Playlists"}, {type: "artists", icon: "fa-microphone-lines", text: "Artists"}, {type: "albums", icon: "fa-compact-disc", text: "Albums"}, {type: "songs", icon: "fa-music", text: "Songs"}].forEach(item => navList.appendChild(this.createListItem(item)));
            const recentGrid = container.querySelector("#library-recent-grid"), recentSongs = [...app.library.songs].sort((a, b) => b.addedAt - a.addedAt).slice(0, 4);
            recentGrid.innerHTML = ""; const sectionHeader = container.querySelector(".section-header");
            if (recentSongs.length > 0) { sectionHeader.classList.remove("hidden"); recentSongs.forEach(song => recentGrid.appendChild(this.createGridItem(song, "playSong"))); }
            else sectionHeader.classList.add("hidden");
        },
        renderSubView(type, id) {
            const dynamicHeader = document.querySelector('.sub-view-dynamic-header-elements');
            const mainActionsArea = document.getElementById("sub-view-main-actions-area");
            const contentContainer = document.getElementById("sub-view-content");
            const topActionsContainer = document.getElementById("sub-view-top-actions");

            dynamicHeader.innerHTML = ''; mainActionsArea.innerHTML = ''; contentContainer.innerHTML = ''; topActionsContainer.innerHTML = '';
            contentContainer.dataset.type = type;
            contentContainer.className = 'main-content';

            const backTextMap = { playlistDetail: "Playlists", albumDetail: "Albums", default: "Library" };
            document.querySelector("#sub-view .back-btn span").textContent = backTextMap[type] || backTextMap.default;

            if (type === 'albumDetail' || type === 'playlistDetail') {
                contentContainer.classList.add('has-spacer');
                let title, subtitle, artwork, metaInfo;
                let songs = [];
                
                if (type === 'albumDetail') {
                    const album = app.library.albums[id];
                    if (album) {
                        title = id;
                        subtitle = album.artist;
                        artwork = album.artwork;
                        songs = album.songs;
                        metaInfo = `${songs.length} song${songs.length !== 1 ? 's' : ''}`;
                    }
                } else { // playlistDetail
                    songs = Player.getPlaylistSongs(id);
                    if (id === 'favorites') {
                        title = 'Favorite Songs';
                        subtitle = 'Playlist';
                        artwork = 'FAVORITE';
                    } else {
                        const playlist = app.library.playlists.find(p => p.id === parseInt(id));
                        if(playlist) {
                           title = playlist.name;
                           subtitle = 'Playlist';
                           artwork = playlist.artwork;
                        }
                    }
                    metaInfo = `${songs.length} song${songs.length !== 1 ? 's' : ''}`;
                }

                const artworkHTML = artwork === 'FAVORITE'
                    ? `<div id="favorite-playlist-artwork" class="album-artwork-main"><i class="fas fa-star"></i></div>`
                    : `<img src="${artwork || 'https://via.placeholder.com/240'}" class="album-artwork-main">`;

                const albumHeaderHTML = `
                    <div class="album-header">
                        ${artworkHTML}
                        <h1 class="album-title-main">${title || ''}</h1>
                        <h2 class="album-artist-main">${subtitle || ''}</h2>
                        <p class="album-meta">${metaInfo || ''}</p>
                    </div>`;

                let actionButtonsHTML = '';
                if (songs.length > 0) {
                    const playAction = type === 'albumDetail' ? 'playAlbum' : 'playPlaylist';
                    const playId = type === 'albumDetail' ? id : id;
                    const shuffleId = type === 'albumDetail' ? id : id;
                    actionButtonsHTML = `
                        <div class="action-buttons" style="padding: 10px 0 15px 0;">
                            <button class="action-btn" data-action="${playAction}" data-${type === 'albumDetail' ? 'album' : 'id'}="${playId}"><i class="fas fa-play"></i>Play</button>
                            <button class="action-btn" data-action="shuffle" data-type="${type === 'albumDetail' ? 'album' : 'playlist'}" data-id="${shuffleId}"><i class="fas fa-shuffle"></i>Shuffle</button>
                        </div>
                    `;
                }
                
                contentContainer.innerHTML = albumHeaderHTML + actionButtonsHTML;
                this.renderNumberedSongList(contentContainer, songs);

            } else {
                const titles = { playlists: "Playlists", artists: "Artists", albums: "Albums", songs: "Songs" };
                dynamicHeader.innerHTML = `
                    <div class="header large-title" id="sub-view-large-title-area"><h1>${titles[type] || ''}</h1></div>
                    <div class="search-bar" id="sub-view-search-bar-area"><input type="text" class="search-input" data-type="${type}" ${id ? `data-id="${id}"` : ''} placeholder="Search"><i class="fas fa-microphone search-input-mic"></i></div>
                    <div class="action-buttons" id="sub-view-main-actions-area"></div>`;
                
                const renderers = { playlists: this.renderPlaylistsView, artists: this.renderArtistsView, albums: this.renderAlbumsView, songs: this.renderSongsView };
                if (renderers[type]) renderers[type].call(this, contentContainer, id);
                 if (type === "playlists") {
                    topActionsContainer.innerHTML = '<button class="icon-btn" data-action="openCreatePlaylistModal"><i class="fas fa-plus"></i></button>';
                }
                // FIX 1: Add Play/Shuffle buttons to the main "Songs" list view.
                if (type === 'songs' && app.library.songs.length > 0) {
                    const mainActionsArea = document.getElementById('sub-view-main-actions-area');
                    if (mainActionsArea) {
                        mainActionsArea.innerHTML = `
                            <button class="action-btn" data-action="playSong" data-id="${app.library.songs[0].id}"><i class="fas fa-play"></i> Play</button>
                            <button class="action-btn" data-action="shuffle" data-type="songs"><i class="fas fa-shuffle"></i> Shuffle</button>
                        `;
                    }
                }
            }
        },
        renderNumberedSongList(container, songs) {
            if (songs.length === 0) { container.innerHTML += '<p class="empty-state">No songs found.</p>'; return; }
            songs.forEach((song, index) => {
                const item = document.createElement('div');
                item.className = 'album-song-item';
                item.dataset.action = 'playSong';
                item.dataset.id = song.id;
                const isExplicit = song.title && song.title.includes('[E]');
                const displayTitle = isExplicit ? song.title.replace(' [E]','') : song.title;
                item.innerHTML = `
                    <span class="album-song-track-number">${index + 1}</span>
                    <span class="album-song-title ${isExplicit ? 'explicit' : ''}">${displayTitle}</span>`;
                container.appendChild(item);
            });
        },
        renderPlaylistSelector() { const list = document.getElementById("playlist-selector-list"); list.innerHTML = ""; app.library.playlists.forEach(playlist => { const item = document.createElement("div"); item.className = "list-item"; item.dataset.action = "selectPlaylist"; item.dataset.id = playlist.id; item.innerHTML = `<div class="list-icon"><i class="fas fa-list-ul"></i></div><div class="list-text">${playlist.name}</div>`; list.appendChild(item); }) },
        renderPlaylistsView(container) { const fragment = document.createDocumentFragment(); fragment.appendChild(this.createPlaylistItem({ id: "favorites", name: "Favorite Songs", artwork: "FAVORITE", songs: [] })); app.library.playlists.forEach(p => fragment.appendChild(this.createPlaylistItem(p))); container.appendChild(fragment) },
        renderPlaylistDetailView(container, playlistId) { this.renderNumberedSongList(container, Player.getPlaylistSongs(playlistId)); },
        renderAlbumDetailView(container, albumName) { const album = app.library.albums[albumName]; this.renderNumberedSongList(container, album ? album.songs : []); },
        renderArtistsView(container) { const artists = Object.keys(app.library.artists).sort(); if (artists.length === 0) return container.innerHTML += '<p class="empty-state">No artists found.</p>'; artists.forEach(artistName => container.appendChild(this.createArtistListItem(artistName, app.library.artists[artistName][0].artwork))) },
        renderAlbumsView(container) {
            const albums = Object.keys(app.library.albums).sort();
            if (albums.length === 0) {
                container.innerHTML += '<p class="empty-state">No albums found.</p>';
                return;
            }
            const grid = document.createElement("div");
            grid.className = "grid";
            albums.forEach(albumName => grid.appendChild(this.createGridItem(app.library.albums[albumName], "showSubView", albumName)));
            container.appendChild(grid);
        },
        renderSongsView(container) {
            const songs = app.library.songs;
            if (songs.length === 0) {
                container.innerHTML += '<p class="empty-state">No songs found.</p>';
                return;
            }
            songs.forEach(song => container.appendChild(this.createSongListItem(song)));
        },
        createListItem(item) { const el = document.createElement("div"); el.className = "list-item"; el.dataset.action = "showSubView"; el.dataset.type = item.type; el.innerHTML = `<div class="list-icon"><i class="fas ${item.icon}"></i></div><div class="list-text">${item.text}</div><div class="list-arrow"><i class="fas fa-chevron-right"></i></div>`; return el },
        createPlaylistItem(playlist) {
            const songCount = playlist.id === "favorites" ? app.library.songs.filter(s => s.isFavorite).length : playlist.songs.length;
            const itemHTML = `<div class="playlist-item" data-action="showSubView" data-type="playlistDetail" data-id="${playlist.id}"><div class="playlist-item-artwork" ${playlist.artwork==="FAVORITE"?'id="favorite-playlist-artwork"':`style="background-image:url(${playlist.artwork||'https://via.placeholder.com/150?text=Art'})"`}>${playlist.artwork==="FAVORITE"?'<i class="fas fa-star"></i>':''}</div><div class="playlist-info"><div class="playlist-title">${playlist.name}</div><div class="playlist-subtitle">${songCount} song${songCount!==1?'s':''}</div></div><div class="list-arrow"><i class="fas fa-chevron-right"></i></div></div>`;
            const wrapper = document.createElement("div"); wrapper.className = "list-item-swipe-container";
            wrapper.innerHTML = `<div class="list-item-swipe-inner"><div class="list-item-swipe-content playlist-swipe-content">${itemHTML}</div></div>${playlist.id!=="favorites" ? `<div class="list-item-actions"><button class="list-action-btn action-edit" data-action="renamePlaylist" data-id="${playlist.id}"><i class="fas fa-pen"></i></button><button class="list-action-btn action-delete" data-action="deletePlaylist" data-id="${playlist.id}"><i class="fas fa-trash"></i></button></div>` : ''}`;
            return wrapper;
        },
        createArtistListItem(name, artwork) { const el = document.createElement("div"); el.className = "list-item"; el.innerHTML = `<div class="list-icon"><img src="${artwork}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;"></div><div class="list-text">${name}</div><div class="list-arrow"><i class="fas fa-chevron-right"></i></div>`; return el },
        createGridItem(item, action, id) {
            const el = document.createElement("div"); el.className = "grid-item"; el.dataset.action = action;
            if (action === "playSong") { el.dataset.id = item.id; el.innerHTML = `<img src="${item.artwork}" alt="${item.album}"><div class="grid-item-title">${item.title}</div><div class="grid-item-subtitle">${item.artist}</div>` }
            else if (action === "showSubView") { el.dataset.type = "albumDetail"; el.dataset.id = id; const songCount = item.songs.length; el.innerHTML = `<img src="${item.artwork}" alt="${id}"><div class="grid-item-title">${id}</div><div class="grid-item-subtitle">${item.artist} • ${songCount} song${songCount!==1?'s':''}</div>` }
            return el
        },
        createSongListItem(song) {
            const wrapper = document.createElement("div");
            wrapper.className = "list-item-swipe-container";
            const artworkUrl = song.artwork || 'https://via.placeholder.com/44?text=Art';
            const title = song.title || 'Unknown Title';
            const artist = song.artist || 'Unknown Artist';
            const isExplicit = song.title && song.title.includes('[E]');
            const displayTitle = isExplicit ? title.replace(' [E]','') : title;

            wrapper.innerHTML = `
                <div class="list-item-swipe-inner">
                    <div class="list-item-swipe-content">
                        <div class="song-list-artwork" style="background-image: url('${artworkUrl}'); background-size: cover; background-position: center;"></div>
                        <div class="song-list-info-content" data-action="playSong" data-id="${song.id}">
                            <div class="song-list-info">
                                <span class="song-list-title ${isExplicit ? 'explicit' : ''}">${displayTitle}</span>
                                <span class="song-list-artist">${artist}</span>
                            </div>
                            <i class="fas fa-chevron-right list-arrow"></i>
                        </div>
                    </div>
                </div>
                <div class="list-item-actions">
                    <button class="list-action-btn action-edit" data-action="editSong" data-id="${song.id}"><i class="fas fa-pen"></i></button>
                    <button class="list-action-btn action-delete" data-action="deleteSong" data-id="${song.id}"><i class="fas fa-trash"></i></button>
                </div>`;
            return wrapper;
        },
        handleSearch(e) {
            const query = e.target.value.toLowerCase(), resultsContainer = document.getElementById("search-results-container"), categoriesContainer = document.getElementById("search-categories");
            resultsContainer.classList.toggle("hidden", query.length < 2); categoriesContainer.classList.toggle("hidden", query.length >= 2);
            if (query.length < 2) return; resultsContainer.innerHTML = "";
            const results = app.library.songs.filter(song => song.title.toLowerCase().includes(query) || song.artist.toLowerCase().includes(query) || song.album.toLowerCase().includes(query));
            if (results.length === 0) resultsContainer.innerHTML = '<p class="empty-state">No Results</p>'; else results.forEach(song => resultsContainer.appendChild(this.createSongListItem(song)))
        },
        handleSubViewSearch(e) {
            const query = e.target.value.toLowerCase();
            const contentContainer = document.getElementById('sub-view-content');
            if (!contentContainer) return;

            const items = contentContainer.querySelectorAll(".list-item, .list-item-swipe-container, .grid-item, .album-song-item");
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(query) ? "" : "none";
            });
        },
    };
    init();
});
</script>
</body>
</html>
