<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Music Player</title>
  <link rel="manifest" href="manifest.json" />
  <link id="favicon" rel="icon" href="">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      overflow-x: hidden;
      color: white;
    }

    .glass-container {
      backdrop-filter: blur(40px);
      background: rgba(255, 255, 255, 0.08);
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 
        0 32px 64px rgba(0, 0, 0, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
    }

    .glass-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    }

    .main-container {
      max-width: 400px;
      margin: 40px auto;
      padding: 0 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px 0;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.5px;
      background: linear-gradient(135deg, #ffffff 0%, rgba(255, 255, 255, 0.7) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .player-section {
      padding: 30px;
      margin-bottom: 20px;
    }

    .cover-container {
      position: relative;
      width: 280px;
      height: 280px;
      margin: 0 auto 25px;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.3),
        0 8px 16px rgba(0, 0, 0, 0.2);
      transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .cover-container:hover {
      transform: scale(1.02);
      box-shadow: 
        0 24px 48px rgba(0, 0, 0, 0.35),
        0 12px 20px rgba(0, 0, 0, 0.25);
    }

    .cover-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: opacity 0.6s ease;
    }

    .cover-placeholder {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      color: rgba(255, 255, 255, 0.3);
    }

    .track-info {
      text-align: center;
      margin-bottom: 25px;
    }

    .track-title {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 8px;
      color: white;
      letter-spacing: -0.3px;
      line-height: 1.2;
    }

    .track-artist {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.7);
      font-weight: 400;
    }

    .controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin: 30px 0;
    }

    .control-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      font-size: 20px;
    }

    .play-btn {
      width: 80px;
      height: 80px;
      background: rgba(255, 255, 255, 0.25);
      font-size: 24px;
    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: scale(1.05);
    }

    .progress-container {
      margin: 25px 0;
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ffffff 0%, rgba(255, 255, 255, 0.8) 100%);
      border-radius: 2px;
      width: 0%;
      transition: width 0.1s ease;
    }

    .time-info {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      font-weight: 500;
    }

    .file-inputs {
      padding: 25px;
      margin-bottom: 20px;
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
    }

    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }

    .file-input {
      position: absolute;
      left: -9999px;
    }

    .file-input-label {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 14px 20px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 500;
      color: white;
    }

    .file-input-label:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.25);
    }

    .text-input {
      width: 100%;
      padding: 14px 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      color: white;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .text-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .text-input:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .select-input {
      width: 100%;
      padding: 14px 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }

    .select-input option {
      background: #333;
      color: white;
    }

    .add-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.1) 100%);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 15px;
    }

    .add-btn:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.15) 100%);
      transform: translateY(-1px);
    }

    .playlists-section {
      padding: 25px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: white;
      letter-spacing: -0.3px;
    }

    .new-playlist-btn {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.15);
      border: none;
      border-radius: 20px;
      color: white;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .new-playlist-btn:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .playlist-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      overflow-x: auto;
      padding-bottom: 5px;
    }

    .playlist-tab {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 20px;
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      position: relative;
    }

    .playlist-tab.active {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      transform: scale(1.02);
    }

    .playlist-tab:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .playlist-content {
      max-height: 300px;
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .playlist-content::-webkit-scrollbar {
      display: none;
    }

    .track-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }

    .track-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.1);
      transform: translateX(4px);
    }

    .track-item.playing {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .track-cover {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      object-fit: cover;
      margin-right: 12px;
      background: rgba(255, 255, 255, 0.1);
    }

    .track-details {
      flex: 1;
      min-width: 0;
    }

    .track-name {
      font-size: 14px;
      font-weight: 600;
      color: white;
      margin-bottom: 2px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .track-duration {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(40px);
      border-radius: 20px;
      padding: 30px;
      width: 90%;
      max-width: 400px;
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: white;
      margin-bottom: 20px;
      text-align: center;
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .modal-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .modal-btn.primary {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .modal-btn.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.8);
    }

    .modal-btn:hover {
      transform: translateY(-1px);
    }

    .loading {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .slide-in {
      animation: slideIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    @media (max-width: 480px) {
      .main-container {
        margin: 20px auto;
        padding: 0 15px;
      }

      .cover-container {
        width: 240px;
        height: 240px;
      }

      .player-section {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="header">
      <h1>Music</h1>
    </div>

    <!-- Player Section -->
    <div class="glass-container player-section slide-in">
      <div class="cover-container">
        <img id="coverImage" class="cover-image" style="display: none;" />
        <div id="coverPlaceholder" class="cover-placeholder">♫</div>
      </div>

      <div class="track-info">
        <div class="track-title" id="trackTitle">No song selected</div>
        <div class="track-artist" id="trackArtist">Choose a track to play</div>
      </div>

      <div class="controls">
        <button class="control-btn" id="prevBtn">⏮</button>
        <button class="control-btn play-btn" id="playBtn">▶</button>
        <button class="control-btn" id="nextBtn">⏭</button>
      </div>

      <div class="progress-container">
        <div class="progress-bar" id="progressBar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="time-info">
          <span id="currentTime">0:00</span>
          <span id="totalTime">0:00</span>
        </div>
      </div>

      <audio id="audioPlayer"></audio>
    </div>

    <!-- File Input Section -->
    <div class="glass-container file-inputs slide-in">
      <div class="input-group">
        <label class="input-label">Audio File (.mp3)</label>
        <div class="file-input-wrapper">
          <input type="file" id="audioInput" class="file-input" accept=".mp3" />
          <label for="audioInput" class="file-input-label">Choose MP3 File</label>
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">Cover Image (Optional)</label>
        <div class="file-input-wrapper">
          <input type="file" id="imageInput" class="file-input" accept="image/*" />
          <label for="imageInput" class="file-input-label">Choose Cover Image</label>
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">Track Title</label>
        <input type="text" id="titleInput" class="text-input" placeholder="Enter track title" />
      </div>

      <div class="input-group">
        <label class="input-label">Add to Playlist</label>
        <select id="playlistSelect" class="select-input">
          <option value="">Select playlist...</option>
        </select>
      </div>

      <button class="add-btn" id="addTrackBtn">Add Track</button>
    </div>

    <!-- Playlists Section -->
    <div class="glass-container playlists-section slide-in">
      <div class="section-header">
        <h2 class="section-title">Playlists</h2>
        <button class="new-playlist-btn" id="newPlaylistBtn">New Playlist</button>
      </div>

      <div class="playlist-tabs" id="playlistTabs"></div>
      <div class="playlist-content" id="playlistContent"></div>
    </div>
  </div>

  <!-- New Playlist Modal -->
  <div class="modal" id="newPlaylistModal">
    <div class="modal-content">
      <h3 class="modal-title">Create New Playlist</h3>
      <input type="text" id="newPlaylistName" class="text-input" placeholder="Playlist name" />
      <div class="modal-buttons">
        <button class="modal-btn secondary" id="cancelBtn">Cancel</button>
        <button class="modal-btn primary" id="createPlaylistBtn">Create</button>
      </div>
    </div>
  </div>

  <script>
    class MusicPlayer {
      constructor() {
        this.playlists = JSON.parse(localStorage.getItem('musicPlaylists')) || { 'My Music': [] };
        this.currentPlaylist = localStorage.getItem('currentPlaylist') || 'My Music';
        this.currentTrackIndex = parseInt(localStorage.getItem('currentTrackIndex')) || 0;
        this.currentTime = parseFloat(localStorage.getItem('currentTime')) || 0;
        this.isPlaying = false;

        this.initElements();
        this.initEventListeners();
        this.loadSession();
        this.renderPlaylists();
        this.updatePlaylistSelect();
      }

      initElements() {
        this.audioPlayer = document.getElementById('audioPlayer');
        this.playBtn = document.getElementById('playBtn');
        this.prevBtn = document.getElementById('prevBtn');
        this.nextBtn = document.getElementById('nextBtn');
        this.progressBar = document.getElementById('progressBar');
        this.progressFill = document.getElementById('progressFill');
        this.currentTimeEl = document.getElementById('currentTime');
        this.totalTimeEl = document.getElementById('totalTime');
        this.trackTitle = document.getElementById('trackTitle');
        this.trackArtist = document.getElementById('trackArtist');
        this.coverImage = document.getElementById('coverImage');
        this.coverPlaceholder = document.getElementById('coverPlaceholder');
        this.audioInput = document.getElementById('audioInput');
        this.imageInput = document.getElementById('imageInput');
        this.titleInput = document.getElementById('titleInput');
        this.playlistSelect = document.getElementById('playlistSelect');
        this.addTrackBtn = document.getElementById('addTrackBtn');
        this.playlistTabs = document.getElementById('playlistTabs');
        this.playlistContent = document.getElementById('playlistContent');
        this.newPlaylistBtn = document.getElementById('newPlaylistBtn');
        this.newPlaylistModal = document.getElementById('newPlaylistModal');
        this.newPlaylistName = document.getElementById('newPlaylistName');
        this.createPlaylistBtn = document.getElementById('createPlaylistBtn');
        this.cancelBtn = document.getElementById('cancelBtn');
        this.favicon = document.getElementById('favicon');
      }

      initEventListeners() {
        this.playBtn.addEventListener('click', () => this.togglePlay());
        this.prevBtn.addEventListener('click', () => this.previousTrack());
        this.nextBtn.addEventListener('click', () => this.nextTrack());
        this.progressBar.addEventListener('click', (e) => this.setProgress(e));
        this.addTrackBtn.addEventListener('click', () => this.addTrack());
        this.newPlaylistBtn.addEventListener('click', () => this.showNewPlaylistModal());
        this.createPlaylistBtn.addEventListener('click', () => this.createPlaylist());
        this.cancelBtn.addEventListener('click', () => this.hideNewPlaylistModal());

        this.audioPlayer.addEventListener('loadeddata', () => this.onAudioLoaded());
        this.audioPlayer.addEventListener('timeupdate', () => this.updateProgress());
        this.audioPlayer.addEventListener('ended', () => this.nextTrack());
        this.audioPlayer.addEventListener('play', () => this.onPlay());
        this.audioPlayer.addEventListener('pause', () => this.onPause());

        setInterval(() => this.saveSession(), 5000);
      }

      togglePlay() {
        if (this.audioPlayer.src) {
          if (this.isPlaying) {
            this.audioPlayer.pause();
          } else {
            this.audioPlayer.play();
          }
        }
      }

      onPlay() {
        this.isPlaying = true;
        this.playBtn.textContent = '⏸';
        this.playBtn.classList.add('loading');
      }

      onPause() {
        this.isPlaying = false;
        this.playBtn.textContent = '▶';
        this.playBtn.classList.remove('loading');
      }

      previousTrack() {
        const currentTracks = this.playlists[this.currentPlaylist] || [];
        if (currentTracks.length > 0) {
          this.currentTrackIndex = this.currentTrackIndex > 0 ? this.currentTrackIndex - 1 : currentTracks.length - 1;
          this.playTrack(this.currentTrackIndex);
        }
      }

      nextTrack() {
        const currentTracks = this.playlists[this.currentPlaylist] || [];
        if (currentTracks.length > 0) {
          this.currentTrackIndex = (this.currentTrackIndex + 1) % currentTracks.length;
          this.playTrack(this.currentTrackIndex);
        }
      }

      playTrack(index) {
        const currentTracks = this.playlists[this.currentPlaylist] || [];
        const track = currentTracks[index];

        if (!track) return;

        this.currentTrackIndex = index;
        this.audioPlayer.src = track.audio;
        this.trackTitle.textContent = track.title;
        this.trackArtist.textContent = track.artist || 'Unknown Artist';
        document.title = track.title;

        if (track.image) {
          this.coverImage.src = track.image;
          this.coverImage.style.display = 'block';
          this.coverPlaceholder.style.display = 'none';
          this.favicon.href = track.image;
        } else {
          this.coverImage.style.display = 'none';
          this.coverPlaceholder.style.display = 'flex';
          this.favicon.href = '';
        }

        this.renderPlaylistContent();
        this.audioPlayer.play();
        this.saveSession();
      }

      onAudioLoaded() {
        this.totalTimeEl.textContent = this.formatTime(this.audioPlayer.duration);
        if (this.currentTime > 0) {
          this.audioPlayer.currentTime = this.currentTime;
          this.currentTime = 0;
        }
      }

      updateProgress() {
        if (this.audioPlayer.duration) {
          const progress = (this.audioPlayer.currentTime / this.audioPlayer.duration) * 100;
          this.progressFill.style.width = progress + '%';
          this.currentTimeEl.textContent = this.formatTime(this.audioPlayer.currentTime);
        }
      }

      setProgress(e) {
        if (this.audioPlayer.duration) {
          const rect = this.progressBar.getBoundingClientRect();
          const percent = (e.clientX - rect.left) / rect.width;
          this.audioPlayer.currentTime = percent * this.audioPlayer.duration;
        }
      }

      formatTime(seconds) {
        if (isNaN(seconds)) return '0:00';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return mins + ':' + (secs < 10 ? '0' : '') + secs;
      }

      addTrack() {
        const audioFile = this.audioInput.files[0];
        const imageFile = this.imageInput.files[0];
        const title = this.titleInput.value.trim() || 'Untitled';
        const selectedPlaylist = this.playlistSelect.value;

        if (!audioFile || !selectedPlaylist) {
          alert('Please select an audio file and playlist');
          return;
        }

        const audioReader = new FileReader();
        audioReader.onload = (e) => {
          const track = {
            id: Date.now(),
            title: title,
            artist: 'Unknown Artist',
            audio: e.target.result,
            duration: 0
          };

          if (imageFile) {
            const imageReader = new FileReader();
            imageReader.onload = (e2) => {
              track.image = e2.target.result;
              this.saveTrack(track, selectedPlaylist);
            };
            imageReader.readAsDataURL(imageFile);
          } else {
            this.saveTrack(track, selectedPlaylist);
          }
        };
        audioReader.readAsDataURL(audioFile);
      }

      saveTrack(track, playlistName) {
        if (!this.playlists[playlistName]) {
          this.playlists[playlistName] = [];
        }

        this.playlists[playlistName].push(track);
        this.savePlaylists();
        this.renderPlaylistContent();

        this.audioInput.value = '';
        this.imageInput.value = '';
        this.titleInput.value = '';
        this.playlistSelect.value = '';
      }

      createPlaylist() {
        const name = this.newPlaylistName.value.trim();
        if (name && !this.playlists[name]) {
          this.playlists[name] = [];
          this.savePlaylists();
          this.renderPlaylists();
          this.updatePlaylistSelect();
          this.hideNewPlaylistModal();
          this.newPlaylistName.value = '';
        }
      }

      showNewPlaylistModal() {
        this.newPlaylistModal.style.display = 'flex';
      }

      hideNewPlaylistModal() {
        this.newPlaylistModal.style.display = 'none';
      }

      renderPlaylists() {
        this.playlistTabs.innerHTML = '';

        Object.keys(this.playlists).forEach(playlistName => {
          const tab = document.createElement('button');
          tab.className = 'playlist-tab';
          tab.textContent = playlistName;
          tab.addEventListener('click', () => this.switchPlaylist(playlistName));

          if (playlistName === this.currentPlaylist) {
            tab.classList.add('active');
          }

          this.playlistTabs.appendChild(tab);
        });

        this.renderPlaylistContent();
      }

      switchPlaylist(playlistName) {
        this.currentPlaylist = playlistName;
        this.currentTrackIndex = 0;
        this.renderPlaylists();
        this.saveSession();
      }

      renderPlaylistContent() {
        this.playlistContent.innerHTML = '';
        const currentTracks = this.playlists[this.currentPlaylist] || [];

        if (currentTracks.length === 0) {
          const emptyState = document.createElement('div');
          emptyState.style.cssText = `
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
          `;
          emptyState.textContent = 'No tracks in this playlist';
          this.playlistContent.appendChild(emptyState);
          return;
        }

        currentTracks.forEach((track, index) => {
          const trackItem = document.createElement('div');
          trackItem.className = 'track-item';
          if (index === this.currentTrackIndex) {
            trackItem.classList.add('playing');
          }

          trackItem.innerHTML = `
            <img class="track-cover" src="${track.image || ''}" 
                 style="display: ${track.image ? 'block' : 'none'}" />
            <div class="track-details">
              <div class="track-name">${track.title}</div>
              <div class="track-duration">${track.artist || 'Unknown Artist'}</div>
            </div>
          `;

          trackItem.addEventListener('click', () => this.playTrack(index));
          this.playlistContent.appendChild(trackItem);
        });
      }

      updatePlaylistSelect() {
        this.playlistSelect.innerHTML = '<option value="">Select playlist...</option>';

        Object.keys(this.playlists).forEach(playlistName => {
          const option = document.createElement('option');
          option.value = playlistName;
          option.textContent = playlistName;
          this.playlistSelect.appendChild(option);
        });
      }

      savePlaylists() {
        localStorage.setItem('musicPlaylists', JSON.stringify(this.playlists));
      }

      saveSession() {
        localStorage.setItem('currentPlaylist', this.currentPlaylist);
        localStorage.setItem('currentTrackIndex', this.currentTrackIndex.toString());
        localStorage.setItem('currentTime', this.audioPlayer.currentTime.toString());
      }

      loadSession() {
        const currentTracks = this.playlists[this.currentPlaylist] || [];
        if (currentTracks.length > 0 && this.currentTrackIndex < currentTracks.length) {
          const track = currentTracks[this.currentTrackIndex];
          this.audioPlayer.src = track.audio;
          this.trackTitle.textContent = track.title;
          this.trackArtist.textContent = track.artist || 'Unknown Artist';
          document.title = track.title;

          if (track.image) {
            this.coverImage.src = track.image;
            this.coverImage.style.display = 'block';
            this.coverPlaceholder.style.display = 'none';
            this.favicon.href = track.image;
          }
        }
      }
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(err => {
        console.log('Service Worker registration failed:', err);
      });
    }

    const player = new MusicPlayer();

    if ('serviceWorker' in navigator && !navigator.serviceWorker.controller) {
      const swContent = `
        const CACHE_NAME = 'music-player-v1';
        const urlsToCache = [
          '/',
          '/manifest.json'
        ];

        self.addEventListener('install', event => {
          event.waitUntil(
            caches.open(CACHE_NAME)
              .then(cache => cache.addAll(urlsToCache))
          );
        });

        self.addEventListener('fetch', event => {
          event.respondWith(
            caches.match(event.request)
              .then(response => {
                if (response) {
                  return response;
                }
                return fetch(event.request);
              }
            )
          );
        });
      `;

      const blob = new Blob([swContent], { type: 'application/javascript' });
      const swURL = URL.createObjectURL(blob);

      navigator.serviceWorker.register(swURL).then(() => {
        console.log('Service Worker registered successfully');
      }).catch(err => {
        console.log('Service Worker registration failed:', err);
      });
    }

    const manifestContent = {
      "name": "Apple Music Player",
      "short_name": "Music",
      "description": "Offline MP3 Player with Apple Music UI",
      "start_url": "/",
      "display": "standalone",
      "background_color": "#667eea",
      "theme_color": "#667eea",
      "icons": [
        {
          "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23667eea'/%3E%3Ctext x='50' y='60' font-family='Arial' font-size='40' fill='white' text-anchor='middle'%3E♫%3C/text%3E%3C/svg%3E",
          "sizes": "192x192",
          "type": "image/svg+xml"
        }
      ]
    };

    const manifestBlob = new Blob([JSON.stringify(manifestContent)], { type: 'application/json' });
    const manifestURL = URL.createObjectURL(manifestBlob);

    const manifestLink = document.querySelector('link[rel="manifest"]');
    if (manifestLink) {
      manifestLink.href = manifestURL;
    }

    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space' && !e.target.matches('input, textarea')) {
        e.preventDefault();
        player.togglePlay();
      } else if (e.code === 'ArrowLeft' && e.metaKey) {
        e.preventDefault();
        player.previousTrack();
      } else if (e.code === 'ArrowRight' && e.metaKey) {
        e.preventDefault();
        player.nextTrack();
      }
    });

    document.addEventListener('dragover', (e) => {
      e.preventDefault();
      document.body.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
    });

    document.addEventListener('dragleave', (e) => {
      e.preventDefault();
      document.body.style.backgroundColor = '';
    });

    document.addEventListener('drop', (e) => {
      e.preventDefault();
      document.body.style.backgroundColor = '';

      const files = Array.from(e.dataTransfer.files);
      const audioFile = files.find(file => file.type.startsWith('audio/'));
      const imageFile = files.find(file => file.type.startsWith('image/'));

      if (audioFile) {
        const audioInput = document.getElementById('audioInput');
        const imageInput = document.getElementById('imageInput');
        const titleInput = document.getElementById('titleInput');

        const audioDataTransfer = new DataTransfer();
        audioDataTransfer.items.add(audioFile);
        audioInput.files = audioDataTransfer.files;

        if (imageFile) {
          const imageDataTransfer = new DataTransfer();
          imageDataTransfer.items.add(imageFile);
          imageInput.files = imageDataTransfer.files;
        }

        if (!titleInput.value) {
          titleInput.value = audioFile.name.replace(/\.[^/.]+$/, "");
        }
      }
    });

    document.querySelectorAll('.control-btn, .add-btn, .modal-btn, .new-playlist-btn').forEach(btn => {
      btn.addEventListener('mousedown', function() {
        this.style.transform = 'scale(0.95)';
      });

      btn.addEventListener('mouseup', function() {
        this.style.transform = '';
      });

      btn.addEventListener('mouseleave', function() {
        this.style.transform = '';
      });
    });

    document.getElementById('audioInput').addEventListener('change', function() {
      const label = this.nextElementSibling;
      if (this.files[0]) {
        label.textContent = this.files[0].name;
        label.style.color = 'rgba(255, 255, 255, 0.9)';
      } else {
        label.textContent = 'Choose MP3 File';
        label.style.color = '';
      }
    });

    document.getElementById('imageInput').addEventListener('change', function() {
      const label = this.nextElementSibling;
      if (this.files[0]) {
        label.textContent = this.files[0].name;
        label.style.color = 'rgba(255, 255, 255, 0.9)';
      } else {
        label.textContent = 'Choose Cover Image';
        label.style.color = '';
      }
    });

    if (Object.keys(player.playlists).length === 0) {
      player.playlists['My Music'] = [];
      player.savePlaylists();
    }
  </script>
</body>
</html>
