<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Apple Music 2025</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <style>
        :root {
            --system-red: #ff3b30;
            --system-pink: #ff2d55;
            --system-orange: #ff9500;
            --system-yellow: #ffcc00;
            --system-green: #34c759;
            --system-teal: #5ac8fa;
            --system-blue: #007aff;
            --system-indigo: #5856d6;
            --system-purple: #af52de;
            --system-gray: #8e8e93;
            --system-gray-2: #aeaeb2;
            --system-gray-3: #c7c7cc;
            --system-gray-4: #d1d1d6;
            --system-gray-5: #e5e5ea;
            --system-gray-6: #1c1c1e;
            --fill-tertiary: rgba(118,118,128,0.24);
            --border-color: rgba(255,255,255,0.15);
            --safe-area-top: env(safe-area-inset-top, 20px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --app-background: linear-gradient(135deg, #0a0a0c 0%, #1a1a1e 100%);
            --card-gradient: linear-gradient(135deg, rgba(40,40,45,0.8) 0%, rgba(30,30,35,0.9) 100%);
            --now-playing-gradient: linear-gradient(to bottom, rgba(30,30,35,0.95) 0%, rgba(20,20,25,0.98) 100%);
            --accent-gradient: linear-gradient(135deg, #ff2d55 0%, #ff5e3a 100%);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            background: var(--app-background);
            color: #fff;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            display: flex;
            flex-direction: column;
            background: var(--app-background);
        }
        
        .app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        
        .view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s cubic-bezier(0.28, 0.11, 0.32, 1), 
                        transform 0.4s cubic-bezier(0.28, 0.11, 0.32, 1),
                        visibility 0.4s;
            background: var(--app-background);
            z-index: 10;
            transform: translateY(20px);
        }
        
        .view.active {
            opacity: 1;
            visibility: visible;
            z-index: 20;
            transform: translateY(0);
        }
        
        /* Enhanced Header Styles */
        .header {
            padding: calc(var(--safe-area-top) + 5px) 20px 15px;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 50;
            background: transparent;
        }
        
        .header.large-title h1 {
            font-size: 36px;
            font-weight: 800;
            letter-spacing: -0.5px;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-top: 5px;
        }
        
        .header-profile-icon {
            width: 36px;
            height: 36px;
            background: var(--fill-tertiary);
            color: var(--system-pink);
            border-radius: 50%;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.2s ease;
        }
        
        .header-profile-icon:active {
            transform: scale(0.95);
        }
        
        .header-with-back {
            padding: calc(var(--safe-area-top) + 5px) 10px 15px;
            background: rgba(20,20,25,0.8);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        
        .header-with-back .back-btn {
            font-size: 18px;
            color: var(--system-pink);
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 8px;
            border-radius: 10px;
            transition: background 0.2s;
        }
        
        .header-with-back .back-btn:active {
            background: rgba(255,255,255,0.1);
        }
        
        .header-with-back h1 {
            font-size: 20px;
            font-weight: 700;
            flex: 1;
            text-align: center;
            margin: 0 10px;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
            min-width: 40px;
            justify-content: flex-end;
            align-items: center;
        }
        
        .header-actions .icon-btn, .round-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 22px;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s, transform 0.2s;
        }
        
        .header-actions .icon-btn:active, .round-btn:active {
            background: rgba(255,255,255,0.1);
            transform: scale(0.9);
        }
        
        .header-actions .header-plus-btn {
            color: var(--system-pink);
            font-size: 16px;
            background: rgba(255,45,85,0.2);
        }
        
        /* Enhanced Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: none;
            padding-bottom: 130px;
            position: relative;
            z-index: 10;
        }
        
        .main-content::-webkit-scrollbar {
            display: none;
        }
        
        /* Search Bar */
        .search-bar {
            padding: 15px 20px;
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 14px 50px 14px 45px;
            background-color: rgba(30,30,35,0.8);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 14px;
            color: #fff;
            font-size: 17px;
            background-image: url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' fill='%238e8e93' viewBox='0 0 24 24'%3E%3Cpath d='M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 15px center;
            background-size: 20px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            background-color: rgba(40,40,45,0.9);
            border-color: var(--system-pink);
            box-shadow: 0 0 0 2px rgba(255,45,85,0.3);
        }
        
        .search-input-mic {
            position: absolute;
            right: 35px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--system-gray);
            font-size: 18px;
            background: rgba(255,255,255,0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Section Header */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 20px 15px;
        }
        
        .section-header h2 {
            font-size: 26px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }
        
        .view-all {
            color: var(--system-pink);
            font-size: 16px;
            font-weight: 600;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 12px;
            padding: 15px 20px;
        }
        
        .action-btn {
            flex: 1;
            background: var(--card-gradient);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 14px;
            color: #fff;
            padding: 15px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        .action-btn i {
            margin-right: 10px;
            font-size: 18px;
        }
        
        .action-btn:active {
            transform: scale(0.98);
            background: rgba(50,50,55,0.9);
        }
        
        /* Enhanced List Items */
        .list-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .list-item:first-child {
            border-top: 1px solid var(--border-color);
        }
        
        .list-item:active {
            background: rgba(255,255,255,0.05);
        }
        
        .list-icon {
            color: var(--system-pink);
            width: 40px;
            font-size: 24px;
            margin-right: 15px;
            text-align: center;
        }
        
        .list-text {
            flex: 1;
            font-size: 18px;
            font-weight: 500;
        }
        
        .list-arrow {
            color: var(--system-gray);
            font-size: 14px;
        }
        
        .list-item-swipe-container {
            position: relative;
            overflow: hidden;
            border-radius: 14px;
            margin: 0 15px 8px;
            background: var(--card-gradient);
            border: 1px solid rgba(255,255,255,0.08);
        }
        
        .list-item-swipe-inner {
            display: flex;
            width: 100%;
            transform: translateX(0);
            transition: transform 0.3s ease;
            will-change: transform;
        }
        
        .list-item-swipe-content {
            flex-shrink: 0;
            width: 100%;
            display: flex;
            align-items: center;
            background: transparent;
            padding: 12px 15px;
        }
        
        .list-item-actions {
            flex-shrink: 0;
            display: flex;
            height: 100%;
            white-space: nowrap;
        }
        
        .list-action-btn {
            height: 100%;
            padding: 0 25px;
            color: #fff;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .action-edit {
            background: rgba(100,100,110,0.8);
        }
        
        .action-delete {
            background: rgba(255,59,48,0.8);
        }
        
        /* Song List Styles */
        .song-list-artwork {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            margin-right: 15px;
            background: var(--system-gray-6);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .song-list-info-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .song-list-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .song-list-title {
            font-size: 18px;
            display: flex;
            align-items: center;
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .song-list-artist {
            font-size: 15px;
            color: var(--system-gray-2);
        }
        
        .song-menu-btn {
            color: var(--system-gray);
            font-size: 18px;
            padding: 10px;
        }
        
        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 0 20px;
        }
        
        .grid-item {
            cursor: pointer;
            transition: transform 0.3s ease;
            border-radius: 14px;
            overflow: hidden;
            background: var(--card-gradient);
            border: 1px solid rgba(255,255,255,0.08);
        }
        
        .grid-item:active {
            transform: scale(0.98);
        }
        
        .grid-item img {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
            display: block;
        }
        
        .grid-item-content {
            padding: 15px;
        }
        
        .grid-item-title {
            font-size: 16px;
            line-height: 1.3;
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            min-height: 1.3em;
            margin-bottom: 4px;
        }
        
        .grid-item-subtitle {
            font-size: 14px;
            color: var(--system-gray-2);
            min-height: 1.2em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Playlist Items */
        .playlist-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            cursor: pointer;
            width: 100%;
        }
        
        .playlist-item-artwork {
            width: 70px;
            height: 70px;
            border-radius: 8px;
            margin-right: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #1c1c1e;
            background-size: cover;
            background-position: center;
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }
        
        #favorite-playlist-artwork {
            background-image: var(--accent-gradient);
        }
        
        #favorite-playlist-artwork .fa-star {
            font-size: 32px;
            color: white;
        }
        
        .playlist-info {
            flex: 1;
        }
        
        .playlist-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .playlist-subtitle {
            font-size: 15px;
            color: var(--system-gray-2);
        }
        
        /* Search Categories */
        .search-category-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 15px 20px;
        }
        
        .category-item {
            position: relative;
            cursor: pointer;
            border-radius: 16px;
            overflow: hidden;
            transition: transform 0.3s ease;
            height: 0;
            padding-bottom: 66.66%; /* 3:2 aspect ratio */
        }
        
        .category-item:active {
            transform: scale(0.98);
        }
        
        .category-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .category-item::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 16px;
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.3) 100%);
            z-index: 1;
        }
        
        .category-item[data-color="red"]::before {
            background: linear-gradient(to top, rgba(255,59,48,0.7) 0%, rgba(255,59,48,0.3) 100%);
        }
        
        .category-title {
            position: absolute;
            bottom: 18px;
            left: 18px;
            font-size: 18px;
            font-weight: 700;
            color: #fff;
            z-index: 2;
        }
        
        /* Tab Bar */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(28,28,30,0.95);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            display: flex;
            padding-top: 10px;
            padding-bottom: calc(var(--safe-area-bottom) + 10px);
            border-top: 0.5px solid rgba(255,255,255,0.15);
            z-index: 500;
        }
        
        .tab-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            color: var(--system-gray-3);
            transition: color 0.2s;
            position: relative;
        }
        
        .tab-item.active {
            color: var(--system-pink);
        }
        
        .tab-item.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            width: 5px;
            height: 5px;
            background: var(--system-pink);
            border-radius: 50%;
        }
        
        .tab-icon {
            font-size: 22px;
            margin-bottom: 4px;
        }
        
        .tab-label {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.2px;
        }
        
        /* Now Playing Bar */
        .now-playing-bar {
            position: fixed;
            bottom: calc(65px + var(--safe-area-bottom));
            left: 15px;
            right: 15px;
            background: var(--now-playing-gradient);
            padding: 12px;
            border-radius: 16px;
            display: none;
            align-items: center;
            cursor: pointer;
            z-index: 600;
            transform: translateY(0);
            transition: transform 0.4s ease-in-out;
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .now-playing-bar.active {
            display: flex;
            animation: slideUp 0.5s ease;
        }
        
        @keyframes slideUp {
            0% { transform: translateY(100px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        .app-container.player-visible .now-playing-bar {
            display: none;
        }
        
        .now-playing-artwork {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            object-fit: cover;
            margin-right: 15px;
            background: #1c1c1e;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .now-playing-info {
            flex: 1;
            font-size: 16px;
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .now-playing-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-right: 5px;
        }
        
        .now-playing-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 22px;
            cursor: pointer;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .now-playing-btn:active {
            background: rgba(255,255,255,0.1);
        }
        
        /* Player View */
        #player-view .main-content {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 0 30px;
            flex-grow: 1;
        }
        
        #player-view .header-with-back {
            background: transparent;
            border: none;
        }
        
        #player-view .player-header-title {
            font-size: 18px;
            font-weight: 700;
            opacity: 0.8;
        }
        
        .player-artwork-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px 0 30px;
        }
        
        .player-artwork {
            width: 100%;
            max-width: 320px;
            aspect-ratio: 1/1;
            border-radius: 16px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            background: #1c1c1e;
            object-fit: cover;
        }
        
        .player-info-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .player-details .title {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 5px;
        }
        
        .player-details .artist {
            font-size: 20px;
            color: var(--system-gray-2);
        }
        
        .favorite-btn {
            font-size: 28px;
            color: #fff;
            background: none;
            border: none;
            cursor: pointer;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .favorite-btn:active {
            background: rgba(255,255,255,0.1);
        }
        
        .favorite-btn.favorited {
            color: var(--system-pink);
        }
        
        .progress-container {
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.15);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--system-pink);
            border-radius: 3px;
            width: 0%;
            position: relative;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(255,45,85,0.8);
        }
        
        .progress-times {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: var(--system-gray);
            margin-top: 10px;
        }
        
        .player-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0;
        }
        
        .control-btn {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 32px;
            transition: transform 0.2s;
        }
        
        .control-btn:active {
            transform: scale(0.9);
        }
        
        .control-btn.main {
            font-size: 64px;
            color: var(--system-pink);
        }
        
        .volume-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .volume-container i {
            color: var(--system-gray);
            font-size: 20px;
        }
        
        .volume-slider {
            flex: 1;
            height: 6px;
            background: rgba(255,255,255,0.15);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }
        
        #volume-fill {
            height: 100%;
            background: #fff;
            border-radius: 3px;
            width: 50%;
        }
        
        .player-extra-controls {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 20px 0;
        }
        
        .player-extra-controls .control-btn {
            font-size: 24px;
            color: var(--system-gray-3);
        }
        
        .player-extra-controls .repeat-btn {
            color: var(--system-gray-3);
        }
        
        .player-extra-controls .repeat-btn.active {
            color: var(--system-pink);
        }
        
        /* Explicit Tag */
        .song-list-title.explicit::after,
        .player-details.title.explicit::after {
            content: 'E';
            font-size: 11px;
            font-weight: 700;
            background: rgba(255,255,255,0.2);
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        /* Modal Views */
        .modal-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--app-background);
            z-index: 1100;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.28, 0.11, 0.32, 1);
        }
        
        .modal-view.active {
            transform: translateY(0);
        }
        
        .modal-form-container {
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .modal-artwork-section {
            text-align: center;
        }
        
        .modal-artwork-preview {
            width: 180px;
            height: 180px;
            background: #333;
            border-radius: 16px;
            margin: 0 auto 20px;
            object-fit: cover;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 2px dashed rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.3);
            font-size: 14px;
            text-align: center;
            padding: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            color: var(--system-gray-2);
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .form-group input, .form-group button {
            background: rgba(40,40,45,0.8);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 14px;
            padding: 16px;
            font-size: 18px;
            color: #fff;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            border-color: var(--system-pink);
        }
        
        .form-group button {
            background: var(--accent-gradient);
            border: none;
            cursor: pointer;
            font-weight: 700;
            margin-top: 10px;
            transition: transform 0.2s, opacity 0.2s;
        }
        
        .form-group button:active {
            transform: scale(0.98);
            opacity: 0.9;
        }
        
        .form-group .secondary-btn {
            background: rgba(50,50,55,0.8);
        }
        
        .hidden {
            display: none;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        .loading-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        .spinner {
            border: 4px solid rgba(255,255,255,0.2);
            border-top: 4px solid var(--system-pink);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            color: var(--system-gray-3);
            padding: 50px 20px;
            font-size: 18px;
        }
        
        /* File Upload Improvements */
        .file-upload-container {
            position: relative;
            margin-top: 20px;
        }
        
        .file-upload-label {
            display: block;
            padding: 20px;
            background: rgba(40,40,45,0.8);
            border: 2px dashed rgba(255,255,255,0.1);
            border-radius: 14px;
            text-align: center;
            color: var(--system-gray-2);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload-label i {
            display: block;
            font-size: 36px;
            margin-bottom: 15px;
            color: var(--system-pink);
        }
        
        .file-upload-label:hover {
            border-color: var(--system-pink);
            background: rgba(50,50,55,0.9);
        }
        
        .file-name {
            display: block;
            margin-top: 15px;
            font-size: 14px;
            color: var(--system-gray-2);
            text-align: center;
        }
        
        /* Multi Edit Improvements */
        .multi-edit-view .modal-form-container {
            padding: 20px;
        }
        
        .multi-edit-view .form-group {
            margin-bottom: 15px;
        }
        
        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: calc(80px + var(--safe-area-bottom));
            right: 25px;
            width: 60px;
            height: 60px;
            background: var(--accent-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            box-shadow: 0 10px 30px rgba(255,45,85,0.4);
            z-index: 400;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .fab:active {
            transform: scale(0.95);
            box-shadow: 0 5px 15px rgba(255,45,85,0.3);
        }
        
        /* Pulse Animation for Now Playing */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 2s infinite ease-in-out;
        }
        
        /* Responsive Adjustments */
        @media (min-width: 768px) {
            .grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .search-category-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .player-artwork {
                max-width: 400px;
            }
        }
    </style>
</head>
<body>
  <div class="app-container">
    <!-- Main Views -->
    <div id="home-view" class="view"><div class="header large-title"><h1>Home</h1></div></div>
    <div id="new-view" class="view"><div class="header large-title"><h1>New</h1></div></div>
    <div id="radio-view" class="view"><div class="header large-title"><h1>Radio</h1></div></div>

    <div id="library-view" class="view">
        <div class="header large-title"><h1>Library</h1><div class="header-actions"><button class="round-btn header-plus-btn" data-action="openUploadModal"><i class="fas fa-plus"></i></button><div class="header-profile-icon"><i class="fas fa-user"></i></div></div></div>
        <div class="main-content" id="library-content"></div>
    </div>
    <div id="sub-view" class="view">
        <div class="header header-with-back">
            <button class="back-btn" data-action="goBack"><i class="fas fa-chevron-left"></i> <span id="back-btn-text"></span></button>
            <h1 id="sub-view-title"></h1>
            <div class="header-actions" id="sub-view-actions"></div>
        </div>
        <div class="main-content" id="sub-view-content"></div>
    </div>
    <div id="search-view" class="view">
      <div class="header large-title"><h1>Search</h1><div class="header-profile-icon"><i class="fas fa-user"></i></div></div>
      <div class="main-content">
        <div class="search-bar"><input type="text" class="search-input" id="search-input" placeholder="Artists, Songs, and Albums"><i class="fas fa-microphone search-input-mic"></i></div>
        <div id="search-results-container" class="hidden"></div>
        <div id="search-categories">
            <div class="section-header"><h2>Browse Categories</h2></div>
            <div class="search-category-grid">
                <div class="category-item" data-color="red"><img src="https://images.unsplash.com/photo-1516450360452-9312f5e86fc7?w=400&auto=format&fit=crop" alt=""><span class="category-title">Set Lists</span></div>
                <div class="category-item" data-color="red"><img src="https://images.unsplash.com/photo-1525362083236-02439a1d1478?w=400&auto=format&fit=crop" alt=""><span class="category-title">Alternative</span></div>
            </div>
        </div>
      </div>
    </div>
<div id="upload-view" class="modal-view view">
    <div class="header header-with-back">
        <button class="back-btn" data-action="closeUploadModal">Cancel</button>
        <h1 style="text-align: center;">Add Music</h1>
        <div class="header-actions" style="min-width: 60px;"><button class="back-btn" data-action="submitUpload">Done</button></div>
    </div>
    <div class="main-content">
        <form class="modal-form-container" id="upload-form">
            <div class="modal-artwork-section"><img id="upload-artwork-preview" class="modal-artwork-preview" src="https://via.placeholder.com/150?text=Artwork" data-action="triggerArtworkUpload" alt="Artwork Preview"><input type="file" id="artwork-input" class="hidden" accept="image/*"></div>
            <div class="form-group"><label for="song-title-input">TITLE</label><input type="text" id="song-title-input" required></div>
            <div class="form-group"><label for="song-artist-input">ARTIST</label><input type="text" id="song-artist-input" required></div>
            <div class="form-group"><label for="song-album-input">ALBUM</label><input type="text" id="song-album-input" required></div>
            <div class="form-group"><button type="button" class="secondary-btn" data-action="triggerSongUpload">Select Song File</button><span id="song-file-name" style="color: var(--system-gray); font-size: 14px; margin-top: 8px; text-align: center;">No file selected.</span><input type="file" id="music-file-input" class="hidden" accept=".mp3"></div>
            <div class="form-group"><button type="button" class="secondary-btn" data-action="openPlaylistSelector">Add to Playlist (Optional)</button><span id="selected-playlist-name" style="color: var(--system-gray); font-size: 14px; margin-top: 8px; text-align: center;">No playlist selected.</span></div>
        </form>
    </div>
</div>
<div id="playlist-selector-view" class="modal-view view select-playlist-modal">
    <div class="header header-with-back">
        <button class="back-btn" data-action="closePlaylistSelector">Back</button>
        <h1 style="text-align: center;">Select Playlist</h1>
        <div class="header-actions" style="min-width: 60px;"></div>
    </div>
    <div class="main-content" id="playlist-selector-list"></div>
</div>
<div id="create-playlist-view" class="modal-view view">
    <div class="header header-with-back">
        <button class="back-btn" data-action="closeCreatePlaylistModal">Cancel</button>
        <h1 style="text-align: center;">New Playlist</h1>
        <div class="header-actions" style="min-width: 60px;"><button class="back-btn" data-action="submitCreatePlaylist">Done</button></div>
    </div>
    <div class="main-content">
        <form class="modal-form-container" id="create-playlist-form">
            <div class="modal-artwork-section"><img id="playlist-artwork-preview" class="modal-artwork-preview" src="https://via.placeholder.com/150?text=Artwork" data-action="triggerPlaylistArtworkUpload" alt="Playlist Artwork Preview"><input type="file" id="playlist-artwork-input" class="hidden" accept="image/*"></div>
            <div class="form-group"><label for="playlist-name-input">PLAYLIST NAME</label><input type="text" id="playlist-name-input" required></div>
        </form>
    </div>
</div>

<!-- New Multi-Edit Modal -->
<div id="multi-edit-view" class="modal-view view">
    <div class="header header-with-back">
        <button class="back-btn" data-action="closeMultiEditModal">Cancel</button>
        <h1 style="text-align: center;">Edit Songs (<span id="multi-edit-count">0</span> Selected)</h1>
        <div class="header-actions" style="min-width: 60px;"><button class="back-btn" data-action="submitMultiEdit">Save</button></div>
    </div>
    <div class="main-content">
        <form class="modal-form-container" id="multi-edit-form">
            <p style="color: var(--system-gray); font-size: 14px; text-align: center; margin-bottom: 20px;">Changes will apply to all selected songs.</p>
            <div class="modal-artwork-section"><img id="multi-edit-artwork-preview" class="modal-artwork-preview" src="https://via.placeholder.com/150?text=Artwork" data-action="triggerMultiArtworkUpload" alt="Artwork Preview"><input type="file" id="multi-artwork-input" class="hidden" accept="image/*"></div>
            <div class="form-group"><label for="multi-artist-input">ARTIST</label><input type="text" id="multi-artist-input"></div>
            <div class="form-group"><label for="multi-album-input">ALBUM</label><input type="text" id="multi-album-input"></div>
        </form>
    </div>
</div>

<div id="player-view" class="view">
    <div class="header header-with-back">
        <button class="back-btn" data-action="hideFullPlayer"><i class="fas fa-chevron-down"></i></button>
        <h1 class="player-header-title">Now Playing</h1>
        <div style="width: 40px; height: 100%;"></div> 
    </div>
    <div class="main-content">
        <div class="player-artwork-container">
            <img id="player-artwork" class="player-artwork" src="" alt="">
        </div>
        <div>
            <div class="player-info-container">
                <div class="player-details"><div id="player-title" class="title">Not Playing</div><div id="player-artist" class="artist"></div></div>
                <button class="round-btn favorite-btn" data-action="toggleFavorite"><i class="far fa-star"></i></button>
            </div>
            <div class="progress-container" data-action="seek"><div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div><div class="progress-times"><span id="current-time">0:00</span><span id="total-time">0:00</span></div></div>
            <div class="player-controls">
              <button class="control-btn" data-action="prevSong"><i class="fas fa-backward-step"></i></button>
              <button class="control-btn main" data-action="togglePlay"><i id="main-play-icon" class="fas fa-play-circle"></i></button>
              <button class="control-btn" data-action="nextSong"><i class="fas fa-forward-step"></i></button></div>
            <div class="volume-container">
              <i class="fas fa-volume-down"></i><div class="volume-slider" data-action="setVolume"><div class="progress-fill" id="volume-fill" style="width: 50%;"></div></div><i class="fas fa-volume-up"></i></div>
            <div class="player-extra-controls">
              <button class="control-btn"><i class="fas fa-comment-dots"></i></button>
              <button class="control-btn repeat-btn" data-action="toggleRepeat"><i id="repeat-icon" class="fas fa-repeat"></i></button>
              <button class="control-btn"><i class="fas fa-list-ul"></i></button>
            </div>
        </div>
    </div>
</div>

<div class="now-playing-bar" id="now-playing-bar" data-action="showFullPlayer">
  <img id="np-artwork" class="now-playing-artwork" src="" alt=""><div id="np-title" class="now-playing-info">Not Playing</div>
  <div class="now-playing-controls">
    <button class="now-playing-btn" data-action="togglePlay"><i id="np-play-icon" class="fas fa-play"></i></button>
    <button class="now-playing-btn" data-action="nextSong"><i class="fas fa-forward-step"></i></button>
  </div>
</div>
  </div>
  <div class="tab-bar">
    <div class="tab-item" data-action="showView" data-view="home"><i class="fas fa-house tab-icon"></i><span class="tab-label">Home</span></div>
    <div class="tab-item" data-action="showView" data-view="new"><i class="fas fa-grip tab-icon"></i><span class="tab-label">New</span></div>
    <div class="tab-item" data-action="showView" data-view="radio"><i class="fas fa-tower-broadcast tab-icon"></i><span class="tab-label">Radio</span></div>
    <div class="tab-item active" data-action="showView" data-view="library"><i class="fas fa-rectangle-list tab-icon"></i><span class="tab-label">Library</span></div>
    <div class="tab-item" data-action="showView" data-view="search"><i class="fas fa-magnifying-glass tab-icon"></i><span class="tab-label">Search</span></div>
  </div>
<audio id="audio" preload="metadata"></audio>

  <div class="loading-overlay" id="loading-overlay"><div class="spinner"></div></div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {

    const app = {
        db: null,
        nowPlaying: { id: null, queue: [], currentIndex: -1, isPlaying: false, repeatMode: 'none' }, // 'none', 'queue', 'single'
        library: { songs: [], playlists: [], artists: {}, albums: {} },
        uploadData: { songFile: null, artworkBase64: null, editingId: null, selectedPlaylistId: null },
        multiEdit: { selectedSongIds: [], artworkBase64: null }, // New for multi-edit
    };

    const DOM = {
        views: document.querySelectorAll('.view'),
        appContainer: document.querySelector('.app-container'),
        audio: document.getElementById('audio'),
        loadingOverlay: document.getElementById('loading-overlay'),
    };

    function init() {
        DB.init().then(() => {
            Library.loadAllData().then(() => {
                UI.renderAll();
                handlePopState(); 
            });
        });
        setupEventListeners();
    }

    function setupEventListeners() {
        document.body.addEventListener('click', handleAction);
        window.addEventListener('popstate', handlePopState);
        DOM.audio.addEventListener('timeupdate', Player.updateProgress);
        DOM.audio.addEventListener('loadedmetadata', Player.updateProgress);
        DOM.audio.addEventListener('ended', Player.nextSong);
        DOM.audio.addEventListener('error', e => { 
            console.error("Audio Element Error:", e);
            // Attempt to skip to the next song on unrecoverable error
            if (e.target.error && e.target.error.code === 4) { // MEDIA_ERR_SRC_NOT_SUPPORTED
                 console.warn("Skipping to next song due to media source error.");
                 Player.nextSong();
            }
        });
        
        document.getElementById('artwork-input').addEventListener('change', e => Upload.handleArtworkFileSelect(e));
        document.getElementById('music-file-input').addEventListener('change', e => Upload.handleSongFileSelect(e));
        document.getElementById('playlist-artwork-input').addEventListener('change', e => Playlist.handleArtworkFileSelect(e));
        document.getElementById('multi-artwork-input').addEventListener('change', e => MultiEdit.handleArtworkFileSelect(e)); // New for multi-edit
        
        document.getElementById('search-input').addEventListener('input', e => UI.handleSearch(e));
        document.getElementById('sub-view-content').addEventListener('input', e => {
            if (e.target.classList.contains('search-input')) UI.handleSubViewSearch(e);
        });
        document.getElementById('sub-view-content').addEventListener('touchstart', e => SwipeList.handleTouchStart(e), { passive: true });
        document.getElementById('sub-view-content').addEventListener('touchmove', e => SwipeList.handleTouchMove(e), { passive: false });
        document.getElementById('sub-view-content').addEventListener('touchend', e => SwipeList.handleTouchEnd(e));
    }
    
    function handleAction(e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        const action = target.dataset.action;
        
        // Prevent click events on now-playing bar's control buttons from propagating to bar itself
        if (target.closest('#now-playing-bar') && (action === 'togglePlay' || action === 'nextSong')) {
            e.stopPropagation();
        }

        // Prevent song play when checkbox is clicked
        if (action === 'handleSongSelect') {
            e.stopPropagation();
        }
        
        const actions = {
            'showView': () => {
                const viewId = `${target.dataset.view}-view`;
                if (document.getElementById(viewId)) {
                    UI.showView(viewId);
                }
            },
            'goBack': UI.goBack,
            'openUploadModal': Upload.openModal,
            'closeUploadModal': Upload.closeModal,
            'openCreatePlaylistModal': Playlist.openModal,
            'closeCreatePlaylistModal': Playlist.closeModal,
            'openPlaylistSelector': Upload.openPlaylistSelector,
            'closePlaylistSelector': Upload.closePlaylistSelector,
            'selectPlaylist': () => Upload.selectPlaylist(parseInt(target.dataset.id)),
            'triggerArtworkUpload': () => document.getElementById('artwork-input').click(),
            'triggerSongUpload': () => document.getElementById('music-file-input').click(),
            'triggerPlaylistArtworkUpload': () => document.getElementById('playlist-artwork-input').click(),
            'triggerMultiArtworkUpload': () => document.getElementById('multi-artwork-input').click(), // New for multi-edit
            'submitUpload': Upload.submit,
            'submitCreatePlaylist': Playlist.submit,
            'showSubView': () => UI.showSubView(target.dataset.type, target.dataset.id),
            'playSong': () => { if (Player.playSong(parseInt(target.dataset.id))) UI.showView('player-view'); },
            'playAlbum': () => { if (Player.playAlbum(target.dataset.album)) UI.showView('player-view'); },
            'playPlaylist': () => { if (Player.playPlaylist(target.dataset.id)) UI.showView('player-view'); },
            'shuffle': () => { if (Player.shuffle(target.dataset.type, target.dataset.id)) UI.showView('player-view'); },
            'togglePlay': Player.togglePlay,
            'nextSong': Player.nextSong,
            'prevSong': Player.prevSong,
            'showFullPlayer': () => {
                if (app.nowPlaying.id) {
                    UI.showView('player-view');
                    history.pushState({ viewId: 'player-view' }, '', '#playing'); 
                }
            },
            'hideFullPlayer': UI.hideFullPlayer,
            'seek': Player.seek,
            'setVolume': Player.setVolume,
            'toggleFavorite': Player.toggleFavorite,
            'toggleRepeat': Player.toggleRepeat, // New
            'editSong': () => Upload.editSong(parseInt(target.dataset.id)),
            'deleteSong': () => Library.deleteSong(parseInt(target.dataset.id)),
            'renamePlaylist': () => Playlist.rename(parseInt(target.dataset.id)),
            'deletePlaylist': () => Playlist.delete(parseInt(target.dataset.id)),
            'toggleMultiSelect': () => UI.toggleMultiSelect(), // New multi-select
            'handleSongSelect': (event) => UI.handleSongSelect(parseInt(target.dataset.id), event.target.checked), // New multi-select
            'openMultiEditModal': () => MultiEdit.openModal(), // New multi-select
            'closeMultiEditModal': () => MultiEdit.closeModal(), // New multi-select
            'submitMultiEdit': () => MultiEdit.submit(), // New multi-select
        };
        
        if (actions[action]) actions[action](e);
    }
    
    function handlePopState() {
        const hash = window.location.hash.slice(1);
        const [path, id] = hash.split('/');

        switch (path) {
            case 'home': UI.showView('home-view', true); break;
            case 'new': UI.showView('new-view', true); break;
            case 'radio': UI.showView('radio-view', true); break;
            case 'search': UI.showView('search-view', true); break;
            case 'playlists':
            case 'artists':
            case 'albums':
            case 'songs':
                UI.showSubView(path, undefined, true);
                break;
            case 'playlistDetail':
            case 'albumDetail':
                UI.showSubView(path, id, true);
                break;
            case 'playing':
                if (app.nowPlaying.id) UI.showView('player-view', true);
                else window.location.hash = 'library'; // Fallback if no song is playing
                break;
            case 'library':
            case '':
            default:
                UI.showView('library-view', true);
                break;
        }
    }
      
    const DB = {
        init: () => new Promise(resolve => {
            const request = indexedDB.open("AppleMusicDB_v17_Final", 1);
            request.onupgradeneeded = e => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains("songs")) db.createObjectStore("songs", { keyPath: "id", autoIncrement: true });
                if (!db.objectStoreNames.contains("playlists")) db.createObjectStore("playlists", { keyPath: "id", autoIncrement: true });
            };
            request.onsuccess = e => { app.db = e.target.result; resolve(); };
            request.onerror = e => { console.error("IndexedDB error:", e.target.errorCode); };
        }),
        add: (store, item) => new Promise((res, rej) => { const r = app.db.transaction(store, 'readwrite').objectStore(store).add(item); r.onsuccess = e => res(e.target.result); r.onerror = rej; }),
        put: (store, item) => new Promise(res => app.db.transaction(store, 'readwrite').objectStore(store).put(item).onsuccess = res),
        delete: (store, id) => new Promise(res => app.db.transaction(store, 'readwrite').objectStore(store).delete(id).onsuccess = res),
        get: (store, id) => new Promise(res => app.db.transaction(store).objectStore(store).get(id).onsuccess = e => res(e.target.result)),
        getAll: store => new Promise(res => app.db.transaction(store).objectStore(store).getAll().onsuccess = e => res(e.target.result)),
        // New: update multiple items in a single transaction
        putAll: (store, items) => new Promise((res, rej) => {
            const transaction = app.db.transaction(store, 'readwrite');
            const objectStore = transaction.objectStore(store);
            let count = items.length;
            if (count === 0) { res(); return; }

            items.forEach(item => {
                const request = objectStore.put(item);
                request.onsuccess = () => {
                    count--;
                    if (count === 0) res();
                };
                request.onerror = (e) => rej(e);
            });
            transaction.onerror = (e) => rej(e);
        }),
    };
      
    const Library = {
        async loadAllData() {
            [app.library.songs, app.library.playlists] = await Promise.all([DB.getAll("songs"), DB.getAll("playlists")]);
            this.processLibrary();
        },
        processLibrary() {
            app.library.artists = {}; app.library.albums = {};
            app.library.songs.forEach(song => {
                const artist = song.artist || "Unknown Artist";
                const album = song.album || "Unknown Album";
                if (!app.library.artists[artist]) app.library.artists[artist] = [];
                app.library.artists[artist].push(song);
                if (!app.library.albums[album]) app.library.albums[album] = { songs: [], artwork: song.artwork, artist: artist };
                app.library.albums[album].songs.push(song);
            });
        },
        async deleteSong(id) {
            if (!confirm("Are you sure you want to delete this song?")) return;
            await DB.delete('songs', id);
            // Also remove from any playlists
            for (const playlist of app.library.playlists) {
                const songIndex = playlist.songs.indexOf(id);
                if (songIndex > -1) {
                    playlist.songs.splice(songIndex, 1);
                    await DB.put('playlists', playlist);
                }
            }
            // If the deleted song is currently playing, stop playback
            if (app.nowPlaying.id === id) {
                Player.pause();
                app.nowPlaying.id = null;
                app.nowPlaying.queue = [];
                app.nowPlaying.currentIndex = -1;
                UI.updatePlayerUI();
            } else {
                // If the deleted song is in the queue, remove it
                const queueIndex = app.nowPlaying.queue.indexOf(id);
                if (queueIndex > -1) {
                    app.nowPlaying.queue.splice(queueIndex, 1);
                    if (queueIndex < app.nowPlaying.currentIndex) {
                        app.nowPlaying.currentIndex--; // Adjust index if song before current was deleted
                    }
                }
            }

            await this.loadAllData(); // Reload all data after changes
            const currentHash = window.location.hash.slice(1);
            const [path, pathId] = currentHash.split('/');
            UI.renderSubView(path, pathId); // Re-render current subview
            UI.renderAll(); // Re-render library home
        }
    };
    
    const Upload = {
        openModal: () => { Upload.resetForm(); UI.showModal('upload-view'); },
        closeModal: () => UI.hideModal('upload-view'),
        resetForm() {
            document.getElementById('upload-form').reset();
            document.getElementById('upload-artwork-preview').src = 'https://via.placeholder.com/150?text=Artwork';
            document.getElementById('song-file-name').textContent = 'No file selected.';
            document.getElementById('selected-playlist-name').textContent = 'No playlist selected.';
            app.uploadData = { songFile: null, artworkBase64: null, editingId: null, selectedPlaylistId: null };
            document.querySelector('#upload-view h1').textContent = "Add Music";
            document.querySelector('#upload-view [data-action="submitUpload"]').textContent = "Done";
        },
        editSong(id) {
            const songToEdit = app.library.songs.find(s => s.id === id);
            if (songToEdit) {
                this.openModal();
                app.uploadData.editingId = id;
                app.uploadData.artworkBase64 = songToEdit.artwork;
                document.querySelector("#upload-view h1").textContent = "Edit Song";
                document.querySelector('#upload-view [data-action="submitUpload"]').textContent = "Save";
                document.getElementById("upload-artwork-preview").src = songToEdit.artwork;
                document.getElementById("song-title-input").value = songToEdit.title;
                document.getElementById("song-artist-input").value = songToEdit.artist;
                document.getElementById("song-album-input").value = songToEdit.album;
                document.getElementById("song-file-name").textContent = songToEdit.file ? songToEdit.file.name : "Original file";
            }
        },
        handleSongFileSelect(e) {
            app.uploadData.songFile = e.target.files[0];
            if (app.uploadData.songFile) {
                document.getElementById("song-file-name").textContent = app.uploadData.songFile.name;
                jsmediatags.read(app.uploadData.songFile, {
                    onSuccess: ({ tags }) => {
                        if (tags) {
                            if (tags.title && !document.getElementById("song-title-input").value) {
                                document.getElementById("song-title-input").value = tags.title;
                            }
                            if (tags.artist && !document.getElementById("song-artist-input").value) {
                                document.getElementById("song-artist-input").value = tags.artist;
                            }
                            if (tags.album && !document.getElementById("song-album-input").value) {
                                document.getElementById("song-album-input").value = tags.album;
                            }
                            if (tags.picture && !app.uploadData.artworkBase64) {
                                app.uploadData.artworkBase64 = `data:${tags.picture.format};base64,${btoa(String.fromCharCode.apply(null, tags.picture.data))}`;
                                document.getElementById("upload-artwork-preview").src = app.uploadData.artworkBase64;
                            }
                        }
                    },
                    onError: (error) => { console.error("jsmediatags error:", error); }
                });
            }
        },
        handleArtworkFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    app.uploadData.artworkBase64 = e.target.result;
                    document.getElementById("upload-artwork-preview").src = app.uploadData.artworkBase64;
                };
                reader.readAsDataURL(file);
            }
        },
        async submit() {
            const title = document.getElementById("song-title-input").value;
            const artist = document.getElementById("song-artist-input").value;
            const album = document.getElementById("song-album-input").value;

            if (!title || !artist || !album) {
                alert("Please fill all fields.");
                return;
            }
            if (!app.uploadData.editingId && !app.uploadData.songFile) {
                alert("Please select a song file.");
                return;
            }
            
            UI.showLoading(true);
            try {
                const existingSong = app.uploadData.editingId ? app.library.songs.find(s => s.id === app.uploadData.editingId) : {};
                const songData = {
                    ...existingSong,
                    title: title,
                    artist: artist,
                    album: album,
                    artwork: app.uploadData.artworkBase64 || existingSong.artwork || "https://via.placeholder.com/300?text=No+Art",
                    addedAt: existingSong.addedAt || Date.now(),
                    isFavorite: existingSong.isFavorite || false
                };

                if (app.uploadData.songFile) {
                    songData.file = app.uploadData.songFile;
                }

                let songId;
                if (app.uploadData.editingId) {
                    await DB.put("songs", songData);
                    songId = app.uploadData.editingId;
                } else {
                    songId = await DB.add("songs", songData);
                }

                if (app.uploadData.selectedPlaylistId) {
                    const playlist = await DB.get("playlists", app.uploadData.selectedPlaylistId);
                    if (playlist && !playlist.songs.includes(songId)) {
                        playlist.songs.push(songId);
                        await DB.put("playlists", playlist);
                    }
                }

                await Library.loadAllData();
                UI.renderAll();
                this.closeModal();
                UI.renderSubView('songs'); // Re-render songs list to show changes
            } catch (error) {
                console.error("Failed to upload/edit song:", error);
                alert("An error occurred. Please try again.");
            } finally {
                UI.showLoading(false);
            }
        },
        openPlaylistSelector() { UI.renderPlaylistSelector(); UI.showModal('playlist-selector-view'); },
        closePlaylistSelector() { UI.hideModal('playlist-selector-view'); },
        selectPlaylist(id) {
            app.uploadData.selectedPlaylistId = id;
            const playlist = app.library.playlists.find(p => p.id === id);
            document.getElementById('selected-playlist-name').textContent = playlist ? playlist.name : 'No playlist selected.';
            this.closePlaylistSelector();
        }
    };

    const Playlist = {
        openModal: () => { Playlist.resetForm(); UI.showModal('create-playlist-view'); },
        closeModal: () => UI.hideModal('create-playlist-view'),
        resetForm() { 
            document.getElementById("create-playlist-form").reset();
            document.getElementById("playlist-artwork-preview").src="https://via.placeholder.com/150?text=Artwork";
            app.playlistData={artworkBase64:null};
        },
        handleArtworkFileSelect(e) { 
             const file = e.target.files[0];
             if(file){
                const reader = new FileReader();
                reader.onload = e => {
                    app.playlistData.artworkBase64 = e.target.result;
                    document.getElementById("playlist-artwork-preview").src = app.playlistData.artworkBase64;
                };
                reader.readAsDataURL(file);
             }
        },
        async submit() {
            const name = document.getElementById("playlist-name-input").value.trim();
            if (!name) return alert("Please enter a playlist name.");
            UI.showLoading(true);
            try {
                await DB.add("playlists", { name, songs: [], artwork: app.playlistData.artworkBase64, createdAt: Date.now() });
                await Library.loadAllData();
                this.closeModal();
                UI.renderSubView('playlists');
            } catch (error) {
                console.error("Failed to create playlist", error);
                alert("An error occurred. Please try again.");
            } finally {
                UI.showLoading(false);
            }
        },
        async rename(id) {
            const playlist = app.library.playlists.find(p => p.id === id);
            if (!playlist) return;
            const newName = prompt("Enter new playlist name:", playlist.name);
            if (newName && newName.trim() !== "") {
                playlist.name = newName.trim();
                await DB.put('playlists', playlist);
                await Library.loadAllData();
                UI.renderSubView('playlists');
                SwipeList.resetAllSwipes();
            }
        },
        async delete(id) {
            const playlist = app.library.playlists.find(p => p.id === id);
            if (!playlist) return;
            if (confirm(`Are you sure you want to delete the playlist "${playlist.name}"?`)) {
                await DB.delete('playlists', id);
                await Library.loadAllData();
                UI.renderSubView('playlists');
            }
        }
    };
    
    // New Multi-Edit Logic
    const MultiEdit = {
        openModal: () => {
            if (app.multiEdit.selectedSongIds.length === 0) {
                alert("Please select at least one song to edit.");
                return;
            }
            MultiEdit.resetForm();
            document.getElementById('multi-edit-count').textContent = app.multiEdit.selectedSongIds.length;
            UI.showModal('multi-edit-view');
        },
        closeModal: () => {
            UI.hideModal('multi-edit-view');
            // Clear multi-select mode after closing the modal
            if (document.getElementById('sub-view-content').classList.contains('multi-select-active')) {
                UI.toggleMultiSelect(false); // Force close multi-select
            }
        },
        resetForm() {
            document.getElementById('multi-edit-form').reset();
            document.getElementById('multi-edit-artwork-preview').src = 'https://via.placeholder.com/150?text=Artwork';
            app.multiEdit.artworkBase64 = null;
        },
        handleArtworkFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    app.multiEdit.artworkBase64 = e.target.result;
                    document.getElementById('multi-edit-artwork-preview').src = app.multiEdit.artworkBase64;
                };
                reader.readAsDataURL(file);
            }
        },
        async submit() {
            UI.showLoading(true);
            try {
                const newArtist = document.getElementById('multi-artist-input').value.trim();
                const newAlbum = document.getElementById('multi-album-input').value.trim();
                const updatedSongs = [];

                for (const songId of app.multiEdit.selectedSongIds) {
                    const song = app.library.songs.find(s => s.id === songId);
                    if (song) {
                        const updatedSong = { ...song };
                        if (newArtist) updatedSong.artist = newArtist;
                        if (newAlbum) updatedSong.album = newAlbum;
                        if (app.multiEdit.artworkBase64) updatedSong.artwork = app.multiEdit.artworkBase64;
                        updatedSongs.push(updatedSong);
                    }
                }

                if (updatedSongs.length > 0) {
                    await DB.putAll('songs', updatedSongs);
                }

                await Library.loadAllData();
                UI.renderAll();
                this.closeModal();
                UI.renderSubView('songs'); // Re-render songs list to show changes
            } catch (error) {
                console.error("Failed to multi-edit songs:", error);
                alert("An error occurred during multi-edit. Please try again.");
            } finally {
                UI.showLoading(false);
            }
        }
    };


    const SwipeList = {
        startX: 0, currentX: 0, target: null, isSwiping: false, threshold: -50, actionsElement: null, actionsWidth: 0,
        handleTouchStart(e) {
            // Disable swipe if multi-select is active
            if (e.target.closest('.multi-select-active')) {
                this.isSwiping = false;
                return;
            }

            const container = e.target.closest('.list-item-swipe-container');
            if(!container) return;
            this.resetAllSwipes(container);
            this.target = container.querySelector('.list-item-swipe-inner');
            this.startX = e.touches[0].clientX;
            this.currentX = this.startX;
            this.isSwiping = true;
            this.target.style.transition = 'transform 0.1s ease-out';
            this.actionsElement = container.querySelector('.list-item-actions');
            this.actionsWidth = this.actionsElement ? this.actionsElement.offsetWidth : 0;
        },
        handleTouchMove(e) {
            if (!this.isSwiping || !this.target) return;
            this.currentX = e.touches[0].clientX;
            let diff = this.currentX - this.startX;

            if (diff > 0) diff = 0;
            if (diff < -this.actionsWidth) diff = -this.actionsWidth;

            this.target.style.transform = `translateX(${diff}px)`;
        },
        handleTouchEnd() {
            if (!this.isSwiping || !this.target) return;
            let diff = this.currentX - this.startX;
            this.target.style.transition = 'transform 0.3s ease';

            if (diff < -this.actionsWidth / 2) {
                this.target.style.transform = `translateX(-${this.actionsWidth}px)`;
            } else {
                this.target.style.transform = 'translateX(0)';
            }
            this.isSwiping = false;
        },
        resetAllSwipes(exclude = null) {
            document.querySelectorAll('.list-item-swipe-container').forEach(container => {
                if (container !== exclude) {
                    const innerContent = container.querySelector('.list-item-swipe-inner');
                    if (innerContent) {
                        innerContent.style.transform = 'translateX(0)';
                    }
                }
            });
        }
    };

    const Player = {
        currentObjectURL: null, // To manage revokeObjectURL for memory cleanup

        playSong(id) {
            const index = app.library.songs.findIndex(s => s.id === id);
            if (index !== -1) {
                app.nowPlaying.queue = app.library.songs.map(s => s.id);
                this.playFromQueue(index);
                return true;
            }
            return false;
        },

        playAlbum(albumName) {
            const album = app.library.albums[albumName];
            if (album && album.songs.length > 0) {
                app.nowPlaying.queue = album.songs.map(s => s.id);
                this.playFromQueue(0);
                return true;
            } else {
                alert("This album is empty.");
                return false;
            }
        },

        playPlaylist(id) {
            const songs = this.getPlaylistSongs(id);
            if (songs.length === 0) {
                alert("This playlist is empty.");
                return false;
            }
            app.nowPlaying.queue = songs.map(s => s.id);
            this.playFromQueue(0);
            return true;
        },

        playFromQueue(index) {
            if (app.nowPlaying.queue.length === 0 || index < 0 || index >= app.nowPlaying.queue.length) {
                this.stop(); // Stop if no valid song to play
                return;
            }

            const songId = app.nowPlaying.queue[index];

            // If the same song is already loaded, just play from current time (or restart if user clicked it)
            if (songId === app.nowPlaying.id && DOM.audio.src) {
                if (app.nowPlaying.currentIndex === index) { // Clicked the same song that's already playing/paused
                    DOM.audio.currentTime = 0; // Restart if it's the same song being explicitly chosen
                }
                this.play();
                app.nowPlaying.currentIndex = index;
                return;
            }

            const song = app.library.songs.find(s => s.id === songId);
            if (song) {
                app.nowPlaying.currentIndex = index;
                this.loadAndPlaySong(song);
            } else {
                console.warn(`Song with ID ${songId} not found. Skipping.`);
                this.nextSong(); // Skip missing song
            }
        },

        loadAndPlaySong(song) {
            if (this.currentObjectURL) {
                URL.revokeObjectURL(this.currentObjectURL);
                this.currentObjectURL = null;
            }
            app.nowPlaying.id = song.id;
            
            // Generate a fresh URL object for each playback to avoid caching issues with blob URLs
            this.currentObjectURL = URL.createObjectURL(song.file);
            DOM.audio.src = this.currentObjectURL;
            DOM.audio.load(); // Ensure the new source is loaded

            this.play();
            UI.updatePlayerUI();
            this.updateMediaSession(song); // Update Media Session when song changes
        },

        play() {
            if (!app.nowPlaying.id || !DOM.audio.src) return;
            const playPromise = DOM.audio.play();
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    app.nowPlaying.isPlaying = true;
                    UI.updatePlayIcons();
                    this.updateMediaSession(); // Update play state
                }).catch(error => {
                    console.error("Audio play failed (user gesture required?):", error);
                    app.nowPlaying.isPlaying = false;
                    UI.updatePlayIcons();
                    // Inform user if play failed due to autoplay policy
                    if (error.name === "NotAllowedError") {
                        // This usually means playback wasn't initiated by a user gesture.
                        // On some browsers, you might need to show a play button to the user.
                    }
                });
            }
        },
        
        pause() {
            DOM.audio.pause();
            app.nowPlaying.isPlaying = false;
            UI.updatePlayIcons();
            this.updateMediaSession(); // Update pause state
        },

        stop() {
            DOM.audio.pause();
            DOM.audio.currentTime = 0;
            DOM.audio.src = '';
            if (this.currentObjectURL) {
                URL.revokeObjectURL(this.currentObjectURL);
                this.currentObjectURL = null;
            }
            app.nowPlaying.id = null;
            app.nowPlaying.isPlaying = false;
            app.nowPlaying.queue = [];
            app.nowPlaying.currentIndex = -1;
            UI.updatePlayerUI();
            this.updateMediaSession(); // Clear media session info
        },

        togglePlay() {
            if (!app.nowPlaying.id) return;
            if (app.nowPlaying.isPlaying) this.pause();
            else this.play();
        },

        nextSong() {
            if (app.nowPlaying.queue.length === 0) {
                this.stop(); // No more songs
                return;
            }

            let nextIndex = app.nowPlaying.currentIndex + 1;

            if (app.nowPlaying.repeatMode === 'single') {
                this.playFromQueue(app.nowPlaying.currentIndex); // Replay current song
            } else if (nextIndex < app.nowPlaying.queue.length) {
                this.playFromQueue(nextIndex);
            } else if (app.nowPlaying.repeatMode === 'queue') {
                this.playFromQueue(0); // Start from beginning of queue
            } else {
                this.stop(); // End of queue, no repeat
            }
        },
        
        prevSong() {
            if (app.nowPlaying.queue.length === 0) return;
            if (DOM.audio.currentTime > 3 || app.nowPlaying.currentIndex === 0) {
                DOM.audio.currentTime = 0;
                this.play();
            } else {
                const prevIndex = (app.nowPlaying.currentIndex - 1 + app.nowPlaying.queue.length) % app.nowPlaying.queue.length;
                this.playFromQueue(prevIndex);
            }
        },
        
        seek(e){ 
            if(!app.nowPlaying.id || DOM.audio.duration === 0 || isNaN(DOM.audio.duration)) return; 
            const rect = e.currentTarget.getBoundingClientRect(); 
            DOM.audio.currentTime = DOM.audio.duration * (e.clientX - rect.left) / rect.width; 
        },
        setVolume(e){ 
            const rect = e.currentTarget.getBoundingClientRect(); 
            let volume = (e.clientX - rect.left) / rect.width;
            volume = Math.max(0, Math.min(1, volume)); // Clamp between 0 and 1
            DOM.audio.volume = volume; 
            document.getElementById("volume-fill").style.width = `${volume * 100}%`; 
        },
        updateProgress(){ 
            if(!DOM.audio.duration || isNaN(DOM.audio.duration)) return; 
            const { currentTime, duration } = DOM.audio; 
            document.getElementById("progress-fill").style.width = `${(currentTime / duration) * 100}%`; 
            document.getElementById("current-time").textContent = this.formatTime(currentTime); 
            document.getElementById("total-time").textContent = this.formatTime(duration - currentTime); 
        },
        formatTime: s => { const rounded = Math.floor(s || 0); return `${Math.floor(rounded/60)}:${(rounded%60).toString().padStart(2,'0')}`; },

        async toggleFavorite(){ 
            if(!app.nowPlaying.id)return; 
            const song = app.library.songs.find(s => s.id === app.nowPlaying.id); 
            if(song){ 
                song.isFavorite = !song.isFavorite; 
                await DB.put("songs",song); 
                UI.updateFavoriteButton(song.isFavorite); 
            }
        },

        toggleRepeat() {
            const modes = ['none', 'queue', 'single'];
            let nextIndex = (modes.indexOf(app.nowPlaying.repeatMode) + 1) % modes.length;
            this.setRepeatMode(modes[nextIndex]);
        },

        setRepeatMode(mode) {
            app.nowPlaying.repeatMode = mode;
            UI.updateRepeatButton(mode);
            DOM.audio.loop = (mode === 'single'); // Only loop audio element for single song repeat
            console.log(`Repeat mode set to: ${mode}`);
        },

        shuffle(type,id){ 
            let songsToShuffle=[]; 
            if(type==='songs'){songsToShuffle=[...app.library.songs]} 
            else if(type==='album'){songsToShuffle=app.library.albums[id]?.songs||[]} 
            else if(type==='playlist'){songsToShuffle=this.getPlaylistSongs(id)} 
            
            if(songsToShuffle.length === 0){ 
                alert("Nothing to shuffle."); 
                return false; 
            } 
            
            // Fisher-Yates shuffle
            for(let i = songsToShuffle.length - 1; i > 0; i--){ 
                const j = Math.floor(Math.random() * (i + 1)); 
                [songsToShuffle[i], songsToShuffle[j]] = [songsToShuffle[j], songsToShuffle[i]]; 
            } 
            
            app.nowPlaying.queue=songsToShuffle.map(s=>s.id); 
            this.playFromQueue(0); 
            return true; 
        },
        getPlaylistSongs(id){ 
            if(id==="favorites")return app.library.songs.filter(s=>s.isFavorite); 
            const playlist=app.library.playlists.find(p=>p.id===parseInt(id)); 
            return playlist?app.library.songs.filter(s=>playlist.songs.includes(s.id)):[]
        },

        // Media Session API Integration
        updateMediaSession(song = app.library.songs.find(s => s.id === app.nowPlaying.id)) {
            if ('mediaSession' in navigator) {
                if (!song) {
                    navigator.mediaSession.metadata = null;
                    navigator.mediaSession.playbackState = 'none';
                    return;
                }

                navigator.mediaSession.metadata = new MediaMetadata({
                    title: song.title,
                    artist: song.artist,
                    album: song.album,
                    artwork: [
                        { src: song.artwork, sizes: '96x96', type: 'image/png' },
                        { src: song.artwork, sizes: '128x128', type: 'image/png' },
                        { src: song.artwork, sizes: '192x192', type: 'image/png' },
                        { src: song.artwork, sizes: '256x256', type: 'image/png' },
                        { src: song.artwork, sizes: '384x384', type: 'image/png' },
                        { src: song.artwork, sizes: '512x512', type: 'image/png' },
                    ]
                });

                navigator.mediaSession.playbackState = app.nowPlaying.isPlaying ? 'playing' : 'paused';

                navigator.mediaSession.setActionHandler('play', () => { Player.play(); });
                navigator.mediaSession.setActionHandler('pause', () => { Player.pause(); });
                navigator.mediaSession.setActionHandler('previoustrack', () => { Player.prevSong(); });
                navigator.mediaSession.setActionHandler('nexttrack', () => { Player.nextSong(); });
                // Optional handlers for seeking
                navigator.mediaSession.setActionHandler('seekbackward', (event) => { DOM.audio.currentTime = Math.max(0, DOM.audio.currentTime - (event.seekOffset || 10)); });
                navigator.mediaSession.setActionHandler('seekforward', (event) => { DOM.audio.currentTime = Math.min(DOM.audio.duration, DOM.audio.currentTime + (event.seekOffset || 10)); });
                navigator.mediaSession.setActionHandler('seekto', (event) => { DOM.audio.currentTime = event.seekTime; });
            }
        }
    };
    
    const UI = {
        showLoading: (show) => DOM.loadingOverlay.classList.toggle('active', show),
        showView(viewId, fromPopState = false) {
            if (!fromPopState) {
                let hash = viewId.replace('-view', '');
                if (viewId === 'player-view') hash = 'playing'; 
                if (window.location.hash !== '#' + hash) {
                    history.pushState({ viewId }, '', '#' + hash);
                }
            }
            DOM.views.forEach(v => v.classList.remove('active'));
            document.getElementById(viewId)?.classList.add('active');
            
            DOM.appContainer.classList.toggle('player-visible', viewId === 'player-view');

            const viewName = viewId.replace('-view', '');
            document.querySelectorAll('.tab-item').forEach(t => t.classList.toggle('active', t.dataset.view === viewName));
        },
        showSubView(type, id = null, fromPopState = false) {
            if (!fromPopState) {
                let hash = type;
                if (id) hash += `/${id}`;
                if (window.location.hash !== '#' + hash) {
                    history.pushState({ type, id }, '', '#' + hash);
                }
            }
            // Reset multi-select mode if switching sub-views
            if (UI.multiSelectState.isActive) {
                UI.toggleMultiSelect(false);
            }
            this.renderSubView(type, id);
            DOM.views.forEach(v => v.classList.remove('active'));
            document.getElementById('sub-view').classList.add('active');
            DOM.appContainer.classList.remove('player-visible');
        },
        showModal: (viewId) => { document.getElementById(viewId).classList.add('active'); },
        hideModal: (viewId) => { document.getElementById(viewId).classList.remove('active'); },
        goBack: () => history.back(),
        showFullPlayer() { if (app.nowPlaying.id) this.showView('player-view'); },
        hideFullPlayer() { this.goBack(); },
        updatePlayerUI(){
            const nowPlayingBar = document.getElementById("now-playing-bar");
            if (!app.nowPlaying.id) {
                nowPlayingBar.classList.remove("active");
                return;
            }
            nowPlayingBar.classList.add("active");
            this.updatePlayIcons();
            this.updateRepeatButton(app.nowPlaying.repeatMode);
            const song = app.library.songs.find(e => e.id === app.nowPlaying.id);
            if (song) {
                ["np-artwork", "player-artwork"].forEach(e => document.getElementById(e).src = song.artwork);
                const playerTitle = document.getElementById("player-title");
                const npTitle = document.getElementById("np-title");
                playerTitle.textContent = song.title.replace(" [E]","");
                npTitle.textContent = song.title.replace(" [E]","");
                playerTitle.classList.toggle("explicit", song.title.includes("[E]"));
                npTitle.classList.toggle("explicit", song.title.includes("[E]"));
                document.getElementById("player-artist").textContent = song.artist;
                this.updateFavoriteButton(song.isFavorite);
                this.updatePlayerBackground(song.artwork);
            }
        },
        updateFavoriteButton(isFavorite){const favBtn=document.querySelector(".favorite-btn i");if(favBtn){favBtn.className=isFavorite?"fas fa-star":"far fa-star";favBtn.parentElement.classList.toggle("favorited",isFavorite)}},
        updatePlayIcons(){const isPlaying=app.nowPlaying.isPlaying;document.getElementById("np-play-icon").className=`fas ${isPlaying?"fa-pause":"fa-play"}`,document.getElementById("main-play-icon").className=`fas ${isPlaying?"fa-pause-circle":"fa-play-circle"}`},
        updateRepeatButton(mode) {
            const repeatIcon = document.getElementById('repeat-icon');
            if (!repeatIcon) return;
            repeatIcon.classList.remove('active'); // Reset all states
            repeatIcon.classList.remove('fa-repeat', 'fa-repeat-1'); // Remove old icons

            switch (mode) {
                case 'none':
                    repeatIcon.classList.add('fa-repeat');
                    break;
                case 'queue':
                    repeatIcon.classList.add('fa-repeat', 'active');
                    break;
                case 'single':
                    repeatIcon.classList.add('fa-repeat-1', 'active');
                    break;
            }
        },
        updatePlayerBackground(src){const img=new Image;img.crossOrigin="Anonymous",img.src=src,img.onload=()=>{const canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");ctx.drawImage(img,0,0,1,1);const[r,g,b]=ctx.getImageData(0,0,1,1).data;document.getElementById("player-view").style.backgroundImage=`linear-gradient(to bottom, rgb(${r},${g},${b}) 0%, #000 70%)`},img.onerror=()=>{document.getElementById("player-view").style.backgroundImage="linear-gradient(to bottom, #222 0%, #000 70%)"}},
        renderAll() { this.renderLibraryView(); },
        renderLibraryView(){const e=document.getElementById("library-content");e.innerHTML=`<div id="library-nav-list"></div><div class="section-header"><h2>Recently Added</h2></div><div class="grid" id="library-recent-grid"></div>`;const t=e.querySelector("#library-nav-list");[{type:"playlists",icon:"fa-list-ul",text:"Playlists"},{type:"artists",icon:"fa-microphone-lines",text:"Artists"},{type:"albums",icon:"fa-compact-disc",text:"Albums"},{type:"songs",icon:"fa-music",text:"Songs"}].forEach(e=>t.appendChild(this.createListItem(e)));const a=e.querySelector("#library-recent-grid"),i=[...app.library.songs].sort((e,t)=>t.addedAt-e.addedAt).slice(0,4);a.innerHTML="";const l=e.querySelector(".section-header");i.length>0?(l.classList.remove("hidden"),i.forEach(e=>a.appendChild(this.createGridItem(e,"playSong")))):l.classList.add("hidden")},
        renderSubView(type,id){
            const titles={playlists:"Playlists",playlistDetail:"Playlist",artists:"Artists",albums:"Albums",albumDetail:"Album",songs:"Songs"};
            const backText={playlistDetail:"Playlists",albumDetail:"Albums",default:"Library"};
            
            document.querySelector("#sub-view .back-btn span").textContent=backText[type]||backText.default;
            if(type==="playlistDetail"){
                const playlistName = id==="favorites"?"Favorite Songs":app.library.playlists.find(e=>e.id===parseInt(id))?.name;
                titles.playlistDetail=playlistName;
            }else if(type==="albumDetail")titles.albumDetail=id;
            
            document.getElementById("sub-view-title").textContent=titles[type];
            
            const actionsContainer=document.getElementById("sub-view-actions");
            actionsContainer.innerHTML = ''; // Clear previous actions
            if (type === "playlists") {
                actionsContainer.innerHTML = '<button class="icon-btn" data-action="openCreatePlaylistModal"><i class="fas fa-plus"></i></button>';
            } else if (type === "songs") {
                actionsContainer.innerHTML = `
                    <button class="icon-btn" id="multi-select-btn" data-action="toggleMultiSelect">Select</button>
                    <button class="icon-btn hidden" id="multi-edit-btn" data-action="openMultiEditModal">Edit</button>
                    <button class="back-btn hidden" id="multi-done-btn" data-action="toggleMultiSelect">Done</button>
                `;
            }

            const contentContainer=document.getElementById("sub-view-content");
            contentContainer.dataset.type=type;
            contentContainer.innerHTML=`<div class="search-bar"><input type="text" class="search-input" data-type="${type}" data-id="${id}" placeholder="Search in ${titles[type]||''}"></div>`;
            
            // Add or remove multi-select class based on state
            if (type === 'songs' && UI.multiSelectState.isActive) {
                contentContainer.classList.add('multi-select-active');
                document.getElementById('multi-select-btn').classList.add('hidden');
                document.getElementById('multi-edit-btn').classList.remove('hidden');
                document.getElementById('multi-done-btn').classList.remove('hidden');
            } else {
                contentContainer.classList.remove('multi-select-active');
            }

            const renderers={playlists:this.renderPlaylistsView,playlistDetail:this.renderPlaylistDetailView,artists:this.renderArtistsView,albums:this.renderAlbumsView,albumDetail:this.renderAlbumDetailView,songs:this.renderSongsView};renderers[type]&&renderers[type].call(this,contentContainer,id)
        },
        renderPlaylistSelector(){const e=document.getElementById("playlist-selector-list");e.innerHTML="",app.library.playlists.forEach(t=>{const a=document.createElement("div");a.className="list-item",a.dataset.action="selectPlaylist",a.dataset.id=t.id,a.innerHTML=`<div class="list-icon"><i class="fas fa-list-ul"></i></div><div class="list-text">${t.name}</div>`,e.appendChild(a)})},
        renderPlaylistsView(container){const fragment=document.createDocumentFragment();fragment.appendChild(this.createPlaylistItem({id:"favorites",name:"Favorite Songs",artwork:"FAVORITE",songs:[]}));app.library.playlists.forEach(p=>fragment.appendChild(this.createPlaylistItem(p)));container.appendChild(fragment)},
        renderPlaylistDetailView(container,playlistId){const songs=Player.getPlaylistSongs(playlistId);container.innerHTML+=`<div class="action-buttons"><button class="action-btn" data-action="playPlaylist" data-id="${playlistId}"><i class="fas fa-play"></i>Play</button><button class="action-btn" data-action="shuffle" data-type="playlist" data-id="${playlistId}"><i class="fas fa-shuffle"></i>Shuffle</button></div>`;if(songs.length===0){container.innerHTML+='<p class="empty-state">No songs in this playlist.</p>'}else{songs.forEach(song=>container.appendChild(this.createSongListItem(song)))}},
        renderAlbumDetailView(container,albumName){const album=app.library.albums[albumName];if(!album)return container.innerHTML+='<p class="empty-state">Album not found.</p>';container.innerHTML+=`<div class="action-buttons"><button class="action-btn" data-action="playAlbum" data-album="${albumName}"><i class="fas fa-play"></i>Play</button><button class="action-btn" data-action="shuffle" data-type="album" data-id="${albumName}"><i class="fas fa-shuffle"></i>Shuffle</button></div>`;if(album.songs.length===0){container.innerHTML+='<p class="empty-state">No songs in this album.</p>'}else{album.songs.forEach(song=>container.appendChild(this.createSongListItem(song)))}},
        renderArtistsView(container){const artists=Object.keys(app.library.artists).sort();if(artists.length===0)return container.innerHTML+='<p class="empty-state">No artists found.</p>';artists.forEach(artistName=>container.appendChild(this.createArtistListItem(artistName,app.library.artists[artistName][0].artwork)))},
        renderAlbumsView(container){const albums=Object.keys(app.library.albums).sort();if(albums.length===0)return container.innerHTML+='<p class="empty-state">No albums found.</p>';const grid=document.createElement("div");grid.className="grid";albums.forEach(albumName=>grid.appendChild(this.createGridItem(app.library.albums[albumName],"showSubView",albumName)));container.appendChild(grid)},
        renderSongsView(container){const songs=app.library.songs;if(songs.length===0)return container.innerHTML+='<p class="empty-state">No songs found.</p>';container.innerHTML+=`<div class="action-buttons"><button class="action-btn" data-action="playSong" data-id="${songs[0]?.id}"><i class="fas fa-play"></i>Play</button><button class="action-btn" data-action="shuffle" data-type="songs"><i class="fas fa-shuffle"></i>Shuffle</button></div>`;songs.forEach(song=>container.appendChild(this.createSongListItem(song)))},
        createListItem(item){const el=document.createElement("div");el.className="list-item",el.dataset.action="showSubView",el.dataset.type=item.type,el.innerHTML=`<div class="list-icon"><i class="fas ${item.icon}"></i></div><div class="list-text">${item.text}</div><div class="list-arrow"><i class="fas fa-chevron-right"></i></div>`;return el},
        createPlaylistItem(playlist){
            const songCount=playlist.id==="favorites"?app.library.songs.filter(s=>s.isFavorite).length:playlist.songs.length;
            const itemHTML=`
                <div class="playlist-item" data-action="showSubView" data-type="playlistDetail" data-id="${playlist.id}">
                    <div class="playlist-item-artwork" ${playlist.artwork==="FAVORITE"?'id="favorite-playlist-artwork"':`style="background-image:url(${playlist.artwork||'https://via.placeholder.com/150?text=Art'})"`}>
                        ${playlist.artwork==="FAVORITE"?'<i class="fas fa-star"></i>':''}
                    </div>
                    <div class="playlist-info">
                        <div class="playlist-title">${playlist.name}</div>
                        <div class="playlist-subtitle">${songCount} song${songCount!==1?'s':''}</div>
                    </div>
                    <div class="list-arrow"><i class="fas fa-chevron-right"></i></div>
                </div>`;
            const wrapper=document.createElement("div");
            wrapper.className="list-item-swipe-container";
            wrapper.innerHTML=`
                <div class="list-item-swipe-inner">
                    <div class="list-item-swipe-content playlist-swipe-content">
                        ${itemHTML}
                    </div>
                    ${playlist.id!=="favorites" ? `
                    <div class="list-item-actions">
                        <button class="list-action-btn action-edit" data-action="renamePlaylist" data-id="${playlist.id}">Rename</button>
                        <button class="list-action-btn action-delete" data-action="deletePlaylist" data-id="${playlist.id}">Delete</button>
                    </div>` : ''}
                </div>`;
            return wrapper;
        },
        createArtistListItem(name,artwork){const el=document.createElement("div");el.className="list-item",el.innerHTML=`<div class="list-icon"><img src="${artwork}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;"></div><div class="list-text">${name}</div><div class="list-arrow"><i class="fas fa-chevron-right"></i></div>`;return el},
        createGridItem(item,action,id){const el=document.createElement("div");el.className="grid-item",el.dataset.action=action;if(action==="playSong"){el.dataset.id=item.id,el.innerHTML=`<img src="${item.artwork}" alt="${item.album}"><div class="grid-item-title">${item.title}</div><div class="grid-item-subtitle">${item.artist}</div>`}else if(action==="showSubView"){el.dataset.type="albumDetail",el.dataset.id=id;const songCount=item.songs.length;el.innerHTML=`<img src="${item.artwork}" alt="${id}"><div class="grid-item-title">${id}</div><div class="grid-item-subtitle">${item.artist}  ${songCount} song${songCount!==1?'s':''}</div>`}return el},
        createSongListItem(song){
            const wrapper=document.createElement("div");
            wrapper.className="list-item-swipe-container";
            wrapper.innerHTML=`
                <div class="list-item-swipe-inner">
                    <div class="list-item-swipe-content">
                        <input type="checkbox" class="song-list-item-checkbox" data-action="handleSongSelect" data-id="${song.id}" ${UI.multiSelectState.selectedSongIds.has(song.id) ? 'checked' : ''}>
                        <div class="song-list-artwork" style="background-image: url('${song.artwork || 'https://via.placeholder.com/150?text=Art'}'); background-size: cover; background-position: center;"></div>
                        <div class="song-list-info-content" data-action="playSong" data-id="${song.id}">
                            <div class="song-list-info">
                                <span class="song-list-title ${song.title.includes('[E]') ? 'explicit' : ''}">${song.title.replace(' [E]','')}</span>
                                <span class="song-list-artist">${song.artist}</span>
                            </div>
                            <i class="fas fa-ellipsis-h song-menu-btn"></i>
                        </div>
                    </div>
                    <div class="list-item-actions">
                        <button class="list-action-btn action-edit" data-action="editSong" data-id="${song.id}">Rename</button>
                        <button class="list-action-btn action-delete" data-action="deleteSong" data-id="${song.id}">Delete</button>
                    </div>
                </div>`;
            return wrapper;
        },
        handleSearch(e){const t=e.target.value.toLowerCase(),a=document.getElementById("search-results-container"),i=document.getElementById("search-categories");a.classList.toggle("hidden",t.length<2),i.classList.toggle("hidden",t.length>=2);if(t.length<2)return;a.innerHTML="";const l=app.library.songs.filter(e=>e.title.toLowerCase().includes(t)||e.artist.toLowerCase().includes(t)||e.album.toLowerCase().includes(t));if(0===l.length)return void(a.innerHTML='<p class="empty-state">No Results</p>');l.forEach(e=>a.appendChild(this.createSongListItem(e)))},
        handleSubViewSearch(e){const t=e.target.closest(".main-content"),a=t.querySelectorAll(".list-item, .list-item-swipe-container, .grid-item"),i=e.target.value.toLowerCase();a.forEach(e=>{const t=e.textContent.toLowerCase();e.style.display=t.includes(i)?"":"none"})},

        // Multi-select methods
        multiSelectState: {
            isActive: false,
            selectedSongIds: new Set(),
        },

        toggleMultiSelect(forceState) {
            const subViewContent = document.getElementById('sub-view-content');
            const multiSelectBtn = document.getElementById('multi-select-btn');
            const multiEditBtn = document.getElementById('multi-edit-btn');
            const multiDoneBtn = document.getElementById('multi-done-btn');

            if (forceState !== undefined) {
                this.multiSelectState.isActive = forceState;
            } else {
                this.multiSelectState.isActive = !this.multiSelectState.isActive;
            }

            if (this.multiSelectState.isActive) {
                subViewContent.classList.add('multi-select-active');
                multiSelectBtn.classList.add('hidden');
                multiEditBtn.classList.remove('hidden');
                multiDoneBtn.classList.remove('hidden');
            } else {
                subViewContent.classList.remove('multi-select-active');
                multiSelectBtn.classList.remove('hidden');
                multiEditBtn.classList.add('hidden');
                multiDoneBtn.classList.add('hidden');
                this.multiSelectState.selectedSongIds.clear(); // Clear selections
                app.multiEdit.selectedSongIds = []; // Clear synced array
                // Uncheck all checkboxes
                document.querySelectorAll('.song-list-item-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
            }
            // Re-render the song list to update checkbox visibility
            const currentHash = window.location.hash.slice(1);
            const [path, id] = currentHash.split('/');
            if (path === 'songs' || path === 'playlistDetail' || path === 'albumDetail') {
                 UI.renderSubView(path, id);
            }
        },

        handleSongSelect(songId, isChecked) {
            if (isChecked) {
                this.multiSelectState.selectedSongIds.add(songId);
            } else {
                this.multiSelectState.selectedSongIds.delete(songId);
            }
            app.multiEdit.selectedSongIds = Array.from(this.multiSelectState.selectedSongIds); // Keep app.multiEdit synced
            console.log("Selected song IDs:", app.multiEdit.selectedSongIds);
        },
    };

    init();
});
  </script>
</body>
</html>
