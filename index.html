<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Apple Music</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>

  <style>
    :root {
      --system-red: #ff3b30;
      --system-pink: #ff2d55;
      --system-gray: #8e8e93;
      --system-gray-2: #aeaeb2;
      --system-gray-6: #1c1c1e;
      --fill-tertiary: rgba(118, 118, 128, 0.24);
      --border-color: rgba(255, 255, 255, 0.15);
      --safe-area-top: env(safe-area-inset-top, 20px);
      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
    }

    /* Base Styles */
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; width: 100%; overflow: hidden; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
      background: #000; color: #fff; display: flex; flex-direction: column; -webkit-font-smoothing: antialiased;
    }
    .app-container { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }

    /* View Management */
    .view {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column;
      opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; background: #000; z-index: 10;
    }
    .view.active { opacity: 1; visibility: visible; z-index: 20; }

    /* Header Styles */
    .header { padding: var(--safe-area-top) 20px 10px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
    .header.large-title h1 { font-size: 34px; font-weight: 700; }
    .header-profile-icon { width: 32px; height: 32px; background: var(--fill-tertiary); color: var(--system-pink); border-radius: 50%; font-size: 16px; display: flex; align-items: center; justify-content: center; }
    .header-with-back { padding: var(--safe-area-top) 10px 10px; }
    .header-with-back .back-btn { font-size: 17px; color: var(--system-pink); background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 4px; padding: 8px; }
    .header-with-back h1 { font-size: 17px; font-weight: 600; flex: 1; text-align: center; margin: 0 10px; }
    .header-actions { display: flex; gap: 15px; min-width: 40px; justify-content: flex-end; align-items: center; }
    .header-actions .icon-btn, .round-btn { background: none; border: none; color: var(--system-pink); font-size: 22px; cursor: pointer; }
    .round-btn { background: var(--fill-tertiary); width: 32px; height: 32px; border-radius: 50%; font-size: 14px; display: flex; align-items: center; justify-content: center; }

    /* Main Content & Common Elements */
    .main-content { flex: 1; overflow-y: auto; scrollbar-width: none; padding-bottom: 130px; }
    .main-content::-webkit-scrollbar { display: none; }
    .search-bar { padding: 10px 20px; position: relative; }
    .search-input { width: 100%; padding: 8px 40px 8px 35px; background-color: var(--fill-tertiary); border: none; border-radius: 10px; color: #fff; font-size: 17px; background-image: url("data:image/svg+xml;charset=utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%238e8e93' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: 10px center; }
    .search-input-mic { position: absolute; right: 30px; top: 50%; transform: translateY(-50%); color: var(--system-gray); font-size: 16px; }
    .search-input::placeholder { color: var(--system-gray); }
    .content-section { margin-bottom: 20px; }
    .section-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 20px 15px; }
    .section-header h2 { font-size: 22px; font-weight: 700; }

    /* List Item Swipe Actions */
    .swipe-container { position: relative; overflow: hidden; background: #000; }
    .swipe-content { transform: translateX(0); transition: transform 0.3s ease; cursor: pointer; background: #000; z-index: 2; position: relative; }
    .swipe-actions { position: absolute; top: 0; right: 0; height: 100%; display: flex; z-index: 1; }
    .swipe-action-btn { height: 100%; padding: 0 25px; color: #fff; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 17px; }
    .swipe-action-btn.rename { background-color: var(--system-gray); }
    .swipe-action-btn.delete { background-color: var(--system-red); }
    
    /* List View Styles */
    .list-item { display: flex; align-items: center; padding: 11px 20px; border-bottom: 1px solid var(--border-color); }
    .list-item:first-child { border-top: 1px solid var(--border-color); }
    .list-icon { color: var(--system-pink); width: 30px; font-size: 22px; margin-right: 15px; text-align: center; }
    .list-text { flex: 1; font-size: 17px; }
    .list-arrow { color: var(--system-gray); font-size: 14px; }
    .song-list-item { display: flex; align-items: center; padding: 0 20px; }
    .song-list-artwork { width: 44px; height: 44px; border-radius: 4px; object-fit: cover; margin-right: 12px; background: var(--system-gray-6);}
    .song-list-info { flex: 1; display: flex; flex-direction: column; }
    .song-list-info-container { flex: 1; display: flex; align-items: center; border-bottom: 1px solid var(--border-color); padding: 8px 0; }
    .song-list-item:last-child .song-list-info-container { border-bottom: none; }
    .song-list-title { font-size: 17px; display: flex; align-items: center; }
    .song-list-artist { font-size: 14px; color: var(--system-gray); }
    .song-menu-btn { color: var(--system-gray); font-size: 16px; padding: 10px; }

    /* Grid & Carousel */
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 0 20px; }
    .grid-item img { width: 100%; aspect-ratio: 1/1; border-radius: 6px; object-fit: cover; margin-bottom: 5px; background: #1c1c1e; }
    .grid-item-title { font-size: 14px; line-height: 1.2; font-weight: 400; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .grid-item-subtitle { font-size: 14px; color: var(--system-gray); }
    
    /* Playlists View */
    .playlist-item { display: flex; align-items: center; padding: 8px 20px; border-bottom: 1px solid var(--border-color); }
    .playlist-item-artwork { width: 54px; height: 54px; border-radius: 4px; object-fit: cover; margin-right: 15px; display: flex; align-items: center; justify-content: center; background: #1c1c1e; }
    .playlist-info { flex: 1; }
    .playlist-title { font-size: 17px; }
    .playlist-subtitle { font-size: 14px; color: var(--system-gray); }

    /* Search Page */
    .search-category-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 10px 20px; }
    .category-item { position: relative; cursor: pointer; }
    .category-item img { width: 100%; display: block; border-radius: 8px; aspect-ratio: 1.5 / 1; object-fit: cover; }
    .category-item::before { content: ''; position: absolute; inset: 0; border-radius: 8px; mix-blend-mode: screen; }
    .category-item[data-color="red"]::before { background-color: #ff3b30; }
    .category-item[data-color="yellow"]::before { background-color: #ffcc00; }
    .category-item[data-color="blue"]::before { background-color: #007aff; }
    .category-item .category-title { position: absolute; bottom: 12px; left: 12px; font-size: 16px; font-weight: 600; color: #fff; }

    /* Tab Bar & Now Playing Bar */
    .tab-bar, .now-playing-bar { position: fixed; left: 0; right: 0; background: rgba(28, 28, 30, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); z-index: 500; }
    .tab-bar { bottom: 0; display: flex; padding-top: 8px; padding-bottom: var(--safe-area-bottom); border-top: 0.5px solid rgba(255, 255, 255, 0.2); }
    .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; cursor: pointer; color: var(--system-gray); }
    .tab-item.active { color: var(--system-pink); }
    .tab-icon { font-size: 22px; margin-bottom: 2px; }
    .tab-label { font-size: 10px; font-weight: 500; }
    .now-playing-bar { bottom: calc(50px + var(--safe-area-bottom)); left: 10px; right: 10px; padding: 8px; border-radius: 12px; display: none; align-items: center; cursor: pointer; z-index: 600; transform: translateY(200%); transition: transform 0.4s ease-in-out; }
    .now-playing-bar.active { display: flex; transform: translateY(0); }
    .now-playing-artwork { width: 44px; height: 44px; border-radius: 4px; object-fit: cover; margin-right: 12px; background: #1c1c1e; }
    .now-playing-info { flex: 1; font-size: 15px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .now-playing-controls { display: flex; align-items: center; gap: 20px; margin-right: 5px; }
    .now-playing-btn { background: none; border: none; color: #fff; font-size: 22px; cursor: pointer; }

    /* Full Player */
    .full-player { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; display: flex; flex-direction: column; padding: var(--safe-area-top) 25px var(--safe-area-bottom); background-image: linear-gradient(to bottom, #222 0%, #000 70%); transform: translateY(100%); transition: transform 0.5s cubic-bezier(0.32, 0.72, 0, 1); visibility: hidden; }
    .full-player.active { transform: translateY(0); visibility: visible; }
    .full-player.no-transition { transition: none; }
    .player-header { display: flex; justify-content: center; position: relative; padding: 15px 0; touch-action: none; }
    .player-minimize-handle { width: 36px; height: 5px; background: rgba(255,255,255,0.4); border-radius: 2.5px; }
    /* ... other player styles ... */

    /* Modal (Bottom Sheet) */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1100; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .bottom-sheet { position: fixed; bottom: 0; left: 0; right: 0; background: #1c1c1e; z-index: 1200; border-radius: 20px 20px 0 0; padding: 15px 20px calc(20px + var(--safe-area-bottom)); transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1); touch-action: none; }
    .bottom-sheet.active { transform: translateY(0); }
    .bottom-sheet.no-transition { transition: none; }
    .sheet-header { text-align: center; margin-bottom: 20px; }
    .sheet-handle { width: 40px; height: 5px; background: var(--system-gray); border-radius: 2.5px; margin: 0 auto 15px; }
    .sheet-title { font-size: 18px; font-weight: 600; }
    .sheet-form { display: flex; flex-direction: column; gap: 20px; }
    .sheet-artwork-section { text-align: center; }
    .sheet-artwork-preview { width: 150px; height: 150px; background: #333; border-radius: 8px; margin: 0 auto 15px; object-fit: cover; cursor: pointer; }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { color: var(--system-gray); font-size: 14px; margin-bottom: 8px; text-transform: uppercase; }
    .form-group input, .form-group button { background: var(--fill-tertiary); border: none; border-radius: 8px; padding: 12px; font-size: 17px; color: #fff; }
    .form-group button { background: var(--system-pink); cursor: pointer; font-weight: 600; }
    #add-to-playlist-section { max-height: 150px; overflow-y: auto; background: var(--fill-tertiary); border-radius: 8px; }
    .playlist-select-item { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 10px; cursor: pointer; }
    .playlist-select-item:last-child { border-bottom: none; }
    .playlist-select-item input[type="checkbox"] { width: 20px; height: 20px; }
    
    /* Utility */
    .hidden { display: none; }
    .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: none; align-items: center; justify-content: center; }
    .loading-overlay.active { display: flex; }
    .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .empty-state { text-align: center; color: var(--system-gray); padding: 50px 20px; }
  </style>
</head>
<body>

  <div class="app-container">
    <div id="library-view" class="view">
        <div class="header large-title"><h1>Library</h1><div class="header-actions"><button class="round-btn" data-action="openUploadModal"><i class="fas fa-plus"></i></button><div class="header-profile-icon"><i class="fas fa-user"></i></div></div></div>
        <div class="main-content" id="library-content"></div>
    </div>
    <div id="sub-view" class="view">
        <div class="header header-with-back">
            <button class="back-btn" data-action="goBack"><i class="fas fa-chevron-left"></i> <span>Library</span></button>
            <h1 id="sub-view-title"></h1>
            <div class="header-actions" id="sub-view-actions"></div>
        </div>
        <div class="main-content" id="sub-view-content"></div>
    </div>
    <div id="search-view" class="view">
      <div class="header large-title"><h1>Search</h1><div class="header-profile-icon"><i class="fas fa-user"></i></div></div>
      <div class="main-content">
        <div class="search-bar"><input type="text" class="search-input" id="search-input" placeholder="Artists, Songs, Lyrics, and More"><i class="fas fa-microphone search-input-mic"></i></div>
        <div id="search-results-container" class="hidden"></div>
        <div id="search-categories">
            <div class="section-header"><h2>Browse Categories</h2></div>
            <div class="search-category-grid">
                <div class="category-item" data-color="red"><img src="https://images.unsplash.com/photo-1516450360452-9312f5e86fc7?w=400&auto=format&fit=crop" alt=""><span class="category-title">Set Lists</span></div>
                <div class="category-item" data-color="yellow"><img src="https://images.unsplash.com/photo-1525362083236-02439a1d1478?w=400&auto=format&fit=crop" alt=""><span class="category-title">Alternative</span></div>
            </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="upload-modal-overlay" data-action="closeUploadModal"></div>
  <div class="bottom-sheet" id="upload-sheet">
    <div class="sheet-header"><div class="sheet-handle"></div><h2 class="sheet-title">Add to Library</h2></div>
    <form class="sheet-form" id="upload-form">
        <div class="sheet-artwork-section"><img id="upload-artwork-preview" class="sheet-artwork-preview" src="https://via.placeholder.com/150?text=Artwork" data-action="triggerArtworkUpload" alt="Artwork Preview"><input type="file" id="artwork-input" class="hidden" accept="image/*"></div>
        <div class="form-group"><label for="song-title-input">TITLE</label><input type="text" id="song-title-input" required></div>
        <div class="form-group"><label for="song-artist-input">ARTIST</label><input type="text" id="song-artist-input" required></div>
        <div class="form-group"><label for="song-album-input">ALBUM</label><input type="text" id="song-album-input" required></div>
        <div class="form-group" id="add-to-playlist-section-container"><label>ADD TO PLAYLISTS</label><div id="add-to-playlist-section"></div></div>
        <div class="form-group"><button type="button" data-action="triggerSongUpload">Select Song File (.mp3)</button><span id="song-file-name" style="color: var(--system-gray); font-size: 14px; margin-top: 8px; text-align: center;">No file selected.</span><input type="file" id="music-file-input" class="hidden" accept=".mp3"></div>
        <div class="form-group"><button type="button" data-action="submitUpload">Add Song</button></div>
    </form>
  </div>
  
  <div class="modal-overlay" id="playlist-modal-overlay" data-action="closeCreatePlaylistModal"></div>
  <div class="bottom-sheet" id="create-playlist-sheet">
      <div class="sheet-header"><div class="sheet-handle"></div><h2 class="sheet-title">New Playlist</h2></div>
      <form class="sheet-form" id="create-playlist-form">
          <div class="sheet-artwork-section"><img id="playlist-artwork-preview" class="sheet-artwork-preview" src="https://via.placeholder.com/150?text=Artwork" data-action="triggerPlaylistArtworkUpload" alt="Playlist Artwork Preview"><input type="file" id="playlist-artwork-input" class="hidden" accept="image/*"></div>
          <div class="form-group"><label for="playlist-name-input">PLAYLIST NAME</label><input type="text" id="playlist-name-input" required></div>
          <div class="form-group"><button type="button" data-action="submitCreatePlaylist">Create</button></div>
      </form>
  </div>

  <div class="now-playing-bar" id="now-playing-bar" data-action="showFullPlayer">
    <img id="np-artwork" class="now-playing-artwork" src="" alt=""><div id="np-title" class="now-playing-info">Not Playing</div>
    <div class="now-playing-controls">
      <button class="now-playing-btn" data-action="togglePlay"><i id="np-play-icon" class="fas fa-play"></i></button>
      <button class="now-playing-btn" data-action="nextSong"><i class="fas fa-forward-step"></i></button>
    </div>
  </div>

  <div class="full-player" id="full-player">
    <div class="player-header"><div class="player-minimize-handle"></div></div>
    <img id="player-artwork" class="player-artwork" src="" alt=""><div class="player-info-container">
        <div class="player-details"><div id="player-title" class="title">Not Playing</div><div id="player-artist" class="artist"></div></div>
        <button class="icon-btn"><i class="fas fa-ellipsis-h"></i></button></div>
    <div class="progress-container" data-action="seek"><div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div><div class="progress-times"><span id="current-time">0:00</span><span id="total-time">0:00</span></div></div>
    <div class="player-controls">
      <button class="control-btn" data-action="prevSong"><i class="fas fa-backward-step"></i></button>
      <button class="control-btn main" data-action="togglePlay"><i id="main-play-icon" class="fas fa-play-circle"></i></button>
      <button class="control-btn" data-action="nextSong"><i class="fas fa-forward-step"></i></button></div>
    <div class="volume-container">
      <i class="fas fa-volume-down"></i><div class="volume-slider" data-action="setVolume"><div class="progress-fill" id="volume-fill" style="width: 50%;"></div></div><i class="fas fa-volume-up"></i></div>
  </div>

  <div class="tab-bar">
    <div class="tab-item active" data-action="showView" data-view="library"><i class="fas fa-rectangle-stack tab-icon"></i><span class="tab-label">Library</span></div>
    <div class="tab-item" data-action="showView" data-view="search"><i class="fas fa-magnifying-glass tab-icon"></i><span class="tab-label">Search</span></div>
  </div>
  
  <audio id="audio" preload="metadata"></audio>
  <div class="loading-overlay" id="loading-overlay"><div class="spinner"></div></div>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {

    const app = {
        db: null,
        nowPlaying: { id: null, queue: [], currentIndex: -1, isPlaying: false },
        library: { songs: [], playlists: [], artists: {}, albums: {} },
        uploadData: { songFile: null, artworkBase64: null },
        playlistData: { artworkBase64: null },
    };

    const DOM = {
        views: document.querySelectorAll('.view'),
        fullPlayer: document.getElementById('full-player'),
        audio: document.getElementById('audio'),
        uploadSheet: document.getElementById('upload-sheet'),
        uploadModalOverlay: document.getElementById('upload-modal-overlay'),
        playlistSheet: document.getElementById('create-playlist-sheet'),
        playlistModalOverlay: document.getElementById('playlist-modal-overlay'),
        subView: document.getElementById('sub-view'),
        loadingOverlay: document.getElementById('loading-overlay'),
    };

    function init() {
        DB.init().then(() => {
            Library.loadAllData().then(() => {
                UI.renderAll();
                UI.showView('library');
            });
        });
        setupEventListeners();
    }

    function setupEventListeners() {
        document.body.addEventListener('click', handleAction);
        DOM.audio.addEventListener('timeupdate', Player.updateProgress);
        DOM.audio.addEventListener('loadedmetadata', Player.updateProgress);
        DOM.audio.addEventListener('ended', Player.nextSong);
        
        const sheetSwipeHandler = new SwipeHandler();
        DOM.fullPlayer.addEventListener('touchstart', e => sheetSwipeHandler.handleTouchStart(e, DOM.fullPlayer, UI.hideFullPlayer), { passive: true });
        DOM.uploadSheet.addEventListener('touchstart', e => sheetSwipeHandler.handleTouchStart(e, DOM.uploadSheet, Upload.closeModal), { passive: true });
        DOM.playlistSheet.addEventListener('touchstart', e => sheetSwipeHandler.handleTouchStart(e, DOM.playlistSheet, Playlist.closeModal), { passive: true });
        
        const itemSwipeHandler = new ItemSwipeHandler();
        document.body.addEventListener('touchstart', e => itemSwipeHandler.handleTouchStart(e), { passive: true });
        
        document.body.addEventListener('touchmove', e => {
            sheetSwipeHandler.handleTouchMove(e);
            itemSwipeHandler.handleTouchMove(e);
        }, { passive: false });
        
        document.body.addEventListener('touchend', e => {
            sheetSwipeHandler.handleTouchEnd(e);
            itemSwipeHandler.handleTouchEnd(e);
        });

        document.getElementById('artwork-input').addEventListener('change', e => Upload.handleArtworkFileSelect(e));
        document.getElementById('music-file-input').addEventListener('change', e => Upload.handleSongFileSelect(e));
        document.getElementById('playlist-artwork-input').addEventListener('change', e => Playlist.handleArtworkFileSelect(e));
        document.getElementById('search-input').addEventListener('input', e => UI.handleSearch(e));
    }
    
    function handleAction(e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        const action = target.dataset.action;
        if (action) e.stopPropagation();

        const actions = {
            'showView': () => UI.showView(target.dataset.view),
            'goBack': UI.goBack,
            'openUploadModal': Upload.openModal,
            'closeUploadModal': Upload.closeModal,
            'openCreatePlaylistModal': Playlist.openModal,
            'closeCreatePlaylistModal': Playlist.closeModal,
            'triggerArtworkUpload': () => document.getElementById('artwork-input').click(),
            'triggerSongUpload': () => document.getElementById('music-file-input').click(),
            'triggerPlaylistArtworkUpload': () => document.getElementById('playlist-artwork-input').click(),
            'submitUpload': Upload.submit,
            'submitCreatePlaylist': Playlist.submit,
            'showSubView': () => UI.showSubView(target.dataset.type),
            'playSong': () => Player.playSong(parseInt(target.dataset.id)),
            'playAlbum': () => Player.playAlbum(target.dataset.album),
            'togglePlay': Player.togglePlay,
            'nextSong': Player.nextSong,
            'prevSong': Player.prevSong,
            'showFullPlayer': UI.showFullPlayer,
            'hideFullPlayer': UI.hideFullPlayer,
            'seek': Player.seek,
            'setVolume': Player.setVolume,
            'deleteItem': () => {
                const type = target.dataset.type;
                const id = target.dataset.id;
                if (confirm(`Are you sure you want to delete this ${type}?`)) {
                    Library.deleteItem(type, id).then(() => UI.renderAll());
                }
            },
            'renamePlaylist': () => {
                const id = parseInt(target.dataset.id);
                const playlist = app.library.playlists.find(p => p.id === id);
                const newName = prompt("Enter new playlist name", playlist.name);
                if (newName && newName.trim() !== "") {
                    Library.renamePlaylist(id, newName).then(() => UI.renderSubView('playlists'));
                }
            },
        };
        
        if (actions[action]) actions[action](e);
    }
      
    const DB = {
        init: () => new Promise(resolve => {
            const request = indexedDB.open("AppleMusicDB_v10_Final", 1);
            request.onupgradeneeded = e => { /* ... */ };
            request.onsuccess = e => { app.db = e.target.result; resolve(); };
        }),
        add: (store, item) => new Promise(res => app.db.transaction(store, 'readwrite').objectStore(store).add(item).onsuccess = res),
        put: (store, item) => new Promise(res => app.db.transaction(store, 'readwrite').objectStore(store).put(item).onsuccess = res),
        get: (store, id) => new Promise(res => app.db.transaction(store).objectStore(store).get(id).onsuccess = e => res(e.target.result)),
        getAll: store => new Promise(res => app.db.transaction(store).objectStore(store).getAll().onsuccess = e => res(e.target.result)),
        delete: (store, id) => new Promise(res => app.db.transaction(store, 'readwrite').objectStore(store).delete(id).onsuccess = res),
    };
    DB.init = ()=>new Promise(e=>{const t=indexedDB.open("AppleMusicDB_v10_Final",1);t.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("songs")||t.createObjectStore("songs",{keyPath:"id",autoIncrement:!0}),t.objectStoreNames.contains("playlists")||t.createObjectStore("playlists",{keyPath:"id",autoIncrement:!0})},t.onsuccess=t=>{app.db=t.target.result,e()}});
      
    const Library = {
        async loadAllData() { /* ... */ },
        processLibrary() { /* ... */ },
        async deleteItem(type, id) {
            if (type === 'song') {
                await DB.delete('songs', parseInt(id));
            } else if (type === 'playlist') {
                await DB.delete('playlists', parseInt(id));
            }
            await this.loadAllData();
        },
        async renamePlaylist(id, newName) {
            const playlist = await DB.get('playlists', id);
            if (playlist) {
                playlist.name = newName;
                await DB.put('playlists', playlist);
                await this.loadAllData();
            }
        },
    };
    Library.loadAllData=async function(){[app.library.songs,app.library.playlists]=await Promise.all([DB.getAll("songs"),DB.getAll("playlists")]),this.processLibrary()};
    Library.processLibrary=function(){app.library.artists={},app.library.albums={},app.library.songs.forEach(e=>{const t=e.artist||"Unknown Artist",a=e.album||"Unknown Album";app.library.artists[t]||(app.library.artists[t]=[]),app.library.artists[t].push(e),app.library.albums[a]||(app.library.albums[a]={songs:[],artwork:e.artwork,artist:t}),app.library.albums[a].songs.push(e)})};
    
    const Upload = {
        openModal: () => {
            const container = document.getElementById('add-to-playlist-section');
            container.innerHTML = '';
            if (app.library.playlists.length === 0) {
                document.getElementById('add-to-playlist-section-container').style.display = 'none';
            } else {
                document.getElementById('add-to-playlist-section-container').style.display = 'flex';
                app.library.playlists.forEach(p => {
                    const item = document.createElement('div');
                    item.className = 'playlist-select-item';
                    item.innerHTML = `<input type="checkbox" id="p-select-${p.id}" data-playlist-id="${p.id}"><label for="p-select-${p.id}">${p.name}</label>`;
                    container.appendChild(item);
                });
            }
            DOM.uploadSheet.classList.add('active');
            DOM.uploadModalOverlay.classList.add('active');
        },
        closeModal: () => { /* ... unchanged ... */ },
        resetForm: () => { /* ... unchanged ... */ },
        handleSongFileSelect: (e) => { /* ... unchanged ... */ },
        handleArtworkFileSelect: (e) => { /* ... unchanged ... */ },
        async submit() {
            UI.showLoading(true);
            const song = { title: document.getElementById('song-title-input').value, artist: document.getElementById('song-artist-input').value, album: document.getElementById('song-album-input').value, file: app.uploadData.songFile, artwork: app.uploadData.artworkBase64 || 'https://via.placeholder.com/300?text=No+Art', addedAt: Date.now() };
            if (!song.title || !song.artist || !song.album || !song.file) { alert("Please fill all fields and select a song file."); UI.showLoading(false); return; }
            
            const req = app.db.transaction('songs', 'readwrite').objectStore('songs').add(song);
            req.onsuccess = async (event) => {
                const songId = event.target.result;
                const selectedPlaylists = Array.from(document.querySelectorAll('#add-to-playlist-section input:checked')).map(el => parseInt(el.dataset.playlistId));
                
                for (const pId of selectedPlaylists) {
                    const playlist = await DB.get('playlists', pId);
                    if (playlist) {
                        playlist.songs.push(songId);
                        await DB.put('playlists', playlist);
                    }
                }
                await Library.loadAllData();
                UI.renderAll();
                UI.showLoading(false);
                this.closeModal();
            };
        }
    };
    Upload.closeModal = function(){DOM.uploadSheet.classList.remove("active"),DOM.uploadModalOverlay.classList.remove("active"),setTimeout(()=>this.resetForm(),400)};
    Upload.resetForm=function(){document.getElementById("upload-form").reset(),document.getElementById("upload-artwork-preview").src="https://via.placeholder.com/150?text=Artwork",document.getElementById("song-file-name").textContent="No file selected.",app.uploadData={songFile:null,artworkBase64:null}};
    Upload.handleSongFileSelect=function(e){app.uploadData.songFile=e.target.files[0],app.uploadData.songFile&&(document.getElementById("song-file-name").textContent=app.uploadData.songFile.name,jsmediatags.read(app.uploadData.songFile,{onSuccess:({tags})=>{tags.title&&(document.getElementById("song-title-input").value=tags.title),tags.artist&&(document.getElementById("song-artist-input").value=tags.artist),tags.album&&(document.getElementById("song-album-input").value=tags.album),tags.picture&&(app.uploadData.artworkBase64=`data:${tags.picture.format};base64,${btoa(String.fromCharCode.apply(null,tags.picture.data))}`,document.getElementById("upload-artwork-preview").src=app.uploadData.artworkBase64)}}))};
    Upload.handleArtworkFileSelect=function(e){const t=e.target.files[0];if(t){const e=new FileReader;e.onload=e=>{app.uploadData.artworkBase64=e.target.result,document.getElementById("upload-artwork-preview").src=app.uploadData.artworkBase64},e.readAsDataURL(t)}};

    const Playlist = {
        openModal: () => { DOM.playlistSheet.classList.add('active'); DOM.playlistModalOverlay.classList.add('active'); },
        closeModal: () => { DOM.playlistSheet.classList.remove('active'); DOM.playlistModalOverlay.classList.remove('active'); setTimeout(() => this.resetForm(), 400); },
        resetForm: () => { document.getElementById('create-playlist-form').reset(); document.getElementById('playlist-artwork-preview').src = 'https://via.placeholder.com/150?text=Artwork'; app.playlistData = { artworkBase64: null }; },
        handleArtworkFileSelect(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = re => { app.playlistData.artworkBase64 = re.target.result; document.getElementById('playlist-artwork-preview').src = app.playlistData.artworkBase64; };
            reader.readAsDataURL(file);
        },
        async submit() {
            const name = document.getElementById('playlist-name-input').value;
            if (!name.trim()) { alert("Please enter a playlist name."); return; }
            UI.showLoading(true);
            const playlist = { name, songs: [], artwork: app.playlistData.artworkBase64, createdAt: Date.now() };
            await DB.add('playlists', playlist);
            await Library.loadAllData();
            UI.renderSubView('playlists');
            UI.showLoading(false);
            this.closeModal();
        }
    };
    
    class SwipeHandler { /* ... unchanged ... */ }
    class ItemSwipeHandler {
        constructor() { this.touch = { startX: 0, currentX: 0, isDragging: false, target: null, activeContainer: null }; }
        handleTouchStart(e) {
            const target = e.target.closest('.swipe-content');
            if (!target) { if(this.touch.activeContainer) this.reset(this.touch.activeContainer); return; }
            if (this.touch.activeContainer && this.touch.activeContainer !== target.parentElement) this.reset(this.touch.activeContainer);
            this.touch = { startX: e.touches[0].clientX, currentX: e.touches[0].clientX, isDragging: true, target: target, activeContainer: target.parentElement };
        }
        handleTouchMove(e) {
            if (!this.touch.isDragging) return;
            this.touch.currentX = e.touches[0].clientX;
            let deltaX = this.touch.currentX - this.touch.startX;
            if (deltaX < 0) this.touch.target.style.transform = `translateX(${deltaX}px)`;
        }
        handleTouchEnd() {
            if (!this.touch.isDragging) return;
            let deltaX = this.touch.currentX - this.touch.startX;
            if (deltaX < -50) {
                const actionsWidth = this.touch.activeContainer.querySelector('.swipe-actions').offsetWidth;
                this.touch.target.style.transform = `translateX(-${actionsWidth}px)`;
            } else {
                this.reset(this.touch.activeContainer);
            }
            this.touch.isDragging = false;
        }
        reset(container) {
            if(container) container.querySelector('.swipe-content').style.transform = '';
            this.touch.activeContainer = null;
        }
    }
    class SwipeHandler{constructor(){this.touch={startY:0,currentY:0,isDragging:!1,target:null,onDismiss:null}}handleTouchStart(e,t,a){e.target.closest(".progress-container, .volume-container, .player-controls, .form-group, button, .swipe-container")||(this.touch={isDragging:!0,target:t,onDismiss:a,startY:e.touches[0].clientY,currentY:e.touches[0].clientY},this.touch.target.classList.add("no-transition"))}handleTouchMove(e){if(this.touch.isDragging){this.touch.currentY=e.touches[0].clientY;let t=this.touch.currentY-this.touch.startY;t>-50&&(e.preventDefault(),this.touch.target.style.transform=`translateY(${t}px`)}}handleTouchEnd(){if(this.touch.isDragging){let e=this.touch.currentY-this.touch.startY;this.touch.target.classList.remove("no-transition"),e>100?this.touch.onDismiss():this.touch.target.style.transform="",this.touch.isDragging=!1}}}

    const Player = {
        playSong(songId) { /* ... unchanged ... */ },
        playAlbum(albumName) { /* ... unchanged ... */ },
        loadSong(song) { /* ... unchanged ... */ },
        togglePlay() { /* ... unchanged ... */ },
        nextSong() { /* ... unchanged ... */ },
        prevSong() { /* ... unchanged ... */ },
        playFromQueue(index) { /* ... unchanged ... */ },
        seek: e => { /* ... unchanged ... */ },
        setVolume: e => { /* ... unchanged ... */ },
        updateProgress: () => { /* ... unchanged ... */ },
        formatTime: s => `${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,'0')}`,
    };
    Player.playSong=function(e){const t=app.library.songs.findIndex(t=>t.id===e);-1!==t&&(app.nowPlaying.queue=app.library.songs.map(e=>e.id),this.playFromQueue(t))},Player.playAlbum=function(e){const t=app.library.albums[e];t&&0!==t.songs.length&&(app.nowPlaying.queue=t.songs.map(e=>e.id),this.playFromQueue(0))},Player.loadSong=function(e){app.nowPlaying.id=e.id,DOM.audio.src=URL.createObjectURL(e.file),DOM.audio.play().catch(e=>console.error("Audio play failed:",e)),app.nowPlaying.isPlaying=!0,UI.updatePlayerUI()},Player.togglePlay=function(){app.nowPlaying.id&&(app.nowPlaying.isPlaying?DOM.audio.pause():DOM.audio.play(),app.nowPlaying.isPlaying=!app.nowPlaying.isPlaying,UI.updatePlayIcons())},Player.nextSong=function(){if(0!==app.nowPlaying.queue.length){const e=(app.nowPlaying.currentIndex+1)%app.nowPlaying.queue.length;this.playFromQueue(e)}},Player.prevSong=function(){DOM.audio.currentTime>3||0===app.nowPlaying.currentIndex?DOM.audio.currentTime=0:this.playFromQueue((app.nowPlaying.currentIndex-1+app.nowPlaying.queue.length)%app.nowPlaying.queue.length)},Player.playFromQueue=function(e){if(0!==app.nowPlaying.queue.length){const t=app.nowPlaying.queue[e],a=app.library.songs.find(e=>e.id===t);a&&(app.nowPlaying.currentIndex=e,this.loadSong(a))}},Player.seek=function(e){if(!app.nowPlaying.id)return;const t=e.currentTarget.getBoundingClientRect();DOM.audio.currentTime=DOM.audio.duration*(e.clientX-t.left)/t.width},Player.setVolume=function(e){const t=e.currentTarget.getBoundingClientRect();DOM.audio.volume=(e.clientX-t.left)/t.width,document.getElementById("volume-fill").style.width=`${100*DOM.audio.volume}%`},Player.updateProgress=function(){if(!DOM.audio.duration)return;const{currentTime:e,duration:t}=DOM.audio;document.getElementById("progress-fill").style.width=`${e/t*100}%`,document.getElementById("current-time").textContent=Player.formatTime(e),document.getElementById("total-time").textContent=`-${Player.formatTime(t-e)}`};
    
    const UI = {
        showView(viewId) { /* ... */ },
        goBack: () => UI.showView('library'),
        showSubView(type) { /* ... */ },
        showFullPlayer() { if (app.nowPlaying.id) DOM.fullPlayer.classList.add('active'); },
        hideFullPlayer() { DOM.fullPlayer.classList.remove('active'); },
        updatePlayerUI() { /* ... */ },
        updatePlayIcons() { /* ... */ },
        updatePlayerBackground(imgSrc) { /* ... */ },
        renderAll() { this.renderLibraryView(); },
        renderLibraryView() { /* ... */ },
        renderSubView(type) { /* ... */ },
        renderPlaylistsView(container) { /* ... */ },
        renderArtistsView(container) { /* ... */ },
        renderAlbumsView(container) { /* ... */ },
        renderSongsView(container) { /* ... */ },
        createListItem: (item) => { /* ... */ },
        createPlaylistItem: (playlist) => { /* ... */ },
        createArtistListItem: (name, artwork) => { /* ... */ },
        createGridItem: (item, action, name) => { /* ... */ },
        createSongListItem: (song) => { /* ... */ },
        handleSearch: (e) => { /* ... */ },
    };
    UI.showLoading=e=>DOM.loadingOverlay.classList.toggle("active",e),UI.showView=function(e){DOM.views.forEach(t=>t.classList.toggle("active",t.id===`${e}-view`)),document.querySelectorAll(".tab-item").forEach(t=>t.classList.toggle("active",t.dataset.view===e)),DOM.subView.classList.remove("active")},UI.showSubView=function(e){DOM.views.forEach(e=>e.classList.remove("active")),DOM.subView.classList.add("active"),this.renderSubView(e)},UI.updatePlayerUI=function(){const e=document.getElementById("now-playing-bar");if(!app.nowPlaying.id)return void e.classList.remove("active");e.classList.add("active"),this.updatePlayIcons();const t=app.library.songs.find(e=>e.id===app.nowPlaying.id);t&&(["np-artwork","player-artwork"].forEach(e=>document.getElementById(e).src=t.artwork),["np-title","player-title"].forEach(e=>document.getElementById(e).textContent=t.title),document.getElementById("player-artist").textContent=t.artist,this.updatePlayerBackground(t.artwork))},UI.updatePlayIcons=function(){const e=app.nowPlaying.isPlaying;document.getElementById("np-play-icon").className=`fas ${e?"fa-pause":"fa-play"}`,document.getElementById("main-play-icon").className=`fas ${e?"fa-pause-circle":"fa-play-circle"}`},UI.updatePlayerBackground=function(e){const t=new Image;t.crossOrigin="Anonymous",t.src=e,t.onload=()=>{const e=document.createElement("canvas"),a=e.getContext("2d");a.drawImage(t,0,0,1,1);const[i,l,s]=a.getImageData(0,0,1,1).data;DOM.fullPlayer.style.backgroundImage=`linear-gradient(to bottom, rgb(${i},${l},${s}) 0%, #000 70%)`},t.onerror=()=>{DOM.fullPlayer.style.backgroundImage="linear-gradient(to bottom, #222 0%, #000 70%)"}},UI.renderLibraryView=function(){const e=document.getElementById("library-content");e.innerHTML='<div id="library-nav-list"></div><div class="section-header"><h2>Recently Added</h2></div><div class="grid" id="library-recent-grid"></div>';const t=e.querySelector("#library-nav-list");[{type:"playlists",icon:"fa-list-music",text:"Playlists"},{type:"artists",icon:"fa-microphone-alt",text:"Artists"},{type:"albums",icon:"fa-compact-disc",text:"Albums"},{type:"songs",icon:"fa-music",text:"Songs"}].forEach(e=>t.appendChild(this.createListItem(e)));const a=e.querySelector("#library-recent-grid"),i=[...app.library.songs].sort((e,t)=>t.addedAt-e.addedAt).slice(0,4);a.innerHTML="";const l=e.querySelector(".section-header");i.length>0?(l.classList.remove("hidden"),i.forEach(e=>a.appendChild(this.createGridItem(e,"playSong")))):l.classList.add("hidden")},UI.renderSubView=function(e){const t={playlists:"Playlists",artists:"Artists",albums:"Albums",songs:"Songs"};document.getElementById("sub-view-title").textContent=t[e];const a=document.getElementById("sub-view-actions");a.innerHTML="playlists"===e?'<button class="icon-btn" data-action="openCreatePlaylistModal"><i class="fas fa-plus"></i></button>':"";const i=document.getElementById("sub-view-content");i.innerHTML=`<div class="search-bar"><input type="text" class="search-input" placeholder="Search in ${t[e]}"></div>`;const l={playlists:this.renderPlaylistsView,artists:this.renderArtistsView,albums:this.renderAlbumsView,songs:this.renderSongsView};l[e]&&l[e].call(this,i)},UI.renderPlaylistsView=function(e){const t=document.createDocumentFragment(),a=document.createElement("div");a.className="playlist-item",a.innerHTML='<div class="playlist-item-artwork" id="favorite-playlist-artwork"><i class="fas fa-star"></i></div><div class="playlist-info"><div class="playlist-title">Favorite Songs</div></div><div class="list-arrow"><i class="fas fa-chevron-right"></i></div>',t.appendChild(a),app.library.playlists.forEach(e=>t.appendChild(this.createPlaylistItem(e))),0===app.library.playlists.length&&!e.querySelector(".playlist-item")&&(e.innerHTML+='<p class="empty-state">No playlists. Create one with the + button.</p>'),e.appendChild(t)},UI.renderArtistsView=function(e){const t=Object.keys(app.library.artists).sort();if(0===t.length)return void(e.innerHTML+='<p class="empty-state">No artists found.</p>');t.forEach(t=>e.appendChild(this.createArtistListItem(t,app.library.artists[t][0].artwork)))},UI.renderAlbumsView=function(e){const t=Object.keys(app.library.albums).sort();if(0===t.length)return void(e.innerHTML+='<p class="empty-state">No albums found.</p>');e.innerHTML+='<div class="action-buttons"><button class="action-btn">Play</button><button class="action-btn">Shuffle</button></div>';const a=document.createElement("div");a.className="grid",t.forEach(e=>a.appendChild(this.createGridItem(app.library.albums[e],"playAlbum",e))),e.appendChild(a)},UI.renderSongsView=function(e){const t=app.library.songs;if(0===t.length)return void(e.innerHTML+='<p class="empty-state">No songs found.</p>');e.innerHTML+='<div class="action-buttons"><button class="action-btn">Play</button><button class="action-btn">Shuffle</button></div>',t.forEach(t=>e.appendChild(this.createSongListItem(t)))},UI.createListItem=function(e){return this.createSwipeableItem({type:e.type,id:e.type,content:`<div class="list-icon"><i class="fas ${e.icon}"></i></div><div class="list-text">${e.text}</div><div class="list-arrow"><i class="fas fa-chevron-right"></i></div>`},"list-item",{delete:!1,rename:!1},"showSubView")},UI.createPlaylistItem=function(e){return this.createSwipeableItem({type:"playlist",id:e.id,content:`<div class="playlist-item-artwork"><img src="${e.artwork||"https://via.placeholder.com/54"}" /></div><div class="playlist-info"><div class="playlist-title">${e.name}</div><div class="playlist-subtitle">${e.songs.length} songs</div></div><div class="list-arrow"><i class="fas fa-chevron-right"></i></div>`},"playlist-item",{delete:!0,rename:!0})},UI.createArtistListItem=function(e,t){return this.createSwipeableItem({type:"artist",id:e,content:`<div class="list-icon"><img src="${t}" style="width:40px; height:40px; border-radius:50%; object-fit: cover;"></div><div class="list-text">${e}</div><div class="list-arrow"><i class="fas fa-chevron-right"></i></div>`},"list-item",{delete:!0,rename:!1})},UI.createGridItem=function(e,t,a){const i=document.createElement("div");return i.className="grid-item",i.dataset.action=t,"playSong"===t?(i.dataset.id=e.id,i.innerHTML=`<img src="${e.artwork}" alt="${e.album}"><div class="grid-item-title">${e.title}</div><div class="grid-item-subtitle">${e.artist}</div>`):"playAlbum"===t&&(i.dataset.album=a,i.innerHTML=`<img src="${e.artwork}" alt="${a}"><div class="grid-item-title">${a}</div><div class="grid-item-subtitle">${e.artist}</div>`),i},UI.createSongListItem=function(e){return this.createSwipeableItem({type:"song",id:e.id,content:`<img class="song-list-artwork" src="${e.artwork}"><div class="song-list-info-container"><div class="song-list-info"><span class="song-list-title">${e.title}</span><span class="song-list-artist">${e.artist}</span></div><i class="fas fa-ellipsis-h song-menu-btn"></i></div>`},"song-list-item",{delete:!0,rename:!1},"playSong")},UI.handleSearch=function(e){const t=e.target.value.toLowerCase(),a=document.getElementById("search-results-container"),i=document.getElementById("search-categories");if(a.classList.toggle("hidden",t.length<2),i.classList.toggle("hidden",t.length>=2),t.length<2)return;a.innerHTML="";const l=app.library.songs.filter(e=>e.title.toLowerCase().includes(t)||e.artist.toLowerCase().includes(t)||e.album.toLowerCase().includes(t));if(0===l.length)return void(a.innerHTML='<p class="empty-state">No Results</p>');l.forEach(e=>a.appendChild(this.createSongListItem(e)))},UI.createSwipeableItem=function(e,t,{delete:a=!1,rename:i=!1},l=""){const s=document.createElement("div");s.className="swipe-container";const n=document.createElement("div");n.className="swipe-content",n.innerHTML=e.content,n.className+=` ${t}`,l&&(n.dataset.action=l),n.dataset.type=e.type,n.dataset.id=e.id;const c=document.createElement("div");c.className="swipe-actions",i&&(c.innerHTML+`<button class="swipe-action-btn rename" data-action="renamePlaylist" data-id="${e.id}">Rename</button>`),a&&(c.innerHTML+=`<button class="swipe-action-btn delete" data-action="deleteItem" data-type="${e.type}" data-id="${e.id}">Delete</button>`),s.append(n,c);return s};

    init();
});
  </script>
</body>
</html>